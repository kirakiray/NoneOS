<template page>
  <l-m src="/packages/pui/list/list.html"></l-m>
  <l-m src="/packages/comps/local-icon/local-icon.html"></l-m>
  <l-m src="/packages/pui/progress/progress.html"></l-m>
  <style>
    :host {
      display: block;
    }

    .item-line {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
    }

    .item-line n-local-icon,
    .item-line p-progress {
      display: block;
      margin-right: 4px;
      --circle-size: 20;
      font-size: 20px;
    }
  </style>
  <o-if :value="!rootOK">
    <div
      style="
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
      "
    >
      <n-local-icon
        name="error"
        style="color: var(--md-sys-color-error); font-size: 38px"
      ></n-local-icon>
      <div style="margin-top: 8px">根证书验证失败，无法下载文件列表</div>
    </div>
  </o-if>
  <p-progress variant="determinate" type="circle"></p-progress>
  <p-list>
    <o-fill :value="tasks">
      <p-list-item>
        <div class="item-line">
          <o-if :value="$data.status === 'pending'">
            <p-progress type="circle"></p-progress>
            正在从 {{$data.name}} 下载文件列表...
          </o-if>
          <o-else-if :value="$data.status === 'success'">
            <n-local-icon
              name="succeed"
              style="color: var(--md-sys-color-success)"
            ></n-local-icon>
            从 {{$data.name}} 下载文件列表成功
          </o-else-if>
          <o-else-if :value="$data.status === 'version-failed'">
            <n-local-icon
              name="error"
              style="color: var(--md-sys-color-error)"
            ></n-local-icon>
            从 {{$data.name}} 下载文件列表版本号不匹配
          </o-else-if>
          <o-else-if :value="$data.status === 'download-failed'">
            <n-local-icon
              name="error"
              style="color: var(--md-sys-color-error)"
            ></n-local-icon>
            从 {{$data.name}} 下载文件列表失败
          </o-else-if>
          <o-else-if :value="$data.status === 'verify-failed'">
            <n-local-icon
              name="error"
              style="color: var(--md-sys-color-error)"
            ></n-local-icon>
            从 {{$data.name}} 下载文件列表的签名验证失败
          </o-else-if>
          <o-else>
            <n-local-icon
              name="error"
              style="color: var(--md-sys-color-error)"
            ></n-local-icon>
            {{$data.desc}}
          </o-else>
        </div>
      </p-list-item>
    </o-fill>
  </p-list>
  <script>
    const sources = [
      {
        name: "jsdelivr",
        hashesJSON:
          "https://cdn.jsdelivr.net/gh/kirakiray/NoneOS@main/dist/hashes.json",
        pkgPath:
          "https://cdn.jsdelivr.net/gh/kirakiray/NoneOS@main/dist/packages.zip",
      },
      {
        name: "github",
        hashesJSON: "https://kirakiray.github.io/NoneOS/dist/hashes.json",
        pkgPath: "https://kirakiray.github.io/NoneOS/dist/packages.zip",
      },
      {
        name: "Current Website",
        hashesJSON: "/dist/hashes.json",
        pkgPath: "/dist/packages.zip",
      },
    ];

    export default async ({ load }) => {
      const { verifyData } = await load("/packages/user/verify.js");
      const rootCert = await load("/packages/user/cert/root-cert.json");
      const rootOK = await verifyData(rootCert).catch(() => false);

      return {
        data: {
          currentSource: {},
          // files: [], // 所有文件列表
          tasks: [],
          currentPkgPath: "",
          rootOK,
        },
        proto: {
          async getSignList() {
            const data = await load("/package.json");
            const newestVersion = data.version;

            const reSources = [...sources];
            let finnalFiles = []; // 最终的文件列表

            let source;
            while (reSources.length) {
              source = reSources.shift();
              this.currentSource = source;

              this.tasks.push({
                name: source.name,
                status: "pending",
                progress: 0,
              });

              const target = this.tasks.slice(-1)[0];

              await new Promise((resolve) => {
                setTimeout(resolve, 200);
              });

              try {
                const result = await fetch(source.hashesJSON).then((e) =>
                  e.json()
                );

                // 验证数据签名是否正确
                const verifyResult = await verifyData(result);

                if (
                  !verifyResult ||
                  rootCert.data.publicKey !== result.data.publicKey
                ) {
                  // 数据签名验证失败，或不是根证书的公钥
                  target.status = "verify-failed";
                  continue;
                }

                const { version, files } = result.data;

                if (version !== newestVersion) {
                  target.status = "version-failed";
                  // 不是最新版，跳过
                  continue;
                }

                finnalFiles = files;

                target.status = "success";
              } catch (err) {
                target.status = "download-failed";
                continue;
              }
            }

            if (!finnalFiles.length) {
              this.tasks.push({
                status: "failed",
                desc: "无法获取有效的签名列表",
              });
              return;
            }

            this.files.push(...finnalFiles);

            this.downloadPkg();
          },
          async downloadPkg() {
            debugger;
          },
        },
        attached() {
          if (rootOK) {
            this.getSignList();
          }
        },
      };
    };
  </script>
</template>
