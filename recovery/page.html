<template page>
  <style>
    :host {
      display: block;
      height: 100%;
    }
    .main {
      display: flex;
      align-items: center;
      justify-content: center;
      flex-direction: column;
      box-sizing: border-box;
      padding: 16px;
      width: 100%;
      height: 100%;
    }

    p-button {
      margin: 0 4px;
    }
  </style>
  <l-m src="/packages/i18n/component.html"></l-m>
  <l-m src="/packages/pui/button/button.html"></l-m>
  <div class="main">
    <h1>系统恢复模式</h1>
    <p>当您无法正常访问虚拟系统时，可以在此处导出系统数据以防数据丢失。</p>
    <div>
      <p-button on:click="clickExportAllBtn()"> 导出所有数据 </p-button>
      <p-button variant="outlined" on:click="clickExportAllBtn('system')">
        只导出用户数据
      </p-button>
      <p-button variant="outlined" on:click="clickExportAllBtn('local')">
        只导出Local数据
      </p-button>
    </div>
    <p>
      完成数据导出后，您可以尝试清除所有系统数据并重启浏览器，然后重新访问虚拟系统。
    </p>
    <div>
      <p-button on:click="shadow.$('#fileInputer').ele.click()">
        导入数据
      </p-button>
      <input
        type="file"
        id="fileInputer"
        accept=".zip"
        on:change="changeFile"
        style="display: none"
      />
      <p-button on:click="clickRemoveBtn" color="error" variant="outlined">
        清除系统数据
      </p-button>
    </div>
  </div>
  <script>
    export default async ({ load }) => {
      const { exportHandle } = await load("/packages/fs/task/main.js");
      const { confirm, toast } = await load("/packages/pui/util.js");
      const { unzip } = await load("/packages/libs/zip/main.js");
      const { get } = await load("/packages/fs/main.js");

      return {
        data: {},
        proto: {
          async changeFile(e) {
            const file = e.target.files[0];
            if (!file) return;
            e.target.value = "";

            const files = await unzip(file);

            // 同时带有 system 和 local 文件夹的zip文件，才属于原来的备份文件
            if (
              files.some((e) => /^system/.test(e.path)) ||
              files.some((e) => /^local/.test(e.path))
            ) {
              await Promise.all(
                files.map(async (e) => {
                  const fileHandle = await get(e.path, { create: "file" });
                  await fileHandle.write(e.file);
                })
              );

              toast("数据已成功导入，请重启浏览器以使新的配置生效");
              return;
            }

            toast("选择的文件内容有误，请重新选择文件");
          },
          clickExportAllBtn(target) {
            if (target) {
              exportHandle(
                [target],
                `noneos-${target}-${new Date()
                  .toLocaleString()
                  .replace(/[\/ :]/g, "-")}`
              );
            } else {
              exportHandle(
                ["local", "system"],
                "noneos-backup-" +
                  new Date().toLocaleString().replace(/[\/ :]/g, "-")
              );
            }
          },
          async clickRemoveBtn() {
            const result = await confirm({
              title: "清除系统数据",
              content: "您确定要清除系统数据吗？此操作无法撤销。",
              yes: "清除",
              cancel: "取消",
            });

            if (!result) return;

            // 删除本地OPFS的数据
            const rootDirs = await navigator.storage.getDirectory();
            for await (const [name, dir] of rootDirs.entries()) {
              await rootDirs.removeEntry(name, {
                recursive: true,
              });
            }

            // 提示用户刷新页面
            toast("系统数据已清除，请刷新页面");
          },
        },
      };
    };
  </script>
</template>
