!function(){"use strict";class e{#e;#t;constructor(e){this.#e=e.parent,this.#t=e.root}get parent(){return this.#e}get root(){return this.#t||this}get path(){return this.parent?`${this.parent.path}/${this.name}`:this.name}async size(){if("file"===this.kind){return(await this.file()).size}return null}async copyTo(e,t){const[r,a]=await n(e,t,"copy",this);if("file"===this.kind){const e=await r.get(a,{create:"file"});return await e.write(await this.file()),e}const i=await r.get(a,{create:"dir"});for await(const[e,t]of this.entries())await t.copyTo(i,e);return i}async moveTo(e,t){const[r,a]=await n(e,t,"move",this);if("file"===this.kind){const e=await r.get(a,{create:"file"});return await e.write(await this.file()),await this.remove(),e}const i=await r.get(a,{create:"dir"});for await(const[e,t]of this.entries())await t.moveTo(i,e);return await this.remove(),i}toJSON(){return{name:this.name,path:this.path}}async observe(e){const t={func:e,handle:this};return r.add(t),()=>{r.delete(t)}}}const t=new BroadcastChannel("nonefs-system-handle-change");t.onmessage=e=>{a({...e.data},!0)};const r=new Set,a=({path:e,...a},n)=>{n||t.postMessage({path:e,...a}),r.forEach((t=>{e.includes(t.handle.path)&&t.func({path:e,...a})}))},n=async(e,t,r,a)=>{let n=e,i=t;if("string"==typeof e&&(i=e,n=a.parent),await a.isSame(n))return a;const s=n.path,o=a.path;if(s.startsWith(o+"/"))throw new Error(`Cannot ${r} a directory into its subdirectory`);return i=i||a.name,[n,i]},i=(()=>{const e=navigator.userAgent.toLowerCase();return e.includes("safari")&&!e.includes("chrome")})();class s extends e{#r=null;constructor(e,t={}){super(t),this.#r=e}async id(){const e=this.#r;return e.getUniqueId?await e.getUniqueId():await(async e=>{if("undefined"==typeof window){const t=await import("crypto");"string"==typeof e?e=(new TextEncoder).encode(e):e instanceof Blob&&(e=await e.arrayBuffer());const r=t.createHash("sha256");return r.update(Buffer.from(e)),r.digest("hex")}{"string"==typeof e?e=(new TextEncoder).encode(e):e instanceof Blob&&(e=await e.arrayBuffer());const t=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(t)).map((e=>e.toString(16).padStart(2,"0"))).join("")}})(this.path)}get _handle(){return this.#r}get name(){return this.#r.name}async isSame(e){return this.#r.isSameEntry(e._handle)}async remove(){const e=this.parent;await e.#r.removeEntry(this.#r.name,{recursive:!0}),a({type:"remove",path:this.path})}}class o{async file(e){return this.read({...e,type:"file"})}async text(e){return this.read({...e,type:"text"})}async buffer(e){return this.read({...e,type:"buffer"})}async base64(e){const t=await this.file(e);return new Promise(((e,r)=>{const a=new FileReader;a.onload=()=>{e(a.result)},a.onerror=e=>{r(e)},a.readAsDataURL(t)}))}async lastModified(){return(await this.file()).lastModified}get kind(){return"file"}}const c=async e=>{const t=Object.getOwnPropertyDescriptors(o.prototype);delete t.constructor,Object.defineProperties(e.prototype,t)};class l extends s{constructor(...e){super(...e)}async read(e={}){let t=await this._handle.getFile();switch((e.start||e.end)&&(t=t.slice(e.start,e.end)),e.type){case"file":return t;case"text":default:return t.text();case"buffer":return t.arrayBuffer()}}async write(e,t={}){const r=this._handle,n=await r.createWritable();await n.write(e),await n.close(),a({path:this.path,type:"write",data:e,remark:t.remark})}}c(l);class d{async _getByMultiPath(e,t){const{create:r}=t||{},a=e.split("/");let n=this;for(;a.length;){const e=a.shift();let t;r&&(t=a.length?"dir":r),n=await n.get(e,{create:t})}return n}async*entries(){for await(let e of this.keys()){const t=await this.get(e);yield[e,t]}}async*values(){for await(let[e,t]of this.entries())yield t}async some(e){for await(let[t,r]of this.entries())if(await e(r,t,this))break}async forEach(e){for await(let[t,r]of this.entries())await e(r,t,this)}async flat(){const e=[];for await(const[t,r]of this.entries())if("dir"!==r.kind)e.push(r);else{const t=await r.flat();e.push(...t)}return e}get kind(){return"dir"}}const u=async e=>{const t=Object.getOwnPropertyDescriptors(d.prototype);delete t.constructor,Object.defineProperties(e.prototype,t)};class f extends s{constructor(...e){super(...e)}async get(e,t){const{create:r}=t||{};if(e.includes("/"))return await this._getByMultiPath(e,t);let a=await this._handle.getFileHandle(e).catch((()=>null));if(a||(a=await this._handle.getDirectoryHandle(e).catch((()=>null))),!r&&!a)return null;if(a){if("file"===r&&"file"!==a.kind)throw new Error(`${e} is not a file`);if("dir"===r&&"directory"!==a.kind)throw new Error(`${e} is not a directory`)}else{let r="getDirectoryHandle";"file"===t.create&&(r="getFileHandle"),a=await this._handle[r](e,{create:!0})}return"file"===a.kind?new l(a,{parent:this,root:this.root||this}):"directory"===a.kind?new f(a,{parent:this,root:this.root||this}):null}async length(){let e=0;for await(const[t,r]of this._handle.entries())e++;return e}async*keys(){for await(let e of this._handle.keys())yield e}}u(f);let h=null;const p=async()=>(h||(h=new Promise(((e,t)=>{const r=indexedDB.open("noneos_fs_db",1);r.onupgradeneeded=function(e){const t=e.target.result.createObjectStore("files",{keyPath:"id"});t.createIndex("parent","parent",{unique:!1}),t.createIndex("name","name",{unique:!1}),t.createIndex("parentAndName",["parent","name"],{unique:!0})},r.onsuccess=function(t){const r=t.target.result;r.onclose=function(){h=null},e(r)},r.onerror=function(e){t(e.target.error),h=null}}))),h),w=async({indexName:e,index:t,method:r="get"})=>{let a=(await p()).transaction(["files"],"readonly").objectStore("files");return e&&(a=a.index(e)),new Promise(((e,n)=>{a=a[r](t),a.onsuccess=function(t){e(t.target.result)},a.onerror=function(e){n(e.target.error)}}))},y=async({puts:e,deletes:t})=>{const r=(await p()).transaction(["files"],"readwrite"),a=r.objectStore("files");return new Promise(((n,i)=>{const s=[];r.oncomplete=function(){n(s)},r.onerror=function(e){i(e.target.error)},e&&e.forEach((e=>{a.put(e)})),t&&t.forEach((e=>{a.delete(e)}))}))};function m(e=10){const t=new Uint8Array(e);return crypto.getRandomValues(t),Array.from(t,(e=>("0"+e.toString(32)).slice(-2))).join("")}class g extends e{#a;#n;constructor({name:e,dbId:t,root:r,parent:a}){super({root:r,parent:a}),this.#a=e,this.#n=t}async id(){return this.#n}get _dbid(){return this.#n}get name(){return this.#a}isSame(e){return this.#n===e._dbid}async remove(){if("dir"===this.kind)for await(let e of this.values())await e.remove();await y({deletes:[this.#n]}),a({type:"remove",path:this.path})}}class x extends g{constructor(...e){super(...e)}async read(e={}){const t=await w({index:this._dbid});let r=t.file;if(!r)return null;switch(i&&(r=t.fileInfo?new File([r],this.name,t.fileInfo):new File([r],this.name)),(e.start||e.end)&&(r=r.slice(e.start,e.end)),e.type){case"file":return r;case"text":default:return r.text();case"buffer":return r.arrayBuffer()}}async write(e,t={}){let r=e;if(i){if("string"==typeof e?r=(new TextEncoder).encode(e):e instanceof Blob&&(r=await e.arrayBuffer()),!(r instanceof Uint8Array||r instanceof ArrayBuffer))throw new Error("data must be file, string, Uint8Array or ArrayBuffer")}else if(("string"==typeof e||e instanceof ArrayBuffer||e instanceof Uint8Array)&&(r=new File([e],this.name,{type:"text/plain"})),!(r instanceof File))throw new Error("data must be file, string, Uint8Array or ArrayBuffer");const n=await w({index:this._dbid});i&&e instanceof File&&(n.fileInfo={type:e.type,lastModified:e.lastModified}),n.file=r,await y({puts:[n]}),a({path:this.path,type:"write",data:e,remark:t.remark})}}c(x);class b extends g{constructor(...e){super(...e)}async get(e,t={}){if(e.includes("/"))return await this._getByMultiPath(e,t);let r=await w({indexName:"parentAndName",index:[this._dbid,e]});return r||t.create?(r||"file"!==t.create&&"dir"!==t.create||(r={id:m(),name:e,parent:this._dbid,type:t.create},await y({puts:[r]})),"file"===r.type?new x({name:r.name,dbId:r.id,parent:this,root:this.root}):"dir"===r.type?new b({name:r.name,dbId:r.id,parent:this,root:this.root}):null):null}async length(){return await w({indexName:"parent",index:this._dbid,method:"count"})}async*keys(){let e=await w({indexName:"parent",index:this._dbid,method:"getAll"});for(const t of e)yield t.name}}u(b);const v=async(e,t)=>i?(async(e,t)=>{const r=e.split("/");if(0===r.length)throw new Error("路径不能为空");const a=r[0],n=await w({indexName:"parentAndName",index:["root",a]});if(!n)return null;const i=new b({name:n.name,dbId:n.id});return 1===r.length?i:await i.get(r.slice(1).join("/"),t)})(e,t):(async(e,t)=>{const r=await navigator.storage.getDirectory(),a=e.split("/").filter(Boolean);if(0===a.length)throw new Error("路径不能为空");const n=a[0];try{const e=await r.getDirectoryHandle(n),i=new f(e);if(1===a.length)return i;const s=a.slice(1).join("/");return await i.get(s,t)}catch(e){if("NotFoundError"===e.name)throw new Error(`根目录 "${n}" 不存在，请先使用 init("${n}") 初始化`,{cause:e});throw e}})(e,t),k=e=>{switch(e){case"html":case"htm":case"txt":case"md":return"text/plain; charset=utf-8";case"js":case"mjs":return"application/javascript; charset=utf-8";case"json":return"application/json; charset=utf-8";case"css":return"text/css; charset=utf-8";case"xml":return"application/xml; charset=utf-8";case"svg":return"image/svg+xml; charset=utf-8";case"csv":return"text/csv; charset=utf-8";case"ics":return"text/calendar; charset=utf-8";case"pdf":return"application/pdf; charset=utf-8";case"doc":case"docx":return"application/msword; charset=utf-8";case"xls":case"xlsx":return"application/vnd.ms-excel; charset=utf-8";case"ppt":case"pptx":return"application/vnd.ms-powerpoint; charset=utf-8";case"zip":return"application/zip; charset=utf-8";case"gz":return"application/gzip; charset=utf-8";case"tar":return"application/x-tar; charset=utf-8";case"jpg":case"jpeg":return"image/jpeg";case"png":return"image/png";case"gif":return"image/gif";case"bmp":case"bmp":return"image/bmp";case"ico":return"image/x-icon";case"webp":return"image/webp";case"mp3":return"audio/mpeg";case"wav":return"audio/wav";case"mp4":case"m4v":return"video/mp4";case"mov":return"video/quicktime";case"avi":return"video/x-msvideo";default:return"application/octet-stream"}};self.addEventListener("fetch",(e=>{const{request:t}=e,{pathname:r,origin:a,searchParams:n}=new URL(t.url);location.origin===a&&/^\/\$/.test(r)&&(e=>{const{request:t}=e,{pathname:r,origin:a,searchParams:n}=new URL(t.url),i=r.split("/"),s=[i[1].replace("$",""),...i.slice(2)].join("/");e.respondWith((async()=>{try{const e=await v(s),t=r.split(".").pop(),a={};return a["Content-Type"]=k(t),new Response(await e.file(),{status:200,headers:a})}catch(e){return new Response(e.stack||e.toString(),{status:400})}})())})(e)})),self.addEventListener("install",(()=>{self.skipWaiting(),console.log("NoneOS installation successful")})),self.addEventListener("activate",(()=>{self.clients.claim(),console.log("NoneOS server activation successful")}))}();
