!function(){"use strict";const e=async e=>{const t=await navigator.storage.getDirectory(),a=e.split("/");let s="",n=t;for(;a.length>1;){const e=a.shift();s+=`${e}/`;const t=await n.getDirectoryHandle(e).catch((()=>null));if(!t)throw new Error(`目录 ${s} 不存在`);n=t}const r=await n.getFileHandle(a[0]).catch((()=>null));if(!r)throw new Error(`文件 ${e} 不存在`);return r},t=e=>{switch(e){case"html":case"htm":case"txt":case"md":return"text/plain; charset=utf-8";case"js":case"mjs":return"application/javascript; charset=utf-8";case"json":return"application/json; charset=utf-8";case"css":return"text/css; charset=utf-8";case"xml":return"application/xml; charset=utf-8";case"svg":return"image/svg+xml; charset=utf-8";case"csv":return"text/csv; charset=utf-8";case"ics":return"text/calendar; charset=utf-8";case"pdf":return"application/pdf; charset=utf-8";case"doc":case"docx":return"application/msword; charset=utf-8";case"xls":case"xlsx":return"application/vnd.ms-excel; charset=utf-8";case"ppt":case"pptx":return"application/vnd.ms-powerpoint; charset=utf-8";case"zip":return"application/zip; charset=utf-8";case"gz":return"application/gzip; charset=utf-8";case"tar":return"application/x-tar; charset=utf-8";case"jpg":case"jpeg":return"image/jpeg";case"png":return"image/png";case"gif":return"image/gif";case"bmp":case"bmp":return"image/bmp";case"ico":return"image/x-icon";case"webp":return"image/webp";case"mp3":return"audio/mpeg";case"wav":return"audio/wav";case"mp4":case"m4v":return"video/mp4";case"mov":return"video/quicktime";case"avi":return"video/x-msvideo";default:return"application/octet-stream"}},a={packageUseOnline:!1,debugMode:!1};const s=async t=>{let s;t=t.replace(/^\//,"");try{if(a.packageUseOnline||a.debugMode)throw new Error("");s=await e(t),s=await s.getFile()}catch(e){s=await fetch(t).then((e=>e.blob()))}return s},n=async e=>{const{request:t}=e,{pathname:a,origin:n,searchParams:r}=new URL(t.url);let c="icon.svg";e.respondWith((async()=>{let e="App";try{const t=await s(`${a}app.json`);let n=await t.text();n=JSON.parse(n),c=n.icon||c,e=n.name||a.split("/").filter((e=>/\.napp$/.test(e))).slice(-1)[0].replace(/\.napp$/,"")}catch(e){}return new Response(`<!DOCTYPE html>\n<html lang="en">\n  <head>\n    <meta charset="UTF-8" />\n    <meta name="viewport" content="width=device-width, initial-scale=1.0" />\n    <meta name="full-screen" content="yes">\n    <meta name="apple-touch-fullscreen" content="yes">\n    <title>${e}</title>\n    <link rel="icon" href="./${c}">\n    <link rel="stylesheet" href="/packages/others/colors.css" pui-colors />\n    <script src="/packages/libs/ofa/ofa.js#debug"><\/script>\n    <script src="/packages/libs/ofa/router.min.js"><\/script>\n    <script src="/packages/pui/public/init.js" type="module"><\/script>\n    <script src="/packages/none-os/init.js" type="module"><\/script>\n    <style>\n      body{\n        background-color: var(--md-sys-color-surface);\n        color: var(--md-sys-color-on-surface);\n      }\n\n      body {\n        font: 16px / 24px ui-sans-serif, -apple-system, "system-ui",\n          "Segoe UI Variable Display", "Segoe UI", Helvetica, "PingFang SC",\n          "Microsoft YaHei", Helvetica, "Apple Color Emoji", Arial, sans-serif,\n          "Segoe UI Emoji", "Segoe UI Symbol";\n      }\n    </style>\n  </head>\n  <body>\n    <o-router fix-body>\n      <o-app src="./app-config.js"></o-app>\n    </o-router>\n  </body>\n</html>`,{status:200,headers:{"content-type":"text/html; charset=utf-8"}})})())};let r;self.addEventListener("fetch",(c=>{const{request:o}=c,{pathname:i,origin:p,searchParams:l}=new URL(o.url);a.debugMode&&/^\/\$local/.test(i)?c.respondWith((async()=>{const a=await e(i.replace(/^\/\$local/,"local")),s=i.split(".").pop();if(a)return"html"===s?new Response(await a.getFile(),{headers:{"Content-Type":"text/html;charset=utf-8"}}):new Response(await a.getFile(),{headers:{"Content-Type":t(s)}})})()):(location.origin===p&&(/^\/\$/.test(i)?(a=>{const{request:s}=a;let{pathname:n,origin:r,searchParams:c}=new URL(s.url);n=decodeURIComponent(n);const o=n.split("/"),i=[o[1].replace("$",""),...o.slice(2)].join("/");a.respondWith((async()=>{try{const a=await e(i),s=n.split(".").pop();return new Response(await a.getFile(),{status:200,headers:{"Content-Type":t(s)}})}catch(e){return new Response(e.stack||e.toString(),{status:400})}})())})(c):/^\/packages/.test(i)&&async function(e){const{request:r}=e,{pathname:c,origin:o,searchParams:i}=new URL(r.url);/\.napp\/$/.test(c)?n(e):a.packageUseOnline||a.debugMode||e.respondWith((async()=>{const e=await s(c),a=c.split(".").pop();return new Response(e,{status:200,headers:{"Content-Type":t(a)}})})())}(c)),"/"!==i||a.packageUseOnline||a.debugMode||c.respondWith((async()=>{try{const t=await e("packages/index.html");if(t)return new Response(await t.getFile(),{headers:{"Content-Type":"text/html;charset=utf-8"}})}catch(e){console.error(e)}return fetch(o)})()),"/package-use-online"===i?(clearTimeout(r),a.packageUseOnline=!0,c.respondWith(new Response("package use online")),r=setTimeout((()=>{a.packageUseOnline=!1}),3e3)):"/package-use-local"===i?(clearTimeout(r),a.packageUseOnline=!1,c.respondWith(new Response("package use local"))):"/open-debug-mode"===i?(a.debugMode=!0,c.respondWith(new Response("debug mode open"))):"/close-debug-mode"===i?(a.debugMode=!1,c.respondWith(new Response("debug mode close"))):"/get-configs"===i&&c.respondWith(new Response(JSON.stringify(a))))})),self.addEventListener("install",(()=>{self.skipWaiting(),console.log("NoneOS installation successful")})),self.addEventListener("activate",(()=>{self.clients.claim(),console.log("NoneOS server activation successful")}))}();
