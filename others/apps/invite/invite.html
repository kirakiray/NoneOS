<template page>
  <l-m src="/packages/libs/jdenticon/jdent-icon.html"></l-m>
  <l-m src="/packages/pui/button/button.html"></l-m>
  <l-m src="/packages/comps/local-icon/local-icon.html"></l-m>
  <style>
    :host {
      display: block;
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen,
        Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
    }

    .container {
      margin: 0 auto;
      padding: 24px;
      border-radius: 12px;
    }

    h1 {
      font-size: 24px;
      font-weight: 600;
      text-align: center;
      margin: 0 0 24px 0;
      color: var(--md-sys-color-on-surface, #333);
    }

    .user-card {
      display: flex;
      align-items: center;
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 24px;
      transition: box-shadow 0.2s ease;
    }

    .user-card:hover {
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .avatar-container {
      flex-shrink: 0;
    }

    jdent-icon {
      width: 72px;
      height: 72px;
      border-radius: 50%;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
    }

    .info {
      margin-left: 16px;
      flex: 1;
    }

    .info > div {
      padding: 4px 0;
    }

    .label {
      font-weight: 500;
      color: var(--md-sys-color-on-surface-variant, #666);
      display: inline-block;
      width: 70px;
      margin-right: 8px;
    }

    .value {
      color: var(--md-sys-color-on-surface, #333);
      font-weight: 400;
    }

    .confirm-text {
      font-size: 16px;
      line-height: 1.6;
      color: var(--md-sys-color-on-surface, #333);
      margin-bottom: 20px;
      text-align: center;
    }

    .warning {
      padding: 16px;
      background: #fff8e1;
      border-left: 4px solid #ffc107;
      border-radius: 4px;
      margin: 24px 0;
      font-size: 14px;
      line-height: 1.5;
      color: #333;
    }

    .warning-title {
      font-weight: 600;
      margin-bottom: 8px;
      color: #e65100;
    }

    .button-container {
      margin-top: 16px;
      text-align: center;
    }
  </style>
  <div class="container">
    <h1>添加设备</h1>
    <div class="user-card">
      <div class="avatar-container">
        <jdent-icon
          :value="targetUserId"
          style="width: 72px; height: 72px"
        ></jdent-icon>
      </div>
      <div class="info">
        <div>
          <span class="label">用户名:</span>
          <span class="value">{{userName}}</span>
        </div>
        <div>
          <span class="label">UserID:</span>
          <span class="value" style="word-break: break-word"
            >{{targetUserId}}</span
          >
        </div>
      </div>
    </div>

    <o-if :value="!isAuthorized">
      <p class="confirm-text">
        确认添加 <strong>{{userName}}</strong> 作为你的设备吗？
      </p>

      <div class="warning">
        <div class="warning-title">重要提醒</div>
        <div>
          此操作不可逆，一旦授予对方权限，对方将能够访问该设备的数据，请仔细确认后再操作。
        </div>
      </div>
    </o-if>

    <div class="button-container">
      <p-button on:click="confirmAdd" attr:disabled="isAuthorized || clicked">
        <o-if :value="isAuthorized"> 已授权 </o-if>
        <o-else-if :value="clicked">
          等待对方确认
          <n-local-icon></n-local-icon>
        </o-else-if>
        <o-else> 确认添加设备 </o-else>
      </p-button>
    </div>
  </div>
  <script>
    export default async ({ load }) => {
      const { verifyDeviceData } = await load(
        "/packages/apps/new-link-me.napp/util/verify-device-data.js"
      );
      const { createUser } = await load("/packages/new-user/main.js");
      const localUser = await createUser();
      const certManager = await localUser.certManager();

      // 获取连接参数
      const params = new URLSearchParams(location.search);
      const targetUserId = params.get("userId"); // 对面设备的userId
      const inviteCode = params.get("inviteCode"); // 邀请ID

      return {
        data: {
          targetUserId,
          userName: "",
          _remoteUser: null,
          clicked: false,
          isAuthorized: false, // 是否已经授权
        },
        proto: {
          async refreshState() {
            // 检查是否已经存在我授权给对方的设备证书
            const myCertIssuedToRemote = await certManager.get({
              role: "device",
              issuedTo: targetUserId,
            });

            // 查看对方是否有授权给我的设备证书
            const remoteCertIssuedToMe = await certManager.query({
              role: "device",
              issuedTo: localUser.userId,
              issuedBy: targetUserId,
            });

            if (
              myCertIssuedToRemote.length > 0 ||
              remoteCertIssuedToMe.length > 0
            ) {
              // 已经存在授权关系
              this.isAuthorized = true;
            }
          },
          async sendInvite() {
            const remoteUser = (this._remoteUser = await localUser.connectUser({
              userId: targetUserId,
            }));

            // 获取对方的用户卡片
            const info = await remoteUser.info();
            this.userName = info.name;
          },
          async confirmAdd() {
            const remoteUser = this._remoteUser;
            this.clicked = true;

            // 给对方签发设备证书
            const cert = await certManager.issue({
              role: "device",
              userId: targetUserId,
            });

            // 保存授权给对方的设备证书
            this._authorizedDeviceCert = cert;

            const signedData = await localUser.createCard({
              goal: "pair-confirm",
              inviteCode,
              cert,
            });

            await remoteUser.post(signedData);
          },
        },
        attached() {
          this.sendInvite();
          this.refreshState();

          this._off = localUser.bind("receive-data", async (event) => {
            const { data } = event.detail;

            if (data && data.goal === "response-pair-confirm") {
              try {
                // 验证设备数据
                await verifyDeviceData(data, localUser);
              } catch (error) {
                // TODO: 验证失败，提示用户可能有攻击
                debugger;
                return;
              }

              // 保存双方的设备证书
              await certManager.save(data.cert);
              await certManager.save(this._authorizedDeviceCert);
            }
          });
        },
        detached() {
          this._off && this._off();
        },
      };
    };
  </script>
</template>
