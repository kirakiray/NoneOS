<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Agent Data Test</title>
    <script src="/packages/libs/ofa/ofa.js" type="module"></script>
  </head>
  <body>
    <script src="/sw/register.js" type="module"></script>
    <script type="module">
      import { runTest } from "/tests/runTest.js";
      import { getServers, getUserStore } from "/packages/user/main.js";

      // 初始化测试环境
      async function setupTestEnvironment() {
        // 初始化两个用户
        const user1 = await getUserStore("user1");
        const user2 = await getUserStore("user2");

        // 设置用户名，包含浏览器信息以便识别
        const browserInfo = `${
          navigator.userAgent.match(
            /(?:Chrome|Firefox|Safari|Edge|OPR)\/[\d.]+/
          )[0]
        }`;
        user1.userName = `TestUser1-${browserInfo}`;
        user2.userName = `TestUser2-${browserInfo}`;

        // 获取用户握手服务器
        const user1Server = await getServers("user1");
        const user2Server = await getServers("user2");

        // 等待服务器连接
        await user1Server.watchUntil(
          () =>
            user1Server.length && user1Server[0].connectionState === "connected"
        );
        await user2Server.watchUntil(
          () =>
            user2Server.length && user2Server[0].connectionState === "connected"
        );

        await new Promise((resolve) => setTimeout(resolve, 100));

        return { user1, user2, user1Server, user2Server };
      }

      // 测试用户间数据传输 - 发送成功验证
      await runTest("Agent Data Send Success Test", async () => {
        try {
          const { user1, user2, user1Server, user2Server } =
            await setupTestEnvironment();

          // 设置用户2的数据接收处理器
          let receivedData = null;
          user2Server[0]._onagentdata = (fromUserId, data) => {
            receivedData = { fromUserId, data };
          };

          // 生成测试数据
          const testData = {
            val: Math.random(),
            timestamp: Date.now(),
          };

          // 用户1发送数据到用户2
          const sendResult = await user1Server[0].post({
            type: "agent-data",
            friendId: user2.userId,
            data: testData,
          });

          // 等待数据接收
          await new Promise((resolve) => setTimeout(resolve, 100));

          return {
            assert: sendResult.success,
            content: {
              message: "发送成功验证测试完成",
              sendResult,
            },
          };
        } catch (error) {
          console.error("Test failed:", error);
          return {
            assert: false,
            content: `测试失败: ${error.message}`,
          };
        }
      });

      // 测试用户间数据传输 - 数据接收验证
      await runTest("Agent Data Receive Test", async () => {
        try {
          const { user1, user2, user1Server, user2Server } =
            await setupTestEnvironment();

          // 设置用户2的数据接收处理器
          let receivedData = null;
          user2Server[0]._onagentdata = (fromUserId, data) => {
            receivedData = { fromUserId, data };
          };

          // 生成测试数据
          const testData = {
            val: Math.random(),
            timestamp: Date.now(),
          };

          // 用户1发送数据到用户2
          await user1Server[0].post({
            type: "agent-data",
            friendId: user2.userId,
            data: testData,
          });

          // 等待数据接收
          await new Promise((resolve) => setTimeout(resolve, 100));

          return {
            assert: receivedData !== null,
            content: {
              message: "数据接收验证测试完成",
              receivedData,
            },
          };
        } catch (error) {
          console.error("Test failed:", error);
          return {
            assert: false,
            content: `测试失败: ${error.message}`,
          };
        }
      });

      // 测试用户间数据传输 - 发送者ID验证
      await runTest("Agent Data Sender ID Test", async () => {
        try {
          const { user1, user2, user1Server, user2Server } =
            await setupTestEnvironment();

          // 设置用户2的数据接收处理器
          let receivedData = null;
          user2Server[0]._onagentdata = (fromUserId, data) => {
            receivedData = { fromUserId, data };
          };

          // 生成测试数据
          const testData = {
            val: Math.random(),
            timestamp: Date.now(),
          };

          // 用户1发送数据到用户2
          await user1Server[0].post({
            type: "agent-data",
            friendId: user2.userId,
            data: testData,
          });

          // 等待数据接收
          await new Promise((resolve) => setTimeout(resolve, 100));

          return {
            assert: receivedData && receivedData.fromUserId === user1.userId,
            content: {
              message: "发送者ID验证测试完成",
              expectedId: user1.userId,
              actualId: receivedData ? receivedData.fromUserId : null,
            },
          };
        } catch (error) {
          console.error("Test failed:", error);
          return {
            assert: false,
            content: `测试失败: ${error.message}`,
          };
        }
      });

      // 测试用户间数据传输 - 数据内容验证
      await runTest("Agent Data Content Test", async () => {
        try {
          const { user1, user2, user1Server, user2Server } =
            await setupTestEnvironment();

          // 设置用户2的数据接收处理器
          let receivedData = null;
          user2Server[0]._onagentdata = (fromUserId, data) => {
            receivedData = { fromUserId, data };
          };

          // 生成测试数据
          const testData = {
            val: Math.random(),
            timestamp: Date.now(),
          };

          // 用户1发送数据到用户2
          await user1Server[0].post({
            type: "agent-data",
            friendId: user2.userId,
            data: testData,
          });

          // 等待数据接收
          await new Promise((resolve) => setTimeout(resolve, 100));

          return {
            assert: receivedData && receivedData.data.val === testData.val,
            content: {
              message: "数据内容验证测试完成",
              sentData: testData,
              receivedData,
            },
          };
        } catch (error) {
          console.error("Test failed:", error);
          return {
            assert: false,
            content: `测试失败: ${error.message}`,
          };
        }
      });

      // 测试向不存在的用户发送数据
      await runTest("Invalid User Agent Data Test", async () => {
        try {
          const user1Server = await getServers("user1");

          await user1Server[0].watchUntil(
            () => user1Server[0].connectionState === "connected"
          );

          const nonExistentUserId = Math.random().toString(16).slice(2);

          const sendResult = await user1Server[0]
            .post({
              type: "agent-data",
              friendId: nonExistentUserId,
              data: { test: "data" },
            })
            .catch((error) => ({
              success: false,
              error: error.message,
            }));

          return {
            assert: !sendResult.success,
            content: {
              message: "成功捕获发送到不存在用户的错误",
              nonExistentUserId,
              error: sendResult.error,
            },
          };
        } catch (error) {
          console.error("Test failed:", error);
          return {
            assert: false,
            content: `测试失败: ${error.message}`,
          };
        }
      });

      // 测试用户间数据传输 - 时间戳验证
      await runTest("Agent Data Timestamp Test", async () => {
        try {
          const { user1, user2, user1Server, user2Server } =
            await setupTestEnvironment();

          let agentdatatime;
          // 设置用户2的数据接收处理器
          let receivedData = null;
          user2Server[0]._onagentdata = async (fromUserId, data) => {
            receivedData = { fromUserId, data };
            agentdatatime = Date.now();
          };

          // 生成测试数据
          const testData = {
            val: Math.random(),
            timestamp: Date.now(),
          };

          // 用户1发送数据到用户2
          const sendResult = await user1Server[0].post({
            type: "agent-data",
            friendId: user2.userId,
            data: testData,
          });

          const resultTime = Date.now();

          // 等待数据接收
          await new Promise((resolve) => setTimeout(resolve, 100));

          return {
            assert: resultTime >= agentdatatime,
            content: {
              message: "时间戳验证测试完成",
              agentdatatime,
              resultTime,
              timeDifference: resultTime - agentdatatime,
            },
          };
        } catch (error) {
          console.error("Test failed:", error);
          return {
            assert: false,
            content: `测试失败: ${error.message}`,
          };
        }
      });

      const endMessage = document.createElement("h5");
      endMessage.setAttribute("data-testid", "all-test-completed");
      endMessage.textContent = "All tests completed";
      document.body.appendChild(endMessage);
    </script>
  </body>
</html>
