<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Generate KeyPair Test</title>
    <script src="/packages/libs/ofa/ofa.js" type="module"></script>
  </head>
  <body>
    <script src="/sw/register.js" type="module"></script>
    <script type="module">
      import { runTest } from "/tests/runTest.js";
      import {
        generateKeyPair,
        importPrivateKey,
        importPublicKey,
      } from "/packages/user/cert.js";

      // 测试密钥对生成
      await runTest("Generate KeyPair Test", async () => {
        try {
          const keyPair = await generateKeyPair();

          // 验证生成的密钥对是否符合预期
          const hasPublicKey = !!keyPair.publicKey;
          const hasPrivateKey = !!keyPair.privateKey;

          console.log("keyPair: ", keyPair);

          // 验证密钥格式是否为 base64
          const isBase64 = (str) => {
            try {
              return btoa(atob(str)) === str;
            } catch (err) {
              return false;
            }
          };

          const isPublicKeyBase64 = isBase64(keyPair.publicKey);
          const isPrivateKeyBase64 = isBase64(keyPair.privateKey);

          return {
            assert:
              hasPublicKey &&
              hasPrivateKey &&
              isPublicKeyBase64 &&
              isPrivateKeyBase64,
            content: {
              message: "ECDSA 密钥对生成成功",
              publicKeyLength: keyPair.publicKey.length,
              privateKeyLength: keyPair.privateKey.length,
              algorithm: "ECDSA P-256",
            },
          };
        } catch (error) {
          console.error("Test failed:", error);
          return {
            assert: false,
            content: `测试失败: ${error.message}`,
          };
        }
      });

      // 测试签名和验证
      await runTest("Sign and Verify Test", async () => {
        try {
          const keyPair = await generateKeyPair();

          // 导入密钥
          const privateKey = await importPrivateKey(keyPair.privateKey);
          const publicKey = await importPublicKey(keyPair.publicKey);

          // 创建测试数据
          const message = "Hello, NoneOS!";
          const encoder = new TextEncoder();
          const data = encoder.encode(message);

          // 使用私钥签名
          const signature = await window.crypto.subtle.sign(
            {
              name: "ECDSA",
              hash: { name: "SHA-256" },
            },
            privateKey,
            data
          );

          // 使用公钥验证签名
          const isValid = await window.crypto.subtle.verify(
            {
              name: "ECDSA",
              hash: { name: "SHA-256" },
            },
            publicKey,
            signature,
            data
          );

          return {
            assert: isValid,
            content: {
              message: "签名验证成功",
              originalMessage: message,
              signatureLength: signature.byteLength,
            },
          };
        } catch (error) {
          console.error("Test failed:", error);
          return {
            assert: false,
            content: `测试失败: ${error.message}`,
          };
        }
      });
    </script>
  </body>
</html>
