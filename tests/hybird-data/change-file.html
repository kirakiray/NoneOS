<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Change File Test</title>
    <script src="/packages/libs/ofa/ofa.js" type="module"></script>
  </head>
  <body>
    <script src="/sw/register.js" type="module"></script>
    <script type="module">
      import { init, get } from "/packages/fs/main.js";
      import { runTest } from "/tests/runTest.js";
      import { createData } from "/packages/hybird-data/main.js";

      // 初始化测试目录
      const testDirectory = await init("test-dir10");

      // 测试父目录是否相同
      await runTest("sub data can save", async () => {
        const testData2 = await testDirectory.get("test-data-2", {
          create: "dir",
        });
        const data2 = await createData(testData2);

        window.testData2 = testData2;
        window.data2 = data2;
        await data2.ready();

        if (!data2.sub) {
          data2.sub = {
            val: "I am sub",
          };
        }

        await data2.sub.ready();

        // data2.watch((e) => {
        //   console.log("watch:", e);
        // });

        await new Promise((res) => setTimeout(res, 500));

        const targetFile = await get(
          `test-dir10/test-data-2/${data2.sub._dataid}/_d`
        );

        const oldVal = data2.sub.val;

        console.log("data: ", data2.sub.val);

        // 修改内容后重新写会
        const fileText = await targetFile.text();
        const fileObj = JSON.parse(fileText);
        fileObj.val = "change val: " + Date.now();
        await targetFile.write(JSON.stringify(fileObj));

        // 等待更新
        await new Promise((res) => setTimeout(res, 500));

        console.log("data2: ", data2.sub.val);

        return {
          assert: oldVal !== data2.sub.val && data2.sub.val === fileObj.val,
          content: "auto update data ok",
        };
      });
    </script>
  </body>
</html>
