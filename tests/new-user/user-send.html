<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <script type="module">
      import { createUser } from "/packages/new-user/main.js";

      // 创建两个用户
      const user1 = await createUser({ user: "test-user1" });
      const user2 = await createUser({ user: "test-user2" });

      console.log("user1", user1);
      console.log("user2", user2);

      const serverUrl = "ws://localhost:18290";
      // 两者都连上同一个服务器
      const serverClient1 = await user1.connectServer(serverUrl);
      const serverClient2 = await user2.connectServer(serverUrl);

      console.log("serverClient1: ", serverClient1);
      console.log("serverClient2: ", serverClient2);

      setTimeout(async () => {
        // 查找对方是否在线
        const isUser2Online = await serverClient1.isUserOnline(user2.userId);
        console.log("user2是否在线:", isUser2Online); // 连接了同样的服务器，所以能够联通 :true

        // 查找对方是否在线
        const isUser1Online = await serverClient2.isUserOnline(user1.userId);
        console.log("user1是否在线:", isUser1Online); // 连接了同样的服务器，所以能够联通 :true

        serverClient2.onData = (fromUserId, data) => {
          console.log("user2收到数据:", fromUserId, data);
          console.log("是否从user1获取的数据:", fromUserId === user1.userId); // true
          console.log("user2收到的数据:", data); // { val: "hello user2" }
        };

        // 发送数据给对方
        const data1 = {
          val: "hello user2",
        };
        serverClient1.sendData({ userId: user2.userId }, data1);
      }, 300);
    </script>
  </body>
</html>
