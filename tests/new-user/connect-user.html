<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <script type="module">
      import { createUser } from "/packages/new-user/main.js";

      // 创建两个用户
      const user1 = await createUser({ user: "test-user1" });
      const user2 = await createUser({ user: "test-user2" });

      console.log("user1", user1);
      console.log("user2", user2);

      // 保证user2连上服务器
      const servers = await user2.servers();
      await user2.connectServer(servers[0].url);

      // user2监听获取数据的事件
      const cancel1 = user2.bind("receive-data", (e) => {
        const { fromUserId, fromUserSessionId, data, server, channel } =
          e.detail;

        console.log(
          "通过 RTC 转发，server 字段应不存在，当前 server 是否为 undefined:",
          server === undefined
        );

        console.log(
          "user2收到数据:",
          data,
          fromUserId,
          fromUserSessionId,
          channel
        );

        cancel1();
      });

      // 直接连接 user2
      // let remoteUser2;
      window.remoteUser2 = null;
      try {
        remoteUser2 = await user1.connectUser({ userId: user2.userId });

        // 初始化RTC连接，完成后就会使用点对点进行数据通信
        await remoteUser2.initRTC();
      } catch (error) {
        console.log("连接用户或rtc初始化失败:", error);
      }

      // 发送数据给对方
      const data1 = {
        val: "hello user2",
      };

      // 通过用户1生成的远端用户2实例发送数据到用户2上
      remoteUser2.post(data1);

      setTimeout(() => {
        // 尝试关闭 rtc 连接，模拟rtc断网过程
        remoteUser2._rtcConnections[0].close();

        setTimeout(() => {
          console.log(
            "1 _rtcConnections.length: ",
            remoteUser2._rtcConnections.length
          ); // => 0

          let count = 0;
          const cancel2 = user2.bind("receive-data", (e) => {
            const { fromUserId, fromUserSessionId, data, server, channel } =
              e.detail;

            if (count === 0) {
              console.log("rtc已经关闭，是server转发的data:", !!server); // true
              console.log("1channel: ", !!channel); // false

              console.log(
                "user2收到数据:",
                data,
                fromUserId,
                fromUserSessionId,
                server
              );
            } else if (count === 1) {
              // 第二次发送时应该已经rtc重连完成
              console.log("rtc已经重新连接，server转发的data:", !!server); // false
              console.log("2channel: ", !!channel); // true

              console.log(
                "user2收到数据:",
                data,
                fromUserId,
                fromUserSessionId,
                channel
              );
              console.log(
                "2 _rtcConnections.length: ",
                remoteUser2._rtcConnections.length
              ); // => 1
            }

            count++;
          });

          const data2 = {
            val: "hello user2 again",
            time: Date.now(),
          };

          const data3 = {
            val: "hello user2 again2",
            time: Date.now(),
          };

          // 尝试重新发送数据，因为 rtc 关闭了，所以会使用server转发
          remoteUser2.post(data2);

          setTimeout(() => {
            // 第三次发送时应该已经rtc重连完成
            remoteUser2.post(data3);
          }, 1000);
        }, 200);
      }, 200);
    </script>
  </body>
</html>
