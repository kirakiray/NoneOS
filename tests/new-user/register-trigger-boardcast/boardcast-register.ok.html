<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>
  <body>
    <script type="module">
      import { createUser } from "/packages/user/main.js";

      // 测试用户
      const user1 = await createUser({ user: "test-user1" });
      await user1.connectAllServers();

      // 提前授权设备证书
      const certManager1 = await user1.certManager();

      const user2 = await createUser({ user: "test-user2" });
      const certManager2 = await user2.certManager();

      const user3 = await createUser({ user: "test-user3" });
      const certManager3 = await user3.certManager();

      // 让user2和user3授权给user1设备证书
      const user2To1Cert = await certManager2.issue({
        userId: user1.userId,
        role: "device",
      });
      const user1To2Cert = await certManager1.issue({
        userId: user2.userId,
        role: "device",
      });
      const user3To1Cert = await certManager3.issue({
        userId: user1.userId,
        role: "device",
      });
      const user1To3Cert = await certManager1.issue({
        userId: user3.userId,
        role: "device",
      });

      await certManager1.save(user2To1Cert);
      await certManager1.save(user3To1Cert);
      await certManager2.save(user1To2Cert);
      await certManager3.save(user1To3Cert);

      await new Promise((resolve) => setTimeout(resolve, 100));

      // 按时塞入3个新的iframe 元素，每个添加的时候延迟100毫秒
      for (let i = 0; i < 3; i++) {
        const iframe = document.createElement("iframe");
        iframe.src = "./receiver-user2.html?tab" + (i + 1);
        iframe.frameborder = "0";
        document.body.appendChild(iframe);

        const iframe2 = document.createElement("iframe");
        iframe2.src = "./receiver-user3.html?tab" + (i + 1);
        iframe2.frameborder = "0";
        document.body.appendChild(iframe2);

        await new Promise((resolve) => setTimeout(resolve, 100));
      }

      // 等待连接建立
      await new Promise((resolve) => setTimeout(resolve, 200));

      // user1开始发送广播
      await user1.broadcast("test1", {
        message: "Hello, World!",
      });

      // TODO: 这是查看 user2 和 user3 应该都收到了 test1 事件

      // 删除证书授权，方便下次测试
      //   await certManager1.delete(user2To1Cert.id);
      //   await certManager1.delete(user1To2Cert.id);
      //   await certManager1.delete(user1To3Cert.id);
      //   await certManager1.delete(user3To1Cert.id);
      //   await certManager2.delete(user2To1Cert.id);
      //   await certManager2.delete(user1To2Cert.id);
      //   await certManager3.delete(user3To1Cert.id);
      //   await certManager3.delete(user1To3Cert.id);
    </script>
  </body>
</html>
