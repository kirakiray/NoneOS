<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SharedWorker 中的 OPFS 测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .log-container {
            border: 1px solid #ccc;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            margin-top: 20px;
            background-color: #f9f9f9;
        }
        button {
            margin: 5px;
            padding: 8px 16px;
        }
        .main-thread {
            background-color: #e6f7ff;
            border: 1px solid #91d5ff;
        }
    </style>
</head>
<body>
    <h1>SharedWorker 中的 OPFS 测试</h1>
    
    <div>
        <button id="writeFileBtn">写入文件</button>
        <button id="readFileBtn">读取文件</button>
        <button id="listFilesBtn">列出文件</button>
        <button id="deleteFileBtn">删除文件</button>
        <button id="writeFileMainBtn" class="main-thread">在主线程写入文件</button>
    </div>
    
    <div class="log-container" id="logContainer"></div>
    
    <script>
        // 创建 SharedWorker
        const worker = new SharedWorker('shared-worker.js');
        const logContainer = document.getElementById('logContainer');
        
        // 日志函数
        function log(message) {
            const logEntry = document.createElement('div');
            logEntry.textContent = `${new Date().toLocaleTimeString()}: ${message}`;
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        // 初始化连接
        worker.port.start();
        
        // 监听来自 worker 的消息
        worker.port.onmessage = function(e) {
            if (e.data.error) {
                log(`错误: ${e.data.error}`);
            } else {
                log(e.data.message);
            }
        };
        
        // 写入文件按钮
        document.getElementById('writeFileBtn').addEventListener('click', function() {
            const content = `测试内容 ${new Date().toISOString()}`;
            worker.port.postMessage({
                action: 'writeFile',
                filename: 'test-file.txt',
                content: content
            });
            log(`请求写入文件: test-file.txt`);
        });
        
        // 读取文件按钮
        document.getElementById('readFileBtn').addEventListener('click', function() {
            worker.port.postMessage({
                action: 'readFile',
                filename: 'test-file.txt'
            });
            log(`请求读取文件: test-file.txt`);
        });
        
        // 列出文件按钮
        document.getElementById('listFilesBtn').addEventListener('click', function() {
            worker.port.postMessage({
                action: 'listFiles'
            });
            log(`请求列出所有文件`);
        });
        
        // 删除文件按钮
        document.getElementById('deleteFileBtn').addEventListener('click', function() {
            worker.port.postMessage({
                action: 'deleteFile',
                filename: 'test-file.txt'
            });
            log(`请求删除文件: test-file.txt`);
        });
        
        // 在主线程写入文件按钮
        document.getElementById('writeFileMainBtn').addEventListener('click', async function() {
            try {
                log('尝试在主线程中访问 OPFS...');
                
                // 检查 OPFS API 是否可用
                if (!navigator.storage || !navigator.storage.getDirectory) {
                    throw new Error('OPFS API 在此环境中不可用');
                }
                
                // 获取根目录
                const root = await navigator.storage.getDirectory();
                
                // 创建文件名和内容
                const filename = 'main-thread-file.txt';
                const content = `主线程写入的内容 ${new Date().toISOString()}`;
                
                // 创建或打开文件
                const fileHandle = await root.getFileHandle(filename, { create: true });
                
                // 获取可写入流
                const writable = await fileHandle.createWritable();
                
                // 写入内容
                await writable.write(content);
                
                // 关闭流
                await writable.close();
                
                log(`主线程成功写入文件: ${filename}`);
                
                // 读取刚刚写入的文件内容
                const file = await fileHandle.getFile();
                const fileContent = await file.text();
                log(`主线程读取文件内容: ${fileContent}`);
                
            } catch (error) {
                log(`主线程写入文件错误: ${error.message}`);
            }
        });
        
        // 页面加载时发送初始化消息
        window.addEventListener('load', function() {
            worker.port.postMessage({ action: 'init' });
            log('页面已加载，SharedWorker 已初始化');
        });
    </script>
</body>
</html>