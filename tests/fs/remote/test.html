<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <style>
      html {
        background-color: rgb(34, 34, 34);
      }
    </style>
  </head>
  <body>
    <script type="module">
      import { get as localGet } from "/packages/fs/handle/main.js";
      import { createGet } from "../../../packages/fs/re-remote/main.js";
      import { createUser } from "/packages/new-user/main.js";

      const user1 = await createUser({ user: "test-user1" });
      const user2 = await createUser({ user: "test-user2" });

      // 初始化角色管理器
      const certManager1 = await user1.certManager();
      const certManager2 = await user2.certManager();

      // 授权给用户2设备权限
      const cert1 = await certManager2.issue({
        userId: user1.userId,
        role: "device",
      });
      // 授权给用户1设备权限
      const cert2 = await certManager1.issue({
        userId: user2.userId,
        role: "device",
      });


      // 保证user2连上服务器
      await user2.connectServer("ws://localhost:18290");

      const remoteUser2 = await user1.connectUser(user2.userId);

      await remoteUser2.initRTC();

      const get = createGet({ remoteUser: remoteUser2 });

      // TODO生成一个1m 的txt file对象，内容随机
      const generateRandomString = (length) => {
        let result = "";
        const characters =
          "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
        const charactersLength = characters.length;
        for (let i = 0; i < length; i++) {
          result += characters.charAt(
            Math.floor(Math.random() * charactersLength)
          );
        }
        return result;
      };

      let oneMFile = null;

      {
        let oneMFileHandle = await localGet("local/test/random-1m.txt");

        if (!oneMFileHandle) {
          // 生成1MB随机字符串
          const oneMFileContent = generateRandomString(1024 * 1024);
          oneMFile = new File([oneMFileContent], "random-1m.txt", {
            type: "text/plain",
          });

          // 写入文件到当前目录
          oneMFileHandle = await localGet("local/test/random-1m.txt", {
            create: "file",
          });
          await oneMFileHandle.write(oneMFile);
        } else {
          oneMFile = await oneMFileHandle.file();
        }
      }

      // 远端获取
      const handle = await get("local");
      const testHandle = await handle.get("test/random-1m.txt");

      const newFile = oneMFile;
      // const newFile = new File([oneMFileContent], "random-1m-2.txt", {
      //   type: "text/plain",
      // });

      // 写入文件
      const handle2 = await handle.get("test/random-1m-2.txt", {
        create: "file",
      });
      await handle2.write(newFile);

      console.log(await testHandle.lastModified());

      const content = await testHandle.text();
      console.log(content);

      // 删除证书授权，方便下次测试
      await certManager1.delete(cert2.id);
      await certManager2.delete(cert1.id);
    </script>
  </body>
</html>
