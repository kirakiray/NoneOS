<template component>
  <style>
    :host {
      display: inline-block;
    }
  </style>
  <span>{{delayText}}</span>
  <script>
    export default async () => {
      return {
        tag: "n-one-delay-text",
        data: {
          delays: [],
          delayText: "-",
        },
        watch: {
          delays() {
            this.refreshText();
          },
        },
        proto: {
          changeColor(color) {
            this.shadow.$("span").style.color = `var(--md-sys-color-${color})`;
          },
          refreshText() {
            if (this.delays.length === 0) {
              this.delayText = "-";
              return;
            }

            // 获取最后一个项目和所有延迟值
            const lastItem = this.delays[this.delays.length - 1];
            const delays = this.delays.map((item) => item.delay);

            // 计算平均延迟
            const avgDelay =
              delays.reduce((sum, delay) => sum + delay, 0) / delays.length;

            // 检查是否有断开或高延迟的情况
            const hasDisconnect = delays.some((delay) => delay >= 8000);
            const hasHighDelay = delays.some(
              (delay) => delay >= 1000 && delay < 8000
            );

            // 检查网络稳定性（如果最大延迟与最小延迟差异很大，则认为不稳定）
            const minDelay = Math.min(...delays);
            const maxDelay = Math.max(...delays);
            const isUnstable =
              maxDelay - minDelay > 1000 ||
              delays.some((delay) => delay >= 8000);

            // 根据最后一个项目的延迟设置基础状态
            let baseStatus, color;
            if (lastItem.delay < 150) {
              baseStatus = "网络畅通";
              color = "success";
            } else if (lastItem.delay < 400) {
              baseStatus = "网络尚可";
              color = "primary";
            } else if (lastItem.delay < 1000) {
              baseStatus = "网络略卡";
              color = "normal";
            } else if (lastItem.delay < 8000) {
              baseStatus = "网络拥堵";
              color = "error";
            } else {
              baseStatus = "网络断开";
              color = "error";
            }

            // 如果网络不稳定，在状态后添加不稳定的描述
            if (isUnstable && delays.length > 1) {
              if (hasDisconnect) {
                this.delayText = `${baseStatus} (曾断开)`;
              } else if (hasHighDelay) {
                this.delayText = `${baseStatus} (不稳定)`;
              } else {
                this.delayText = `${baseStatus} (偶发波动)`;
              }
            } else {
              this.delayText = baseStatus;
            }

            this.changeColor(color);
          },
        },
      };
    };
  </script>
</template>
