<template component>
  <l-m src="/packages/pui/provider/provider.html"></l-m>
  <l-m src="./os-bar.html"></l-m>
  <l-m src="./comps/app-frame/app-frame.html"></l-m>
  <link rel="stylesheet" href="./public.css" />
  <style>
    :host {
      display: block;
      width: 100%;
      height: 100%;
      background-image: url(../others/default-bg.jpg);
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
    }

    .container {
      display: flex;
      /* flex-direction: column; */
      height: 100%;
    }

    .bar {
      position: relative;
      display: flex;
      z-index: 200000;
    }
    .main {
      position: relative;
      flex: 1;
      /* background-color: red; */
    }
  </style>

  <x-if :value="theme === 'dark' ">
    <style>
      :host {
        --frosted-glass-bg: rgba(50, 50, 50, 0.7);
        --frosted-shadow-color: rgba(255, 255, 255, 0.1);
        --barbtn-bg: rgba(100, 100, 100, 0.4);
      }
    </style>
  </x-if>
  <x-else>
    <style>
      :host {
        --frosted-glass-bg: rgba(255, 255, 255, 0.7);
        --frosted-shadow-color: rgba(0, 0, 0, 0.1);
        --barbtn-bg: rgba(255, 255, 255, 0.4);
      }
    </style>
  </x-else>

  <o-provider name="clipboard" type="none">
    <p-provider :theme="theme">
      <div class="container">
        <div class="bar">
          <os-bar
            :apps="barApps"
            on:click-app="clickApp"
            attr:fullmode="hasMaxApp"
          ></os-bar>
        </div>
        <div class="main" on:app-change="appChange">
          <!-- <n-app-frame>
        <div>asdasd</div>
      </n-app-frame> -->
        </div>
      </div>
    </p-provider>
  </o-provider>
  <script>
    import "/packages/pui/init.js";
    import { createRoot } from "../fs/get.js";

    export default async () => {
      await createRoot("apps");
      await createRoot("system");

      return {
        tag: "none-os",
        data: {
          theme: "light",
          barApps: [
            {
              name: "Files",
              icon: "/packages/files/icon.svg",
              url: "/packages/files/app-config.js",
              // status: "running",
            },
            {
              name: "Files2",
              icon: "/packages/files/icon.svg",
              url: "/packages/files/app-config.js",
              // status: "background",
            },
          ],
          hasMaxApp: false, // 是否存在最大化的应用
        },
        proto: {
          clickApp({ data }) {
            const targetApp = data.app;
            targetApp.status = "running";

            const exitedApp = this.shadow.$(
              ".main [data-appid='" + targetApp.xid + "']"
            );

            if (exitedApp) {
              // 直接修正对应的应用
              exitedApp.focusApp();
              if (exitedApp.appStatus === "min") {
                if (exitedApp._oldAppStatus === "max") {
                  exitedApp.appStatus = "max";
                } else {
                  exitedApp.appStatus = "normal";
                }
              }
            } else {
              // 添加这个应用到容器内
              this.shadow.$(".main").push(`
              <n-app-frame data-appid="${targetApp.xid}">
                <o-app src="${targetApp.url}"></o-app>
              </n-app-frame>
              `);
            }

            this.refreshBarMode();
          },
          refreshBarMode() {
            const apps = this.shadow.all(".main n-app-frame");
            this.hasMaxApp = apps.some((e) => e.appStatus === "max");
          },
          appChange(e) {
            const { data } = e;

            const targetData = this.barApps.find((e) => e.xid === data.appid);

            switch (data.type) {
              case "min":
                targetData.status = "background";
                break;
              case "close":
                targetData.status = undefined;
                break;
            }

            this.refreshBarMode();
          },
        },
        async attached() {
          $("body").push(
            `<style>html,body{margin:0;padding:0;height:100%;}</style>`
          );

          setTimeout(() => {
            // 测试代码
            this.clickApp({
              data: { app: this.barApps[0] },
            });
          }, 100);
        },
      };
    };
  </script>
</template>
