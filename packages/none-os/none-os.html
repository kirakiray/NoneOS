<template component>
  <l-m src="/packages/pui/provider/provider.html"></l-m>
  <l-m src="./comps/os-bar.html"></l-m>
  <l-m src="./comps/app-frame.html"></l-m>
  <l-m src="./comps/home-app-frame.html"></l-m>
  <style>
    :host {
      display: block;
      width: 100%;
      height: 100%;
      background-image: url(/packages/others/default-bg.jpg);
      background-size: cover;
      background-position: center;
    }

    /* :host {
      --frosted-glass-bg: rgba(255, 255, 255, 0.7);
      --frosted-shadow-color: rgba(0, 0, 0, 0.1);
      --barbtn-bg: rgba(255, 255, 255, 0.4);
    } */

    :host {
      --frosted-glass-bg: rgba(50, 50, 50, 0.7);
      --frosted-shadow-color: rgba(255, 255, 255, 0.1);
      --barbtn-bg: rgba(100, 100, 100, 0.4);
    }

    .container {
      display: flex;
      width: 100%;
      height: 100%;
    }

    .bar {
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
      z-index: 190001;
    }

    .main {
      position: relative;
      flex: 1;
    }
  </style>
  <p-provider theme="dark">
    <div class="container">
      <div class="bar">
        <none-os-bar
          :apps="barApps"
          sync:active-home="showHomeApp"
        ></none-os-bar>
      </div>
      <div class="main">
        <x-fill :value="barApps">
          <n-app-frame :item="$data">
            <o-app attr:src="$data.configUrl"></o-app>
          </n-app-frame>
        </x-fill>
      </div>
    </div>
  </p-provider>

  <n-home-app-frame sync:show-home-app="showHomeApp">
    <o-app
      src="/packages/apps/app-select.napp/app-config.js"
      on:click-app="runApp"
    ></o-app>
  </n-home-app-frame>

  <script>
    export default async ({ load }) => {
      const { init } = await load("/packages/fs/main.js");

      // 初始化几个重要目录
      await init("local"); // 用户的本地数据
      await init("apps"); // 应用目录
      await init("system"); // 存储系统初始化数据，这个目录不要暴露给用户

      return {
        tag: "none-os",
        data: {
          showHomeApp: false, // 显示首页应用
          barApps: [
            // {
            //   icon: data.icon, // 应用图标
            //   appData: data.appData, // 应用json的数据
            //   configUrl: data.configUrl, // 应用配置js的地址
            //   focused: true, // 应用是否处于焦点的状态
            //   top: 0, // 窗口定位相关的数据
            //   left: 0,
            //   width: 200,
            //   height: 200,
            // },
          ], // 程序坞程序数据
        },
        proto: {
          runApp(e) {
            const { data } = e;

            // 查找是否已经存在
            const exitedApp = this.barApps.find(
              (appData) => appData.configUrl === data.configUrl
            );

            // 取消其他应用的聚焦状态
            this.barApps.forEach((e) => (e.focused = false));

            if (exitedApp) {
              exitedApp.focused = true;
            } else {
              const mainInfo = this.shadow
                .$(".main")
                .ele.getBoundingClientRect();

              const box = {
                // top: 0,
                // left: 0,
                // 默认为窗口一半大小的尺寸
                width: Math.floor(mainInfo.width * 0.75),
                height: Math.floor(mainInfo.height * 0.75),
              };

              // 修正坐标处于正中间
              box.left = Math.floor((mainInfo.width - box.width) / 2);
              box.top = Math.floor((mainInfo.height - box.height) / 2);

              // 添加到应用内
              this.barApps.push({
                icon: data.icon,
                appData: data.appData,
                configUrl: data.configUrl,
                focused: true,
                ...box,
              });

              console.log(this.barApps.slice(-1)[0]);
            }
          },
        },
      };
    };
  </script>
</template>
