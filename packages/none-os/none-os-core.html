<template component>
  <l-m src="./os-bar.html"></l-m>
  <l-m src="./comps/app-frame/app-frame.html"></l-m>
  <l-m src="./comps/home-app-frame.html"></l-m>
  <link rel="stylesheet" href="./public.css" />
  <style>
    :host {
      display: block;
      width: 100%;
      height: 100%;
    }

    .container {
      display: flex;
      /* flex-direction: column; */
      height: 100%;
    }

    .bar {
      position: relative;
      display: flex;
      z-index: 200000;
    }
    .main {
      position: relative;
      flex: 1;
      /* background-color: red; */
    }
  </style>

  <o-provider name="clipboard" type="none">
    <div class="container">
      <div class="bar">
        <os-bar
          :apps="barApps"
          :home-app="homeApp"
          sync:show-home-app="showHomeApp"
          on:click-app="clickBarApp"
          attr:fullmode="hasMaxApp"
        ></os-bar>
      </div>
      <div class="main" on:app-change="appChange">
        <!-- <n-app-frame>
              <div>asdasd</div>
            </n-app-frame> -->
      </div>
      <n-home-app-frame sync:show-home-app="showHomeApp">
        <o-app :src="homeApp.url" on:click-app="runApp"></o-app>
      </n-home-app-frame>
    </div>
  </o-provider>
  <script>
    import "/packages/pui/init.js";

    export default async () => {
      return {
        tag: "none-os-core",
        data: {
          showHomeApp: false,
          homeApp: {
            url: "/packages/app-manager/app-config.js",
            icon: {
              component: true,
              url: "/packages/app-manager/apps-icon.html",
              name: "n-apps-icon",
            },
            name: "App Manager",
          },
          // 应用栏上的应用状态数据
          barApps: [
            // {
            //   name: "Files",
            //   icon: {
            //     url: "/packages/files/icon.svg",
            //   },
            //   url: "/packages/files/app-config.js",
            //   // status: "background",
            // },
            // {
            //   name: "Setting",
            //   icon: {
            //     url: "/packages/setting/icon.svg",
            //   },
            //   url: "/packages/setting/app-config.js",
            //   // status: "running",
            // },
          ],
          hasMaxApp: false, // 是否存在最大化的应用
        },
        proto: {
          runApp(e) {
            const { data } = e;

            let targetBarApp = this.barApps.find((e) => e.name === data.name);

            if (!targetBarApp) {
              this.barApps.push({
                name: data.name,
                icon: {
                  url: data.icon.url,
                },
                url: data.url,
                // status: "background"  "running"
              });

              targetBarApp = this.barApps.find((e) => e.name === data.name);
            }

            const appFrame = this.clickBarApp({
              data: { app: targetBarApp },
            });

            return {
              appFrame,
            };
          },
          get currentAppFrame() {
            return this.shadow.$("n-app-frame[focus]");
          },
          // 点击应用栏应用
          clickBarApp({ data }) {
            const targetBarApp = data.app;
            targetBarApp.status = "running"; // 点击后就直接修正为运行中

            const exitedAppFrame = this.shadow.$(
              ".main [data-appid='" + targetBarApp.xid + "']"
            );

            let reData; // 返回的内容

            if (exitedAppFrame) {
              // 直接修正对应的应用
              exitedAppFrame.focusApp();
              if (exitedAppFrame.appStatus === "min") {
                if (exitedAppFrame._oldAppStatus === "max") {
                  exitedAppFrame.appStatus = "max";
                } else {
                  exitedAppFrame.appStatus = "normal";
                }
              }

              reData = exitedAppFrame;
            } else {
              if (targetBarApp.appType === "frame") {
                console.log("暂时不支持 frame 模式");
              } else {
                // 添加这个应用到容器内
                const appFrame =
                  $(`<n-app-frame data-appid="${targetBarApp.xid}">
                      <o-app src="${targetBarApp.url}"></o-app>
                    </n-app-frame>`);

                appFrame._appData = data.app.toJSON();

                reData = appFrame;

                // 小屏幕下，直接全屏
                if (window.innerWidth <= 600) {
                  appFrame.attr("default-app-status", "max");
                }

                this.shadow.$(".main").push(appFrame);

                this.saveAppsState();
              }
            }

            this.refreshBarMode();

            return reData;
          },
          refreshBarMode() {
            const apps = this.shadow.all(".main n-app-frame");
            this.hasMaxApp = apps.some((e) => e.appStatus === "max");
          },
          // 应用最大化最小化的改动
          appChange(e) {
            const { data } = e;

            const targetData = this.barApps.find((e) => e.xid === data.appid);

            switch (data.type) {
              case "min":
                targetData.status = "background";
                break;
              case "close":
                targetData.status = undefined;
                break;
            }

            this.refreshBarMode();
          },
          async initHistory() {
            const bindHistory = () => {
              let f;
              window.addEventListener(
                "popstate",
                (f = (event) => {
                  const { state } = event;

                  const currentAppFrame = this?.currentAppFrame;

                  if (state.routerType === "backward") {
                    // console.log("app backward");
                    history.forward(); // 还原
                    currentAppFrame.back();
                  } else if (state.routerType === "forward") {
                    // console.log("app forward");
                    history.back(); // 还原
                    currentAppFrame.forward();
                  }
                })
              );

              this._offState = () => {
                window.removeEventListener("popstate", f);
              };
            };

            if (history.state && history.state.routerType === "current") {
              // 处于当前态就直接注册事件
              bindHistory();
              return;
            }

            // 先修正为返回状态
            history.replaceState(
              {
                routerType: "backward",
              },
              "None OS back state",
              "/#backward"
            );

            await new Promise((res) => setTimeout(res, 50));

            // 添加当前页状态
            history.pushState(
              {
                routerType: "current",
              },
              "None OS",
              "/"
            );

            await new Promise((res) => setTimeout(res, 50));

            // 添加前进态
            history.pushState(
              {
                routerType: "forward",
              },
              "None OS forward state",
              "/#forward"
            );

            await new Promise((res) => setTimeout(res, 50));

            // 返回到正常的当前态
            history.back();

            bindHistory();
          },
          // 保存所有应用的路由数据
          saveAppsState() {
            clearTimeout(this._routerTimer);
            this._routerTimer = setTimeout(() => {
              // 遍历所有应用，并保留路由数据
              const appRouters = this.shadow
                .all(`n-app-frame`)
                .map((appFrame) => {
                  const app = appFrame.$("o-app");

                  return {
                    routers: app.routers,
                    appData: appFrame._appData,
                  };
                });

              sessionStorage._app_routers = JSON.stringify(appRouters);
            }, 300);
          },
          // 加载应用路由
          loadAppsState() {
            const appRouters = JSON.parse(sessionStorage._app_routers || "[]");

            appRouters.forEach((e) => {
              const { appFrame } = this.runApp({
                data: e.appData,
              });

              appFrame.$("o-app").routers = e.routers;
            });
          },
        },
        ready() {
          this.shadow.on("router-change", (e) => {
            this.saveAppsState();
          });
          this.shadow.on("app-close", () => this.saveAppsState());
        },
        async attached() {
          if (history.state && history.state.routerType === "current") {
            // 处于当前态就直接注册事件
            this.initHistory();
          } else {
            // 使用事件注册历史，才能不会被系统修正历史
            $("html").one("mousedown", () => {
              this.initHistory();
            });
          }

          this.loadAppsState();

          //   // testcode
          // setTimeout(() => {
          //   this.runApp({
          //     data: {
          //       name: "设置",
          //       icon: { url: "/packages/setting/icon.svg" },
          //       url: "/packages/setting/app-config.js",
          //     },
          //   });
          // }, 100);
        },
        detached() {
          this._offState && this._offState();
        },
      };
    };
  </script>
</template>
