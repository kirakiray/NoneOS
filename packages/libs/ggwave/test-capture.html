<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GGWave éŸ³é¢‘æ•è·æµ‹è¯•</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 50px auto;
        padding: 20px;
        background-color: #f5f5f5;
      }
      .container {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
        text-align: center;
        margin-bottom: 30px;
      }
      .controls {
        text-align: center;
        margin: 20px 0;
      }
      button {
        padding: 12px 24px;
        margin: 0 10px;
        border: none;
        border-radius: 5px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: background-color 0.3s;
      }
      .start-btn {
        background-color: #28a745;
        color: white;
      }
      .start-btn:hover {
        background-color: #218838;
      }
      .stop-btn {
        background-color: #dc3545;
        color: white;
      }
      .stop-btn:hover {
        background-color: #c82333;
      }
      button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }
      .status {
        margin: 20px 0;
        padding: 15px;
        border-radius: 5px;
        font-weight: bold;
        text-align: center;
      }
      .status.info {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      .status.success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }
      .status.error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }
      .status.warning {
        background-color: #fff3cd;
        color: #856404;
        border: 1px solid #ffeaa7;
      }
      
      /* æ¥æ”¶å’Œåˆ†æçŠ¶æ€æŒ‡ç¤ºå™¨æ ·å¼ */
      .analysis-status-container {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin: 20px 0;
      }
      
      .status-indicator {
        display: flex;
        align-items: center;
        padding: 10px 15px;
        border-radius: 20px;
        font-weight: bold;
        opacity: 0.3;
        transition: opacity 0.3s ease;
      }
      
      .status-indicator.active {
        opacity: 1;
        animation: pulse 1.5s infinite;
      }
      
      @keyframes pulse {
        0% { opacity: 1; }
        50% { opacity: 0.7; }
        100% { opacity: 1; }
      }
      
      .status-indicator.receiving {
        background-color: #cce5ff;
        color: #004085;
        border: 1px solid #b8daff;
      }
      
      .status-indicator.analyzing {
        background-color: #d1ecf1;
        color: #0c5460;
        border: 1px solid #bee5eb;
      }
      
      .indicator-icon {
        margin-right: 8px;
        font-size: 18px;
      }
      .messages {
        margin-top: 30px;
        border: 2px solid #e9ecef;
        border-radius: 5px;
        padding: 20px;
        background-color: #f8f9fa;
        min-height: 200px;
        max-height: 400px;
        overflow-y: auto;
      }
      .messages h3 {
        margin-top: 0;
        color: #495057;
        border-bottom: 2px solid #dee2e6;
        padding-bottom: 10px;
      }
      .message-item {
        background-color: white;
        margin: 10px 0;
        padding: 12px;
        border-radius: 5px;
        border-left: 4px solid #007bff;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      }
      .message-item .time {
        font-size: 12px;
        color: #6c757d;
        margin-bottom: 5px;
      }
      .message-item .content {
        font-weight: bold;
        color: #212529;
        word-break: break-all;
      }
      .no-messages {
        text-align: center;
        color: #6c757d;
        font-style: italic;
        margin: 40px 0;
      }
      .clear-btn {
        background-color: #6c757d;
        color: white;
        font-size: 14px;
        padding: 8px 16px;
        margin-top: 10px;
      }
      .clear-btn:hover {
        background-color: #5a6268;
      }
      .instructions {
        background-color: #e7f3ff;
        border: 1px solid #b8daff;
        border-radius: 5px;
        padding: 15px;
        margin-bottom: 20px;
        color: #004085;
      }
      .instructions h4 {
        margin-top: 0;
        color: #004085;
      }
      .instructions ol {
        margin-bottom: 0;
      }
      .instructions li {
        margin: 5px 0;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ¤ GGWave éŸ³é¢‘æ•è·æµ‹è¯•</h1>

      <div class="instructions">
        <h4>ä½¿ç”¨è¯´æ˜ï¼š</h4>
        <ol>
          <li>ç‚¹å‡»"å¼€å§‹æ•è·"æŒ‰é’®ä»¥å¯åŠ¨éŸ³é¢‘æ•è·</li>
          <li>
            åœ¨å¦ä¸€ä¸ªè®¾å¤‡æˆ–æµè§ˆå™¨æ ‡ç­¾é¡µä¸­æ‰“å¼€
            <a href="test-send.html" target="_blank">test-send.html</a>
            å¹¶å‘é€éŸ³é¢‘æ¶ˆæ¯
          </li>
          <li>æ¥æ”¶åˆ°çš„æ¶ˆæ¯å°†æ˜¾ç¤ºåœ¨ä¸‹æ–¹æ¶ˆæ¯åŒºåŸŸä¸­</li>
          <li>ç‚¹å‡»"åœæ­¢æ•è·"æŒ‰é’®ä»¥åœæ­¢éŸ³é¢‘æ•è·</li>
        </ol>
      </div>

      <div class="controls">
        <button id="startBtn" class="start-btn">ğŸ¤ å¼€å§‹æ•è·</button>
        <button id="stopBtn" class="stop-btn" disabled>â¹ï¸ åœæ­¢æ•è·</button>
      </div>

      <div id="status" class="status info" style="display: none"></div>
      
      <!-- æ·»åŠ æ¥æ”¶å’Œåˆ†æçŠ¶æ€æŒ‡ç¤ºå™¨ -->
      <div class="analysis-status-container">
        <div id="receivingIndicator" class="status-indicator receiving">
          <span class="indicator-icon">ğŸ“¡</span>
          <span class="indicator-text">æ¥æ”¶æ•°æ®ä¸­...</span>
        </div>
        <div id="analyzingIndicator" class="status-indicator analyzing">
          <span class="indicator-icon">ğŸ”</span>
          <span class="indicator-text">åˆ†ææ•°æ®ä¸­...</span>
        </div>
      </div>

      <div class="messages">
        <h3>ğŸ“¨ æ¥æ”¶åˆ°çš„æ¶ˆæ¯</h3>
        <div id="messagesList">
          <div class="no-messages">æš‚æ— æ¶ˆæ¯ï¼Œå¼€å§‹æ•è·åå°†æ˜¾ç¤ºæ¥æ”¶åˆ°çš„æ¶ˆæ¯</div>
        </div>
        <button id="clearBtn" class="clear-btn" style="display: none">
          ğŸ—‘ï¸ æ¸…ç©ºæ¶ˆæ¯
        </button>
      </div>
    </div>

    <script type="module">
      import { GgwaveReceiver } from "./main.js";

      let captureInstance = null;
      let messageCount = 0;

      const startBtn = document.getElementById("startBtn");
      const stopBtn = document.getElementById("stopBtn");
      const status = document.getElementById("status");
      const messagesList = document.getElementById("messagesList");
      const clearBtn = document.getElementById("clearBtn");
      const receivingIndicator = document.getElementById("receivingIndicator");
      const analyzingIndicator = document.getElementById("analyzingIndicator");

      function showStatus(message, type = "info") {
        status.textContent = message;
        status.className = `status ${type}`;
        status.style.display = "block";
      }

      function hideStatus() {
        status.style.display = "none";
      }

      function addMessage(message, timestamp) {
        const time = new Date(timestamp).toLocaleTimeString();
        const messageItem = document.createElement("div");
        messageItem.className = "message-item";
        messageItem.innerHTML = `
                <div class="time">${time}</div>
                <div class="content">${escapeHtml(message)}</div>
            `;

        // å¦‚æœæ˜¯ç¬¬ä¸€æ¡æ¶ˆæ¯ï¼Œç§»é™¤"æš‚æ— æ¶ˆæ¯"æç¤º
        if (messageCount === 0) {
          messagesList.innerHTML = "";
          clearBtn.style.display = "inline-block";
        }

        messagesList.insertBefore(messageItem, messagesList.firstChild);
        messageCount++;

        // é™åˆ¶æ¶ˆæ¯æ•°é‡ï¼Œé¿å…å†…å­˜æº¢å‡º
        if (messageCount > 100) {
          messagesList.removeChild(messagesList.lastChild);
          messageCount--;
        }
      }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      function clearMessages() {
        messagesList.innerHTML =
          '<div class="no-messages">æš‚æ— æ¶ˆæ¯ï¼Œå¼€å§‹æ•è·åå°†æ˜¾ç¤ºæ¥æ”¶åˆ°çš„æ¶ˆæ¯</div>';
        messageCount = 0;
        clearBtn.style.display = "none";
      }

      // ç›‘å¬ GGWave æ¶ˆæ¯äº‹ä»¶
      // è®¾ç½®äº‹ä»¶ç›‘å¬å™¨
      function setupEventListeners(captureInstance) {
        // ç›‘å¬æ¶ˆæ¯äº‹ä»¶
        captureInstance.addEventListener("ggwave-message", (event) => {
          const { message, timestamp } = event.detail;
          addMessage(message, timestamp);
          showStatus(`âœ… æ¥æ”¶åˆ°æ¶ˆæ¯: "${message}"`, "success");

          // 3ç§’åéšè—çŠ¶æ€ä¿¡æ¯
          setTimeout(() => {
            if (captureInstance && captureInstance.isCapturing()) {
              showStatus("ğŸ¤ æ­£åœ¨æ•è·éŸ³é¢‘...", "info");
            } else {
              hideStatus();
            }
          }, 3000);
        });
        
        // ç›‘å¬æ¥æ”¶æ•°æ®äº‹ä»¶
        captureInstance.addEventListener("receiving", () => {
          receivingIndicator.classList.add("active");
          console.log("receiving");
          // 2ç§’åè‡ªåŠ¨éšè—
          setTimeout(() => {
            receivingIndicator.classList.remove("active");
          }, 2000);
        });
        
        // ç›‘å¬åˆ†ææ•°æ®äº‹ä»¶
        captureInstance.addEventListener("analyzing", () => {
          analyzingIndicator.classList.add("active");
          console.log("analyzing");
          // 2ç§’åè‡ªåŠ¨éšè—
          setTimeout(() => {
            analyzingIndicator.classList.remove("active");
          }, 2000);
        });
      }

      startBtn.addEventListener("click", async () => {
        try {
          startBtn.disabled = true;
          showStatus("æ­£åœ¨åˆå§‹åŒ–éŸ³é¢‘æ•è·...", "info");

          captureInstance = new GgwaveReceiver();
          await captureInstance.start();
          setupEventListeners(captureInstance);

          stopBtn.disabled = false;
          showStatus("ğŸ¤ æ­£åœ¨æ•è·éŸ³é¢‘...", "info");

          console.log("GGWave capture started successfully");
        } catch (error) {
          showStatus(`âŒ å¯åŠ¨æ•è·å¤±è´¥: ${error.message}`, "error");
          console.error("GGWave capture error:", error);
          startBtn.disabled = false;
        }
      });

      stopBtn.addEventListener("click", async () => {
        if (captureInstance) {
          try {
            stopBtn.disabled = true;
            showStatus("æ­£åœ¨åœæ­¢éŸ³é¢‘æ•è·...", "warning");

            await captureInstance.stop();
            captureInstance = null;

            startBtn.disabled = false;
            hideStatus();

            console.log("GGWave capture stopped successfully");
          } catch (error) {
            showStatus(`âŒ åœæ­¢æ•è·å¤±è´¥: ${error.message}`, "error");
            console.error("GGWave stop error:", error);
            stopBtn.disabled = false;
          }
        }
      });

      clearBtn.addEventListener("click", clearMessages);

      // é¡µé¢å¸è½½æ—¶æ¸…ç†èµ„æº
      window.addEventListener("beforeunload", async () => {
        if (captureInstance) {
          try {
            await captureInstance.stop();
          } catch (error) {
            console.warn("Failed to stop capture on page unload:", error);
          }
        }
      });

      // æ£€æŸ¥æµè§ˆå™¨æ”¯æŒ
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        showStatus("âŒ æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒéŸ³é¢‘æ•è·åŠŸèƒ½", "error");
        startBtn.disabled = true;
      }
    </script>
  </body>
</html>
