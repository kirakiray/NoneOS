<template page>
  <l-m src="/packages/pui/button/button.html"></l-m>
  <l-m src="/packages/pui/button/button-group.html"></l-m>
  <l-m src="/packages/pui/text-field/text-field.html"></l-m>
  <l-m src="/packages/local-icon/local-icon.html"></l-m>
  <l-m src="./comps/bottom-address.html"></l-m>
  <style>
    :host {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    .top {
      display: flex;
      padding: 4px;
      height: 40px;
    }
    .main {
      display: flex;
      flex-direction: column;
      flex: 1;
    }

    p-button-group {
      margin-right: 8px;
    }

    n-local-icon {
      display: block;
      font-size: 18px;
    }

    .search-input {
      margin: 0 8px 0 auto;
      width: 200px;
    }

    .address {
      display: flex;
      align-items: center;
      height: 32px;
      font-size: 14px;
    }

    .clipboard-area {
      display: flex;
      align-items: center;
      padding-left: 8px;
      height: 40px;
      font-size: 14px;
      color: var(--md-sys-color-on-primary-container);
      background-color: var(--md-sys-color-primary-container);
      overflow: hidden;
      transition: all ease 0.3s;
    }
    .clipboard-area.hide {
      opacity: 0;
      height: 0;
      transition: all ease 0.01s;
    }
  </style>
  <div class="top">
    <p-button-group variant="outlined">
      <p-button
        size="small"
        on:click="appBack"
        attr:disabled="app.routers.length <= 1"
      >
        <n-local-icon name="back"></n-local-icon>
      </p-button>
      <p-button
        size="small"
        on:click="appForward"
        attr:disabled="!fowardAddress.length"
      >
        <n-local-icon name="forward"></n-local-icon>
      </p-button>
    </p-button-group>
    <p-button-group variant="outlined">
      <p-button
        size="small"
        attr:disabled="!selecteds.length"
        on:click="clickCut"
      >
        <n-local-icon name="cut"></n-local-icon>
      </p-button>
      <p-button
        size="small"
        attr:disabled="!selecteds.length"
        on:click="clickCopy"
      >
        <n-local-icon name="copy"></n-local-icon>
      </p-button>
      <p-button size="small" attr:disabled="!clipboard?.sources?.length">
        <n-local-icon name="paste"></n-local-icon>
      </p-button>
      <p-button size="small" attr:disabled="selecteds.length !== 1">
        <n-local-icon name="rename"></n-local-icon>
      </p-button>
      <p-button size="small" attr:disabled="selecteds.length !== 1">
        <n-local-icon name="delete"></n-local-icon>
      </p-button>
    </p-button-group>
    <p-button-group variant="outlined">
      <p-button size="small">
        <n-local-icon name="import"></n-local-icon>
      </p-button>
      <p-button size="small">
        <n-local-icon name="export"></n-local-icon>
      </p-button>
    </p-button-group>

    <p-text-field
      size="small"
      class="search-input"
      placeholder="在当前文件夹搜索"
    >
      <n-local-icon name="search" slot="prefix"></n-local-icon>
    </p-text-field>
  </div>
  <div class="main" on:select-files="selectFiles">
    <div style="position: relative; flex: 1">
      <slot></slot>
    </div>
  </div>

  <div class="clipboard-area" class:hide="!clipboard?.sources?.length">
    {{clipboardText}}
    <p-button
      size="small"
      on:click="cProvider.desc = null"
      style="margin: 0 8px"
    >
      点击取消操作
    </p-button>
  </div>

  <div class="address">
    <n-bottom-address
      :path="path"
      on:click-address="clickAddress"
    ></n-bottom-address>
  </div>

  <o-consumer name="clipboard" watch:desc="clipboard"></o-consumer>

  <script>
    export const parent = "./outer-layout.html";

    export default {
      data: {
        path: "",
        fowardAddress: [], // 向前递进的路径
        selecteds: [],
        clipboard: {
          // 等待中的操作
          type: "copy", // cut 或 copy
          sources: [], // 源地址
        },
      },
      proto: {
        get clipboardText() {
          switch (this?.clipboard?.type) {
            case "copy":
              return `复制 ${this.clipboard.sources.join(",")}`;
            case "cut":
              return `剪切 ${this.clipboard.sources.join(",")}`;
          }
        },
        get cProvider() {
          return this.shadow.$('[name="clipboard"]').provider;
        },
        clickCopy(e) {
          this.cProvider.desc = {
            type: "copy",
            sources: [...this.selecteds],
          };
        },
        clickCut(e) {
          this.cProvider.desc = {
            type: "cut",
            sources: [...this.selecteds],
          };
        },
        clickPaste(e) {},
        selectFiles(e) {
          e.stopPropagation();
          this.selecteds = e.data.selecteds.map((e) => e.path);
        },
        appBack() {
          // 后退前记录地址路径
          this.app.back();
        },
        appForward() {
          // 前进
          const nextPath = this.fowardAddress.shift();
          this._is_forward = 1;
          if (nextPath) {
            this.app.current.goto(`./explore.html?path=${nextPath}`);
          }
        },
        clickAddress(e) {
          const {
            data: { newPath },
          } = e;

          this.app.current.goto(`./explore.html?path=${newPath}`);
        },
      },
      ready() {
        this.on("go-page", (e) => {
          e.stopPropagation();
          this.selecteds = [];
          this.path = e.data.path;
        });
      },
      attached() {
        let routerChangeFunc;
        const { app } = this;

        app.on(
          "router-change",
          (routerChangeFunc = (e) => {
            const { name, delta, historys } = e.data;
            if (name === "goto" || name === "replace") {
              if (this._is_forward) {
                this._is_forward = null;
                return;
              }
              this.fowardAddress = []; // 清空前进路径
            } else if (name === "back") {
              this.fowardAddress.unshift(
                ...historys.map((e) => {
                  return new URL(e.src).searchParams.get("path");
                })
              );
            }
          })
        );

        this._offFunc = () => {
          app.off("router-change", routerChangeFunc);
        };
      },
      detached() {
        this._offFunc && this._offFunc();
      },
    };
  </script>
</template>
