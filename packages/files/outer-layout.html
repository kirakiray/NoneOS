<template page>
  <l-m src="/packages/local-icon/local-icon.html"></l-m>
  <l-m src="/packages/pui/list/list.html"></l-m>
  <l-m src="/packages/others/comps/horsp-pannel.html"></l-m>
  <l-m src="/packages/files/comps/task-viewer/viewer.html"></l-m>
  <style>
    :host {
      display: block;
      height: 100%;
      background-color: var(--md-sys-color-surface);
    }

    p-list-item::part(main) {
      margin: 2px 0;
      border-radius: 0 20px 20px 0;
      overflow: hidden;
    }

    p-list-item[active-item]::part(main) {
      background-color: var(--md-sys-color-primary);
      color: var(--md-sys-color-on-primary);
    }

    n-local-icon[slot="prefix"] {
      display: block;
      font-size: 18px;
      margin-right: 8px;
    }

    h5 {
      margin: 0;
      padding: 4px 8px;
    }

    .left-con {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .left-bottom {
      margin-top: auto;
    }

    .task-block {
      display: flex;
      align-items: center;
      padding: 8px 8px;
      font-size: 12px;
      line-height: 1.2em;
      word-break: break-all;
      cursor: pointer;
      background-color: var(--md-sys-color-on-normal);
      border-radius: 0 20px 20px 0;
    }

    .task-block:hover {
      background-color: var(--md-ref-palette-translucent-primary60);
    }

    .task-block p-progress {
      margin-right: 6px;
      --circle-size: 18;
    }

    .task-block .file-block {
      margin: 0 4px;
      color: var(--md-sys-color-primary);
    }
  </style>
  <n-horsp-pannel>
    <div slot="left" class="left-con">
      <p-list>
        <p-list-item collapse-childs="open" button="suffix">
          <span style="font-size: 13px; font-weight: 600">当前空间</span>
          <i collapse-triangle slot="suffix"></i>
          <p-list slot="childs">
            <x-fill :value="locals" name="path-item"> </x-fill>
          </p-list>
        </p-list-item>
        <p-list-item collapse-childs="open" button="suffix">
          <span style="font-size: 13px; font-weight: 600">其他设备</span>
          <i collapse-triangle slot="suffix"></i>
          <p-list slot="childs">
            <x-fill :value="remotes">
              <p-list-item collapse-childs="open" button="suffix">
                <n-local-icon
                  slot="prefix"
                  name="user"
                  style="padding-left: 8px"
                ></n-local-icon>
                {{$data.name}}
                <i collapse-triangle slot="suffix"></i>
                <p-list slot="childs" style="--padding-left: 16px">
                  <x-fill :value="$data.paths" name="path-item"></x-fill>
                </p-list>
              </p-list-item>
            </x-fill>
            <x-if :value="!remotes.length">
              <p-list-item>
                <div style="text-align: center; color: #7d7d7d">无</div>
              </p-list-item>
            </x-if>
          </p-list>
        </p-list-item>
      </p-list>
      <div class="left-bottom">
        <x-fill :value="tasks">
          <div class="task-block" on:click="$data.showViewer = true">
            <x-if :value="$data.completed">
              复制成功 (<span class="file-block">{{$data.from}}</span>
              {{$data.type === 'copyTo' ? '复制到' : ''}}
              <span class="file-block">{{$data.to}}</span>)
            </x-if>
            <x-else>
              <p-progress type="circle"></p-progress>
              正在将
              <span class="file-block">{{$data.from}}</span>
              {{$data.type === 'copyTo' ? '复制到' : ''}}
              <span class="file-block">{{$data.to}}</span>
            </x-else>
          </div>
        </x-fill>
      </div>
    </div>
    <slot></slot>
  </n-horsp-pannel>

  <template name="path-item">
    <p-list-item
      button
      attr:active-item="$data.path === $host.selectedRootName"
      on:click="$host.clickTab($data)"
    >
      <n-local-icon
        slot="prefix"
        attr:name="$data.icon || 'folder'"
        style="padding-left: var(--padding-left, 8px)"
      ></n-local-icon>
      {{$data.name}}
    </p-list-item>
  </template>

  <x-fill :value="tasks">
    <task-viewer sync:show="$data.showViewer" :path="$data.path"> </task-viewer>
  </x-fill>

  <script>
    import { getRemotes } from "/packages/fs/r-handle/index.js";
    import { copyTo } from "/packages/fs/task.js";

    export default async ({ load }) => {
      const { get } = await load("/packages/fs/main.js");

      return {
        data: {
          locals: [
            {
              name: "虚拟空间",
              path: "local",
            },
            {
              name: "应用",
              path: "apps",
              icon: "apps",
            },
            {
              name: "依赖包",
              path: "packages",
              icon: "safe",
            },
            {
              name: "高速盘(test)",
              path: "$origin:local",
            },
          ],
          selectedRootName: null,
          remotes: [], // 远端设备
          // 进行的任务
          tasks: [
            // {
            //   type: "copyTo",
            //   from: "AAA",
            //   to: "bbb",
            //   paused: false // 是否暂停中
            //   showViewer: false // 是否显示查看器
            //   path: '', // 任务目录的地址
            //   completed: false // 任务是否已经完成
            // },
          ],
        },
        proto: {
          clickTab(data) {
            if (data.path === this.selectedRootName) {
              return;
            }
            this.selectedRootName = data.path;
            this.app.current.goto(`./explore.html?path=${data.path}`);
          },
          // 打开查看器
          showViewer(path, delayTime) {
            const exitedItem = this.tasks.find((e) => e.path === path);

            if (exitedItem) {
              if (delayTime) {
                setTimeout(() => {
                  exitedItem.showViewer = true;
                }, delayTime);
              } else {
                exitedItem.showViewer = true;
              }
            }
          },
        },
        async ready() {
          const isSafari =
            navigator.userAgent.includes("Safari") &&
            !navigator.userAgent.includes("Chrome");
          if (isSafari) {
            // safari不允许写入本地盘
            this.locals = this.locals.filter((e) => {
              return !/^\$origin/.test(e.path);
            });
          }

          this.on("go-page", (e) => {
            e.stopPropagation();

            const rootName = e.data.path.split("/")[0];
            this.selectedRootName = rootName;
          });

          this.on("run-task", async (e) => {
            const { data } = e;

            if (data.type === "copyTo") {
              const { source, target } = data;

              await copyTo({
                // debugTime: 200,
                source,
                target,
                prepare: async (e) => {
                  this.tasks.push({
                    type: data.type,
                    paused: false,
                    path: e.path,
                    from: source.name,
                    to: target.name,
                    showViewer: false,
                  });

                  this.showViewer(e.path, 300);

                  // 添加延迟并刷新粘贴中的页面
                  await new Promise((res) => setTimeout(res, 150));
                  this.app.current.refreshFiles();

                  await new Promise((res) => setTimeout(res, 150));
                },
                progress: (e) => {
                  this.taskPercentage = Math.ceil((e.count / e.total) * 100);
                },
              });
            }
          });

          this.on("task-complete", async (e) => {
            const { data } = e;

            const target = this.tasks.find((e) => {
              return e.path === data.path;
            });

            this.app.current.refreshFiles();

            if (target) {
              target.completed = 1;
              setTimeout(() => {
                const index = this.tasks.findIndex((e) => e === target);
                if (index > -1) {
                  this.tasks.splice(index, 1);
                }
              }, 2000);
            }
          });

          this.on("open-task", async (e) => {
            e.stopPropagation();

            const { data } = e;

            const handle = await get(`${data.path}/task.json`);
            let taskData = await handle.text();
            if (taskData) {
              taskData = JSON.parse(taskData);
            }

            // 查看是否已经存在
            const exitedItem = this.tasks.find((e) => e.path === data.path);

            if (!exitedItem) {
              this.tasks.push({
                type: taskData.type,
                paused: true,
                path: data.path,
                from: taskData.from.replace(/.+\/(.+)$/, "$1"),
                to: taskData.to.replace(/.+\/(.+)$/, "$1"),
                showViewer: false,
              });
              this.showViewer(data.path, 100);
            } else {
              this.showViewer(data.path);
            }
          });

          this.remotes = await getRemotes();
        },
      };
    };
  </script>
</template>
