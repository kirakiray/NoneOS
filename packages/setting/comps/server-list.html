<template component>
  <l-m src="/packages/pui/list/list.html"></l-m>
  <l-m src="/packages/pui/text-field/text-field.html"></l-m>
  <l-m src="/packages/local-icon/local-icon.html"></l-m>

  <style>
    h5 {
      margin: 16px 0 4px;
    }
    [data-status] {
      color: var(--md-sys-color-error);
    }
    [data-status="connecting"] {
      color: var(--md-sys-color-normal);
    }
    [data-status="connected"] {
      color: var(--md-sys-color-success);
    }
  </style>
  <h5>握手服务器列表</h5>
  <div>
    <p-list style="width: 500px">
      <x-fill :value="sers" fill-key="serverUrl">
        <p-list-item
          button
          attr:active-item="$host.selectedServer === $data.serverUrl"
          on:click="$host.selectedServer = $data.serverUrl"
        >
          <n-local-icon
            name="server"
            slot="prefix"
            style="
              display: block;
              margin-right: 8px;
              font-size: 24px;
              color: var(--md-sys-color-primary);
            "
          ></n-local-icon>
          <div>
            {{$data.name}} -
            <span style="font-size: 12px; color: var(--md-sys-color-normal)">
              {{$data.version}} - delay:{{$data.delayTime}}ms
            </span>
          </div>
          <span secondary>{{$data.serverUrl}}</span>
          <span slot="suffix" attr:data-status="$data.status">
            {{$data.status}}
          </span>
        </p-list-item>
      </x-fill>
      <p-list-item>
        <p-text-field
          size="small"
          sync:value="newSerUrl"
          style="margin-right: 24px"
          placeholder="填写新握手服务器地址"
        >
        </p-text-field>
        <p-button
          slot="suffix"
          size="small"
          on:click="clickAddServer"
          attr:disabled="!newSerUrl"
        >
          添加服务器
        </p-button>
      </p-list-item>
    </p-list>
  </div>
  <script>
    import { getServers, bind } from "/packages/none-os/user/connect/main.js";
    import { enqueue } from "/packages/pui/snackbar/enqueue.js";

    export default async () => {
      return {
        tag: "setting-server-list",
        data: {
          sers: [], // 已存在的服务器
          selectedServer: "", // 选择中的服务器
          newSerUrl: "", // 添加新服务器的地址
        },
        proto: {
          clickAddServer() {
            const newUrl = this.newSerUrl;

            if (!validateURL(newUrl)) {
              enqueue({ content: "输入的握手服务器地址有误", color: "error" });
              return;
            }

            this.newSerUrl = "";
          },
          async reloadServers() {
            const servers = getServers();

            this.sers = servers.map((e) => {
              return {
                name: e.serverName,
                version: e.serverVersion,
                status: e.status,
                serverUrl: e.serverUrl,
                _server: e,
                delayTime: e.delayTime,
              };
            });
          },
        },
        ready() {
          window.aaa = this;
          this.reloadServers();
        },
        attached() {
          const cancels = (this._cancels = []);

          cancels.push(
            bind("server-state-change", (e) => {
              const { originTarget } = e;

              this.reloadServers();
            })
          );

          cancels.push(
            bind("server-ping", (e) => {
              const { originTarget } = e;

              this.reloadServers();
            })
          );
        },
        detached() {
          this._cancels && this._cancels.forEach((f) => f());
        },
      };
    };

    function validateURL(url) {
      const regex =
        /^(?:http(s)?:\/\/)?[\w.-]+(?:\.[\w\.-]+)+[\w\-\._~:/?#[\]@!\$&'\*\+,;=.]+$/;
      return regex.test(url);
    }
  </script>
</template>
