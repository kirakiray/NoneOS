<template page>
  <l-m src="/packages/pui/table/table.html"></l-m>
  <l-m src="/packages/local-icon/local-icon.html"></l-m>
  <style>
    :host {
      display: block;
      overflow: auto;
    }

    .container {
      display: flex;
      flex-direction: column;
      /* justify-content: center;
      align-items: center; */
      padding-left: 16px;
      height: 100%;
    }

    h5 {
      padding: 16px 0 8px;
      margin: 0;
    }

    .avatar {
      border-radius: 51px;
      width: 100px;
      height: 100px;
      background-color: var(--md-ref-palette-translucent-normal60);
    }

    .row-val {
      text-overflow: ellipsis;
      overflow: hidden;
      word-break: break-all;
      display: -webkit-box;
      -webkit-box-orient: vertical;
      -webkit-line-clamp: 2;
    }

    .hide {
      visibility: hidden !important;
    }

    .server-line {
      padding: 4px 8px;
      margin: 0 16px 0 0;
      border: #aaa solid 1px;
      border-radius: 8px;
    }
  </style>
  <div class="container">
    <h5>用户信息</h5>
    <!-- <div class="avatar"></div> -->
    <p-table style="margin-right: 16px">
      <p-table-row>
        <p-table-cell col-width="120">用户名</p-table-cell>
        <p-table-cell>
          <x-if :value="renameMode">
            <input
              id="renameInputer"
              type="text"
              sync:value="userName"
              on:change="renameEnd"
              on:blur="renameMode = false"
            />
          </x-if>
          <x-else>
            <div>{{userName}}</div>
          </x-else>

          <p-button
            icon
            size="small"
            variant="text"
            on:click="renameMode = true"
            class:hide="renameMode"
            style="margin-left: 8px"
          >
            <n-local-icon name="edit"></n-local-icon>
          </p-button>
        </p-table-cell>
      </p-table-row>
      <p-table-row>
        <p-table-cell col-width="120">用户ID</p-table-cell>
        <p-table-cell> {{userID}} </p-table-cell>
      </p-table-row>
      <p-table-row>
        <p-table-cell col-width="120">签名公钥</p-table-cell>
        <p-table-cell>
          <div class="row-val" attr:title="signPublic">{{signPublic}}</div>
        </p-table-cell>
      </p-table-row>
      <p-table-row>
        <p-table-cell col-width="120">加密公钥</p-table-cell>
        <p-table-cell>
          <div class="row-val" attr:title="encryPublic">{{encryPublic}}</div>
        </p-table-cell>
      </p-table-row>
      <p-table-row>
        <p-table-cell col-width="120">签名</p-table-cell>
        <p-table-cell>
          <div class="row-val" attr:title="encryPublic">{{signStr}}</div>
        </p-table-cell>
      </p-table-row>
    </p-table>

    <h5>服务器地址</h5>
    <x-fill :value="servers">
      <div class="server-line">
        <div>{{$data.id}}</div>
        <span style="color: #aaa">{{$data.serverUrl}}</span>
        <button on:click="$host.connectServer($data)">连接服务器</button>
      </div>
    </x-fill>
  </div>
  <script>
    import {
      getUserInfo,
      getUserInfoSign,
    } from "/packages/none-os/user/main.js";

    import { servers } from "/packages/none-os/user/connect.js";

    export const parent = "../outer.html";

    export default async ({ load }) => {
      const data = await getUserInfo();

      return {
        data: {
          userID: data.userID,
          userName: data.userName || data.backupUserName,
          signPublic: data.signPublic,
          encryPublic: data.encryPublic,
          renameMode: false,
          signStr: "",
          // 可连接的服务器
          servers: [],
        },
        watch: {
          renameMode(bool) {
            if (bool) {
              setTimeout(() => {
                this.shadow.$("#renameInputer") &&
                  this.shadow.$("#renameInputer").ele.focus();
              }, 100);
            }
          },
          async userName() {
            // 修正签名
            this.signStr = await getUserInfoSign();
          },
        },
        proto: {
          renameEnd(e) {
            this.renameMode = false;
            localStorage.__username = this.userName;
          },
          refreshServer() {
            this.servers = servers.map((e) => {
              return {
                id: e.id,
                serverUrl: e.serverUrl,
                _server: e,
              };
            });
          },
          connectServer(data) {
            debugger;
          },
        },
        attached() {
          this.refreshServer();
        },
      };
    };
  </script>
</template>
