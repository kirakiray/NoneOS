!function(e){"use strict";const t={pathEmpty:"文件路径不能为空",indexErr:"在数据库{dbname}的{storename}表中没有找到索引{key}",setDataErr:"设置数据出错",findDataErr:"查找数据出错",getDataErr:"获取数据出错",rootEmpty:"不允许使用 '/' 开头的路径",rootNotExist:"根目录 {rootname} 不存在",pathNotFound:"未找到文件夹:{path}",storeNotExistMethod:"store中不存在方法 {method}",invalidCreateType:"create必须等于'file'或'dir'",notDeleteRoot:"不能直接删除根节点{name}",deleted:"当前handle已被删除，不能使用{name}；旧地址为:{path}",exitedName:"操作失败，{name}已经存在",tolowcase:"文件系统对大小写不敏感，{oldName}将会被转为{newName}",writefile:"写入文件内容失败:{path}",noPicker:"当前浏览器不支持文件选择",targetAnotherType:"{path} 已经是一个'{exitedType}'，不能创建为'{targetType}'",notMoveToChild:"{targetPath} 是 {path} 的子目录，不能移动到自己的子目录",notFoundChunk:"{path}文件没有找到对应的块文件:{hash}"},a=(e,a,r)=>{let n,s=t[e];if(a)for(let e in a)s=s.replace(new RegExp(`{${e}}`,"g"),a[e]);return n=r?new Error(s,{cause:r}):new Error(s),n.code=e,n},r={};function n(e=10){const t=new Uint8Array(e);return crypto.getRandomValues(t),Array.from(t,(e=>("0"+e.toString(32)).slice(-2))).join("")}const s=async(e="noneos_fs_defaults")=>(r[e]||(r[e]=new Promise((t=>{const a=indexedDB.open(e);a.onsuccess=async a=>{const n=a.target.result;n.onclose=()=>{r[e]=null},t(n)},a.onupgradeneeded=e=>{const t=e.target.result,a=t.createObjectStore("main",{keyPath:"key"});a.createIndex("parent","parent",{unique:!1}),a.createIndex("parent_and_name",["parent","name"],{unique:!0}),a.createIndex("hash","hash",{unique:!1}),t.createObjectStore("blocks",{keyPath:"hash"})},a.onerror=t=>{throw new Event(e+" creation error",{cause:t.error})}}))),r[e]),i=async({dbname:e="noneos_fs_defaults",storename:t="main",index:r,all:n=!1,method:i="get",key:o})=>{let c=await(async({storename:e,index:t,dbname:r})=>{let n=(await s(r)).transaction([e],"readonly").objectStore(e);if(t)try{n=n.index(t)}catch(n){throw a("indexErr",{dbname:r,storename:e,key:t},n)}return n})({storename:t,index:r,dbname:e});if(!c[i])throw a("storeNotExistMethod",{method:i});return new Promise(((e,t)=>{c=c[i](o),c.onsuccess=t=>{e(t.target.result)},c.onerror=e=>{t(a("getDataErr",null,e.target.error))}}))},o=new Map,c=async({dbname:e="noneos_fs_defaults",storename:t="main",datas:r,removes:n})=>{if(!r?.length&&!n?.length)return!0;const i=await s(e);return new Promise(((e,s)=>{const c=i.transaction([t],"readwrite");c.oncomplete=t=>{r&&r.forEach((e=>{e.parent&&o.delete(`${e.parent}-${e.name}`)})),e(!0)},c.onerror=e=>{s(a("setDataErr",null,e.target.error))};const h=c.objectStore(t);r&&r.forEach((e=>{if(e.parent){const t=o.get(`${e.parent}-${e.name}`);if(t){const a=t;Object.assign(e,a)}else o.set(`${e.parent}-${e.name}`,e)}h.put(e)})),n&&n.length&&n.forEach((e=>h.delete(e)))}))},h=async e=>{const t=[];await Promise.all(e.map((async e=>{!await i({index:"hash",key:e})&&t.push(e)}))),t.length&&await c({storename:"blocks",removes:t})},l=async(e,t)=>{const r=await i({key:e.id});if(!r)throw a("deleted",{name:t,path:e.path},e);return r},u=async e=>{const t=[],a=Date.now();let r=e;for(;r;){const e=await i({key:r});if(!e)break;e.lastModified=a,t.push(e),r=e.parent}await c({datas:t})},p=async({source:e,target:t,name:a,callback:r})=>{if([t,a]=await f({target:t,name:a,self:e}),"file"===e.kind){const n=await e.file(),s=await t.get(a,{create:"file"});return await s.write(n,r),s}if("dir"===e.kind){const n=await t.get(a,{create:"dir"});return await e.forEach((async e=>{await p({source:e,target:n,name:e.name,callback:r})})),n}},f=async({target:e,name:t,self:r})=>{"string"==typeof e&&(t=e,e=await r.parent()),t||(t=r.name);let n=!1;for await(let a of e.keys())if(t===a){n=1;break}if(n)throw a("exitedName",{name:`${t}(${e.path}/${t})`});if(function(e,t){if(e===t)return!1;const a=t.split("/").filter((e=>e.length)),r=e.split("/").filter((e=>e.length));return a.every(((e,t)=>r[t]===e))}(e.path,r.path))throw a("notMoveToChild",{targetPath:e.path,path:r.path});return[e,t]};const w=async e=>{if("file"===e.kind)return[await d(e)];const t=[];for await(let a of e.values())if("dir"===a.kind){const e=await w(a);t.push(...e)}else t.push(await d(a));return t},d=async e=>{const t={size:await e.size(),path:e.path};return Object.defineProperty(t,"handle",{get:()=>e}),t},m=1048576,y=async(e,t=1048576)=>{let a;if("string"==typeof e)a=(new TextEncoder).encode(e).buffer;else if(e instanceof File)a=await e.arrayBuffer();else if(e instanceof ArrayBuffer)a=e;else{if(!(e instanceof Uint8Array))throw new Error("Input must be a string, File object or ArrayBuffer object");a=e.buffer}const r=[];for(let e=0;e<a.byteLength;e+=t){const n=a.slice(e,e+t);r.push(n)}return r},g=async e=>{if("string"==typeof e){e=(new TextEncoder).encode(e)}const t=await crypto.subtle.digest("SHA-256",e),a=Array.from(new Uint8Array(t)).map((e=>e.toString(16).padStart(2,"0"))).join(""),r=Math.floor(e.byteLength/2);return a+new Uint8Array(e.slice(r,r+1))[0].toString(16)},b=Symbol("storage-name"),k=Symbol("idb");class x{constructor(e="public"){return this[b]="main",this[k]=new Promise((t=>{let a=indexedDB.open(`ever-cache-${e}`);a.onsuccess=e=>{t(e.target.result)},a.onupgradeneeded=e=>{e.target.result.createObjectStore("main",{keyPath:"key"})}})),new Proxy(this,E)}async setItem(e,t){return $(this,(a=>a.put({key:e,value:t}))).then((()=>!0))}async getItem(e){try{return $(this,(t=>t.get(e)),"readonly").then((e=>{const{result:t}=e.target;return t?t.value:null}))}catch(e){}}async removeItem(e){return $(this,(t=>t.delete(e))).then((()=>!0))}async clear(){return $(this,(e=>e.clear())).then((()=>!0))}async key(e){return $(this,(e=>e.getAllKeys())).then((t=>t.target.result[e]))}get length(){return $(this,(e=>e.count())).then((e=>e.target.result))}entries(){return{[Symbol.asyncIterator]:()=>{let e,t;const a=()=>{t=new Promise((t=>e=t))};return a(),$(this,(e=>e.openCursor()),"readonly",(t=>e(t.target.result))),{async next(){const e=await t;if(!e)return{done:!0};a();const{key:r,value:n}=e.value;return e.continue(),{value:[r,n],done:!1}}}}}}async*keys(){for await(let[e,t]of this.entries())yield e}async*values(){for await(let[e,t]of this.entries())yield t}}const v=new Set(Object.getOwnPropertyNames(x.prototype)),E={get:(e,t,a)=>v.has(t)||"symbol"==typeof t?Reflect.get(e,t,a):e.getItem(t),set:(e,t,a)=>e.setItem(t,a),deleteProperty:(e,t)=>e.removeItem(t)},$=async(e,t,a="readwrite",r)=>{const n=await e[k];return new Promise(((s,i)=>{const o=t(n.transaction([e[b]],a).objectStore(e[b]));o.onsuccess=e=>{if(r){const t=r(e);t&&s(t)}else s(e)},o.onerror=e=>{i(e)}}))};new x;const T=new x("remote-file-cache"),j=async e=>{const t=await T.getItem(e);return t&&T.setItem(`${e}-time`,Date.now()),t},P={},C={},D=async()=>{const e=Date.now();for await(let[t,a]of T.entries())if(/-time$/.test(t)&&e-a>3e5){const e=t.replace("-time","");T.removeItem(e),T.removeItem(t)}setTimeout(D,6e4)};D();const _=async(t,a)=>{const r=await j(t);return r||new Promise((a=>{let r,n=()=>{e.users[0]._send({type:"getCache",hashs:[t]}),r=setTimeout((()=>{n()}),4e3)};(async e=>{const t=await j(e);return t||(P[e]||(P[e]=new Promise((t=>{C[e]=t}))))})(t).then((e=>{clearTimeout(r),n=null,a(e)})),n()}))};class I{constructor(){}async flat(){return w(this)}async _saveCache(e){const t=e.size,{options:a,returnHashs:r}=e,n=await this.buffer(a),s=await y(n,t),i=[];return await Promise.all(s.map((async(e,t)=>{const a=await g(e);i[t]=a,await((e,t)=>{T.setItem(e,t),T.setItem(`${e}-time`,Date.now()),P[e]&&(C[e](t),delete P[e],delete C[e])})(a,e)}))),!r||i}async _writeByCache(e){const{hashs:t}=e,a=await Promise.all(t.map((async e=>_(e)))),r=await this.createWritable();for(let e of a)await r.write(e);return r.close(),!0}async _getHashs(e){const t=(e=e||{}).size||131072,a=await this.buffer(),r=await y(a,t);return await Promise.all(r.map((async e=>await g(e))))}async _mergeChunk(e,t){const a=await(await this.root()).get(t);if(!a)throw new Error("没有找到缓冲目录");const r=await this.createWritable();for(let t of e){const e=await a.get(t);if(!e){const e=get("notFoundChunk",{path:item.path,hash:t});throw console.error(e),await r.abort(),e}const n=await e.buffer();await r.write(n)}return await r.close(),!0}}class A extends I{#e;#t;#a;#r;#n;#s;constructor(e,t){super(),this.#e=e,this.#t=t}get id(){return this.#e}get path(){return this.#a}get name(){return this.#r}get kind(){return this.#t}get createTime(){return this.#n}get lastModified(){return this.#s||null}async root(){let e=await l(this,"root");for(;"root"!==e.parent;)e=await i({key:e.parent});const t=await new N(e.key);return await t.refresh(),t}async parent(){const e=await l(this,"parent");if("root"===e.parent)return null;const t=new N(e.parent);return await t.refresh(),t}async moveTo(e,t){[e,t]=await f({target:e,name:t,self:this});const a=await l(this,"move");a.parent=e.id,a.name=t.toLowerCase(),a.realName=t,await c({datas:[a]}),await this.refresh()}async copyTo(e,t,a){if([e,t]=await f({target:e,name:t,self:this}),!(e instanceof A))return p({source:this,target:e,name:t,callback:a});let r;switch(this.kind){case"dir":r=await e.get(t,{create:"dir"});for await(let[e,t]of this.entries())await t.copyTo(r,e);break;case"file":r=await e.get(t,{create:"file"});const a=await l(this,"move"),n=await i({key:r.id}),s=n.hashs=a.hashs;await c({datas:[{...a,...n},...s.map(((e,t)=>({key:`${n.key}-${t}`,hash:e,type:"block"})))]})}return await u(e.id),r}async remove(e){const t=await l(this,"remove");if("root"===t.parent)throw a("notDeleteRoot",{name:this.name});"dir"===this.kind&&await this.forEach((async t=>{await t.remove(e)}));const r=t.hashs||[],n=[t.key];r.forEach(((e,a)=>{n.push(`${t.key}-${a}`)})),await c({removes:n}),r.length&&await h(r),e&&e({type:"remove",path:this.path})}async refresh(){const e=await l(this,"refresh");this.#n=e.createTime,this.#s=e.lastModified,this.#r=e.realName||e.name;const t=[e.realName||e.name];let a=e;for(;"root"!==a.parent;)a=await i({key:a.parent}),t.unshift(a.realName||a.name);this.#a=t.join("/")}async size(){const e=await l(this,"size");if("file"===e.type)return e.size}toJSON(){const e={};return["createTime","id","kind","lastModified","name","path"].forEach((t=>{e[t]=this[t]})),e}get _mark(){return"db"}}class L extends A{constructor(e){super(e,"file")}async write(e,t){const a=await this.createWritable(),r=e.length||e.size||e.byteLength||0,n=Math.ceil(r/m);a.onbeforewrite=e=>{t&&t({...e,length:n,type:"write-file-start"})},a.onwrite=e=>{t&&t({...e,length:n,type:"write-file-end"})},await a.write(e),await a.close()}async createWritable(){return new M(this.id,this.path)}async read(e,t){const a=await l(this,"读取数据"),{hashs:r}=a;let n=[];if(t&&(t.start||t.end)){let e=Math.floor(t.start/m),a=Math.floor(t.end/m);n=await Promise.all(r.map((async(r,n)=>{let s;if(n>=e&&n<=a){s=(await i({storename:"blocks",key:r})).chunk,e===a?s=s.slice(t.start-n*m,t.end-n*m):n===e?s=s.slice(-1*((e+1)*m-t.start)):n===a&&(s=s.slice(0,t.end-a*m))}return s}))),n=n.filter((e=>!!e))}else r&&(n=await Promise.all(r.map((async(e,t)=>{const{chunk:a}=await i({storename:"blocks",key:e});return a}))));const s=(e=>{const t=e.reduce(((e,t)=>e+t.byteLength),0),a=new Uint8Array(t);let r=0;return e.forEach((e=>{a.set(new Uint8Array(e),r),r+=e.byteLength})),a})(n);return(({buffer:e,type:t,data:a,isChunk:r})=>"text"===t?(new TextDecoder).decode(e):"file"===t?r?new Blob([e.buffer]):new File([e.buffer],a.name,{lastModified:a.lastModified}):"base64"===t?new Promise((t=>{const r=new File([e.buffer],a.name),n=new FileReader;n.onload=()=>{t(n.result)},n.readAsDataURL(r)})):e.buffer)({buffer:s,type:e,data:a,isChunk:t?.start||t?.end})}file(e){return this.read("file",e)}text(e){return this.read("text",e)}buffer(e){return this.read("buffer",e)}base64(e){return this.read("base64",e)}}class M{#i;#o=new ArrayBuffer;#c=[];#h=0;#a;constructor(e,t){this.#i=e,this.#a=t}async write(e){let t;for("string"==typeof e?t=(new TextEncoder).encode(e).buffer:e instanceof File?t=await e.arrayBuffer():e instanceof ArrayBuffer&&(t=e),this.#h+=t.byteLength,this.#o=function(e,t){const a=e.byteLength+t.byteLength,r=new ArrayBuffer(a),n=new Uint8Array(r);return n.set(new Uint8Array(e),0),n.set(new Uint8Array(t),e.byteLength),r}(this.#o,t);this.#o.byteLength>m;){const e=this.#o.slice(0,m);this.#o=this.#o.slice(m);const t=await this._writeChunk(e);this.#c.push(t)}}async _writeChunk(e){const t=await g(e),a=await i({storename:"blocks",key:t}),r={path:this.#a,index:this.#c.length,hash:t,exited:a};return this.onbeforewrite&&this.onbeforewrite({type:"onbeforewrite",...r}),a||await c({storename:"blocks",datas:[{hash:t,chunk:e}]}),this.onwrite&&this.onwrite({type:"onwrite",...r}),t}async close(){const e=await l({id:this.#i},"write");if(e){if(this.#o.byteLength>0){const e=await this._writeChunk(this.#o);this.#c.push(e)}{const t=e.hashs||[],a=this.#c,r=this.#h,n=[];for(let e=0;e<t.length;e++)e>=a.length&&n.push(`${this.#i}-${e}`);await c({datas:[{...e,lastModified:Date.now(),hashs:a,size:r},...a.map(((e,t)=>({type:"block",key:`${this.#i}-${t}`,hash:e})))],removes:n}),t.length&&await h(t),await u(e.parent)}}else await this.abort()}async abort(){this.#c&&await h(this.#c)}}class N extends A{constructor(e){super(e,"dir")}async get(e,t){await l(this,"get");const r=e.split("/");if(t&&t.create&&"file"!==t.create&&"dir"!==t.create)throw a("invalidCreateType");let s=this;if(r.length>1)for(const e of r.slice(0,-1)){let r=s;if(s=await s.get(e,{create:t?.create?"dir":void 0}),!s)throw await r.refresh(),a("pathNotFound",{path:r.path+"/"+e})}let o=r.slice(-1)[0],h=await i({index:"parent_and_name",key:[s.id,o.toLowerCase()]});if(t&&t.create&&!h){const e=Date.now();h={createTime:e,lastModified:e,key:n(),realName:o,name:o.toLowerCase(),parent:s.id,type:t.create},await c({datas:[h]}),await u(s.id)}if(t&&t.create&&t.create!==h.type)throw a("targetAnotherType",{path:s.path+"/"+o,exitedType:h.type,targetType:t.create});return await z(h)}async*keys(){l(this,"keys");const e=await S(this.id);for(let t of e)yield t.name}async*entries(){l(this,"entries");const e=await S(this.id);for(let t of e)yield[t.name,await z(t)]}async*values(){l(this,"values");for await(let[,e]of this.entries())yield e}async forEach(e){l(this,"forEach");const t=await S(this.id);let a=0;for(let r of t)await e(await z(r),a),a++}async length(){l(this,"length");return await i({key:this.id,index:"parent",method:"count"})}}const S=async e=>await i({key:e,index:"parent",method:"getAll"}),z=async e=>{let t=null;if(e){switch(e.type){case"dir":t=new N(e.key);break;case"file":t=new L(e.key)}await t.refresh()}return t},U=(async()=>{await(async e=>{await i({index:"parent_and_name",key:["root",e]})||await c({datas:[{key:n(),parent:"root",name:e,createTime:Date.now()}]})})("local")})(),R=async(e,t)=>{const r=e.split("/");if(!r.length)throw a("pathEmpty");if(""===r[0])throw a("rootEmpty");await U;const n=await i({index:"parent_and_name",key:["root",r[0]]});if(!n)throw a("rootNotExist",{rootname:r[0]});const s=new N(n.key);return 1===r.length?(await s.refresh(),s):s.get(r.slice(1).join("/"),t)},O=async({request:e})=>{const{pathname:t}=new URL(e.url),a=decodeURIComponent(t.replace(/^\/\$\//,"")),r=a.split("/");if(!(3!==r.length||"apps"!==r[0]&&"packages"!==r[0]||"app"!==r[2]&&"appdebug"!==r[2]))return B({pathname:t,path:a});const n=await R(a);let s=await n.file();const i={},o=a.split(".").pop();return/^\/\$\/apps\//.test(t)&&"html"===o&&"index.html"===n.name?i["Content-Type"]="text/html; charset=utf-8":i["Content-Type"]=(e=>{switch(e){case"html":case"htm":case"txt":case"md":return"text/plain; charset=utf-8";case"js":case"mjs":return"application/javascript; charset=utf-8";case"json":return"application/json; charset=utf-8";case"css":return"text/css; charset=utf-8";case"xml":return"application/xml; charset=utf-8";case"svg":return"image/svg+xml; charset=utf-8";case"csv":return"text/csv; charset=utf-8";case"ics":return"text/calendar; charset=utf-8";case"pdf":return"application/pdf; charset=utf-8";case"doc":case"docx":return"application/msword; charset=utf-8";case"xls":case"xlsx":return"application/vnd.ms-excel; charset=utf-8";case"ppt":case"pptx":return"application/vnd.ms-powerpoint; charset=utf-8";case"zip":return"application/zip; charset=utf-8";case"gz":return"application/gzip; charset=utf-8";case"tar":return"application/x-tar; charset=utf-8";case"jpg":case"jpeg":return"image/jpeg";case"png":return"image/png";case"gif":return"image/gif";case"bmp":case"bmp":return"image/bmp";case"ico":return"image/x-icon";case"webp":return"image/webp";case"mp3":return"audio/mpeg";case"wav":return"audio/wav";case"mp4":case"m4v":return"video/mp4";case"mov":return"video/quicktime";case"avi":return"video/x-msvideo";default:return"application/octet-stream"}})(o),new Response(s,{status:200,headers:i})},B=async({pathname:e,path:t})=>{let a;const r=t.split("/"),n=r.slice(0,-1).join("/"),s="appdebug"===r.slice(-1)[0];try{a=await R(`${n}/app.json`),a=JSON.parse(await a.text())}catch(e){a=await fetch(`/${n}/app.json`).then((e=>e.json()))}return new Response(`<!DOCTYPE html>\n<html lang="en">\n  <head>\n    <meta charset="UTF-8" />\n    <meta name="apple-mobile-web-app-capable" content="yes" />\n    <meta name="mobile-web-app-capable" content="yes" />\n    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />\n    <title>${a.name}</title>\n    <link rel="shortcut icon" href="${a.icon}">\n    <link rel="apple-touch-icon" href="${a.icon}" />\n    <script src="/packages/ofa/ofa.js"${s?" debug":""}><\/script>\n    <script src="/packages/ofa/router.min.js"><\/script>\n    <script src="/packages/pui/init.js" type="module"><\/script>\n    <style>\n      html,\n      body {\n        margin: 0;\n        padding: 0;\n        height: 100%;\n      }\n\n      o-app {\n        height: 100%;\n      }\n    </style>\n  </head>\n  <body>\n    <o-router fix-body>\n      <o-app src="${a.config}"></o-app>\n    </o-router>\n    <o-root-provider name="pui" theme="dark"></o-root-provider>\n    <o-root-provider name="clipboard" type="no"></o-root-provider>\n  </body>\n</html>\n    `,{status:200,headers:{"Content-Type":"text/html; charset=utf-8"}})};self.addEventListener("fetch",(e=>{const{request:t}=e,{pathname:a,origin:r}=new URL(t.url);location.origin===r&&("/"===a||"/index.html"===a?e.respondWith((async e=>{const t=await caches.open("noneos-default-cache");let a=await t.match(e);return a?a.clone():(a=await fetch(e),200===a.status&&t.put(e,a.clone()),a)})(a)):/^\/\$/.test(a)?e.respondWith((async()=>{try{return await O({request:t})}catch(e){return console.error(e),new Response(e.stack||e.toString(),{status:404})}})()):/^\/packages\//.test(a)&&e.respondWith((async()=>{try{return await O({request:{url:`${r}/$${a}`}})}catch(e){return fetch(t.url)}})()))})),self.addEventListener("install",(()=>{self.skipWaiting(),console.log("NoneOS installation successful")})),self.addEventListener("activate",(()=>{self.clients.claim(),console.log("NoneOS server activation successful")}))}({});
