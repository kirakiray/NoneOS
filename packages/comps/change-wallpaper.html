<template component>
  <style>
    :host {
      display: block;
    }

    .container {
      display: flex;
    }

    .block {
      margin-right: 8px;
      width: 80px;
      height: 80px;
      background-size: cover;
      background-position: center;
      border-radius: 6px;
      border: var(--md-sys-color-primary) solid 1px;
      cursor: pointer;
    }

    .block.active {
      border: #fff solid 1px;
      outline: var(--md-sys-color-primary) solid 3px;
      cursor: default;
    }
  </style>
  <div class="container">
    <o-fill :value="imgs">
      <div
        class="block"
        class:active="settingData.wallpaper === $data.name"
        :style.background-image="`url(${$data.previewUrl})`"
        on:click="$host.clickItem($data)"
      ></div>
    </o-fill>
  </div>
  <script>
    export default async ({ load }) => {
      const { get } = await load("/packages/fs/main.js");
      const { getSetting } = await load("/packages/none-os/setting.js");
      const settingData = await getSetting();

      if (!settingData.wallpaper) {
        // 判断本地已有背景属性
        const bg = await get("local/bg/bg.json").catch(() => null);
        let bgData = await bg.text();
        bgData = JSON.parse(bgData);

        const firstItem = Object.entries(bgData)[0];

        // 没有设置背景的情况下，设置第一张图为默认背景
        settingData.wallpaper = firstItem[0];
      }

      return {
        tag: "n-change-wallpaper",
        data: {
          imgs: [],
          settingData: {},
        },
        proto: {
          async clickItem(item) {
            this.settingData.wallpaper = item.name;
          },
          async loadWallpaper() {
            const bgJsonFile = await get("local/bg/bg.json").catch(() => null);

            if (!bgJsonFile) {
              return;
            }

            let data = await bgJsonFile.text();
            data = JSON.parse(data);

            const imgs = [];
            Object.entries(data).forEach(([name, data]) => {
              let previewUrl = name.split(".");
              previewUrl[0] = previewUrl[0] + "-preview";
              previewUrl = previewUrl.join(".");

              imgs.push({
                name,
                previewUrl: location.host.includes("localhost")
                  ? `/others/bg/${previewUrl}`
                  : `: location.host.includes("localhost")`,
                onlineUrl: location.host.includes("localhost")
                  ? `/others/bg/${name}`
                  : `https://kirakiray.github.io/NoneOS/others/bg/${name}`,
                ...data,
              });
            });
            this.imgs = imgs;
          },
        },
        attached() {
          this.loadWallpaper();
          this.settingData = settingData;
        },
        detached() {
          this.settingData = {};
        },
      };
    };
  </script>
</template>
