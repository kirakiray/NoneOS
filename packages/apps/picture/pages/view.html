<template page>
  <l-m src="/packages/local-icon/local-icon.html"></l-m>
  <style>
    :host {
      display: block;
      background-color: var(--md-sys-color-surface);
    }

    .container {
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .top-tool,
    .bottom-tool {
      display: flex;
      justify-content: center;
      align-items: center;
      height: 30px;
      font-size: 12px;
      background-color: var(--md-sys-color-on-normal);
    }

    .top-tool {
      text-align: center;
      background-color: var(--md-sys-color-surface);
    }

    .title {
      text-align: center;
      user-select: text;
      padding: 0 12px;
      font-size: 14px;
    }

    .main {
      position: relative;
      flex: 1;
    }

    .img-area {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .img-area img {
      display: block;
      max-width: 100%;
      max-height: 100%;
    }

    .tool-block {
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 0 16px;
      color: var(--md-sys-color-normal);
      line-height: 16px;
    }
    .tool-block n-local-icon {
      display: block;
      font-size: 18px;
      margin-right: 4px;
    }
    .tool-block + .tool-block {
      border-left: var(--md-sys-color-normal) solid 1px;
    }
  </style>
  <div class="container">
    <div class="top-tool">
      <div class="title">{{imgName}}</div>
    </div>
    <div class="main">
      <div class="img-area">
        <img class="main-img" />
      </div>
    </div>
    <div class="bottom-tool">
      <div class="tool-block">
        <n-local-icon name="magnifier" style="font-size: 14px"></n-local-icon>
        {{scale}}%
      </div>
      <div class="tool-block">
        <n-local-icon name="size"></n-local-icon>
        {{naturalWidth}} × {{naturalHeight}}
      </div>
      <div class="tool-block">
        <n-local-icon name="save"></n-local-icon>
        {{imgSize}}
      </div>
    </div>
  </div>
  <script>
    export default async ({ load, query }) => {
      const { path } = query;

      const { get } = await load("/packages/fs/main.js");

      return {
        data: {
          path,
          imgsrc: "", // 图片地址
          imgName: "", // 图片名称
          imgSize: "-", // 图片大小
          naturalWidth: "-", // 图片宽度
          naturalHeight: "-", // 图片高度
          originScale: 100, // 图片原始缩放比
          // scale: "-", // 图片缩放比
        },
        proto: {
          onresize() {
            this.resetScale();
          },
          get scale() {
            return this.originScale;
          },
          // 重制尺寸缩放
          resetScale() {
            // // 获取容器的尺寸
            // const containerWidth = this.shadow.$(".container").ele.clientWidth;
            // const containerHeight =
            //   this.shadow.$(".container").ele.clientHeight;
            // const { naturalWidth, naturalHeight } = this;
            // // 图片的最终大小，不能超过容器的尺寸
            // let finnalWidth = naturalWidth,
            //   finnalHeight = naturalHeight;
            // if (finnalWidth > containerWidth) {
            //   finnalWidth = containerWidth;
            //   finnalHeight = (finnalWidth / naturalWidth) * naturalHeight;
            // }
            // if (finnalHeight > containerHeight) {
            //   finnalHeight = containerHeight;
            //   finnalWidth = (finnalHeight / naturalHeight) * naturalWidth;
            // }
            // Object.assign(this.shadow.$(".main-img").style, {
            //   width: finnalWidth + "px",
            //   heighe: finnalHeight + "px",
            // });

            // 获取图片在容器内的尺寸
            const containerImgWidth = this.shadow.$(".container .main-img").ele
              .clientWidth;

            // 计算当前的缩放比
            this.originScale = (
              (containerImgWidth / this.naturalWidth) *
              100
            ).toFixed(2);
          },
          // 加载图片
          async loadImg() {
            const handle = await get(path).catch(() => null);

            if (handle) {
              this.imgName = handle.name;

              const file = await handle.file();
              this.imgSize = formatBytes(file.size);

              const newUrl = URL.createObjectURL(file);

              if (this.imgsrc) {
                URL.revokeObjectURL(this.imgsrc);
              }

              this.imgsrc = newUrl;

              const mainImg = this.shadow.$(".main-img");
              mainImg.attr("src", newUrl);

              await mainImg.ele.decode();

              this.naturalWidth = mainImg.ele.naturalWidth;
              this.naturalHeight = mainImg.ele.naturalHeight;

              this.resetScale();
              return;
            }

            // TODO: 没有找到对应的图片
            debugger;
          },
        },
        ready() {
          let transScale = 1;
          // 移动光标
          this.on("wheel", (e) => {
            e.preventDefault();

            const { deltaY } = e;

            // 按照滚轮的移动方向缩放图片
            console.log("wheel", deltaY);
          });
        },
        attached() {
          this.loadImg();
        },
        detached() {},
      };
    };

    function formatBytes(bytes) {
      if (!bytes) {
        return bytes;
      }

      const units = ["B", "KB", "MB", "GB", "TB", "PB"];
      let i = 0;
      while (bytes >= 1024 && i < units.length - 1) {
        bytes /= 1024;
        i++;
      }

      return `${bytes.toFixed(2)} ${units[i]}`;
    }
  </script>
</template>
