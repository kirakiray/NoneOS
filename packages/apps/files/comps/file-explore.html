<template component>
  <l-m src="../comps/file-list.html"></l-m>
  <l-m src="/packages/pui/progress/progress.html"></l-m>
  <l-m src="/packages/pui/menu/bind-contextmenu.html"></l-m>
  <l-m src="/packages/pui/menu/menu.html"></l-m>
  <style>
    :host {
      display: block;
      height: 100%;
    }

    .container {
      position: relative;
      flex: 1;
      display: flex;
      flex-direction: column;
      height: 100%;
    }

    .container > * {
      z-index: 2;
    }

    .abs-over {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
    }

    .center-box {
      display: flex;
      justify-content: center;
      align-items: center;
      font-size: 14px;
      padding: 60px 16px;
      color: #7b7b7b;
    }

    .main {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow-y: auto;
    }

    .main-menu {
      width: 120px;
      z-index: 2;
    }

    .main-menu n-local-icon {
      display: block;
      margin-right: 8px;
    }
  </style>

  <div class="container" on:select-files="selecteds = $event.data.selecteds">
    <p-bind-contextmenu class="main" auto-close>
      <div
        class="other-area abs-over"
        on:click="clickOther"
        on:contextmenu="clickOther"
        style="z-index: 1"
      ></div>
      <n-file-list
        :files="files"
        on:rename-file="renameFile"
        :search="search"
      ></n-file-list>
      <p-menu class="main-menu" contextmenu-selector="n-file-list">
        <p-menu-item>
          <n-local-icon name="cut" slot="prefix"></n-local-icon>
          剪切
        </p-menu-item>
        <p-menu-item>
          <n-local-icon name="copy" slot="prefix"></n-local-icon>
          复制
        </p-menu-item>
        <p-menu-item disabled>
          <n-local-icon name="paste" slot="prefix"></n-local-icon>
          粘贴
        </p-menu-item>
        <p-menu-item>
          <n-local-icon name="rename" slot="prefix"></n-local-icon>
          重命名
        </p-menu-item>
        <p-menu-item>
          <n-local-icon name="delete" slot="prefix"></n-local-icon>
          删除
        </p-menu-item>
        <hr />
        <p-menu-item>
          <n-local-icon name="export" slot="prefix"></n-local-icon>
          导出文件
        </p-menu-item>
      </p-menu>

      <p-menu class="main-menu" contextmenu-selector=".other-area">
        <p-menu-item>
          <n-local-icon name="reload" slot="prefix"></n-local-icon>
          刷新
        </p-menu-item>
        <p-menu-item>
          <n-local-icon name="import-file" slot="prefix"></n-local-icon>
          导入文件
        </p-menu-item>
        <p-menu-item>
          <n-local-icon name="import-dir" slot="prefix"></n-local-icon>
          导入文件夹
        </p-menu-item>
      </p-menu>
    </p-bind-contextmenu>
    <x-if :value="loading">
      <div class="center-box">
        <p-progress type="circle"></p-progress>
      </div>
    </x-if>
    <x-else-if :value="errorStr">
      <div class="center-box">{{errorStr}}</div>
    </x-else-if>
    <x-else-if :value="files.length === 0 && !loading">
      <div class="center-box">{{spaceData.emptyDir}}</div>
    </x-else-if>
  </div>

  <script>
    export default async ({ load }) => {
      const { get } = await load("/packages/fs/main.js");
      const { getSpaceData } = await load("/packages/i18n/data.js");

      return {
        tag: "n-file-explore",
        data: {
          path: "",
          files: [],
          loading: true,
          search: "",
          errorStr: null, // 报错
          spaceData: {},
          selecteds: [], // 选择的文件或文件夹
        },
        proto: {
          // async selectFiles(e) {
          //   this.selecteds = e.data.selecteds;
          // },
          // 加载文件
          async refreshFiles() {
            this.loading = true;

            const handle = await get(decodeURIComponent(this.path)).catch(
              (err) => err
            );

            if (handle instanceof Error) {
              this.errorStr = handle.toString();
              this.loading = false;
              return;
            }

            try {
              const files = [];

              if (!handle) {
                debugger;
              }

              await handle.forEach(async (item) => {
                files.push({
                  size: formatBytes(await item.size()),
                  id: item.id,
                  kind: item.kind,
                  name: item.name,
                  path: item.path,
                  createTime: new Date(item.createTime).toLocaleString(),
                  lastModified: item.lastModified
                    ? new Date(item.lastModified).toLocaleString()
                    : "",
                });
              });

              this.files = files;
              this.loading = false;
              this.errorStr = "";
            } catch (err) {
              this.errorStr = err.toString();
              console.error(err);
              this.loading = false;
              return;
            }
          },
          clickOther() {
            // 清空选择
            this.shadow.$("n-file-list").selectItem({});
          },
          async renameFile(e) {
            e.stopPropagation();

            const {
              data: { targetPath, newName },
            } = e;

            if (!targetPath) {
              return;
            }

            const handle = await get(targetPath);
            await handle.moveTo(newName);

            this.refreshFiles();
          },
        },
        watch: {
          path(path) {
            if (path) {
              this.refreshFiles();
            }
          },
        },
        attached() {
          this.spaceData = getSpaceData("files");
        },
        detached() {
          this.spaceData = {};
        },
      };
    };

    function formatBytes(bytes) {
      if (!bytes) {
        return bytes;
      }

      const units = ["B", "KB", "MB", "GB", "TB", "PB"];
      let i = 0;
      while (bytes >= 1024 && i < units.length - 1) {
        bytes /= 1024;
        i++;
      }

      return `${bytes.toFixed(2)} ${units[i]}`;
    }
  </script>
</template>
