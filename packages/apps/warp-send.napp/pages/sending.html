<template page>
  <l-m src="/packages/pui/progress/progress.html"></l-m>
  <l-m src="/packages/comps/local-icon/local-icon.html"></l-m>
  <style>
    :host {
      display: block;
    }
    .container {
      padding: 16px;
    }
  </style>

  <div class="container">
    <div>
      <div style="font-size: 14px; display: flex; align-items: center">
        <o-if :value="step === 1">
          正在计算文件
          <span style="color: var(--md-sys-color-primary)">
            {{calculatingHashFileName}}
          </span>
          的哈希值 ({{calculateHashCount}} / {{fileCount}})
        </o-if>
        <o-else>
          <n-local-icon
            name="tick-circle"
            style="
              display: block;
              margin-right: 4px;
              font-size: 20px;
              color: var(--md-sys-color-success);
            "
          ></n-local-icon>
          计算文件哈希值完成
        </o-else>
      </div>
      <p-progress
        :value="calculateHashCount / fileCount * 100"
        style="width: 100%; --progress-animation: none; margin-top: 4px"
      ></p-progress>
    </div>
    <div>
      <div
        style="
          font-size: 14px;
          display: flex;
          align-items: center;
          padding: 16px 0;
        "
      >
        <n-local-icon
          name="loading"
          style="display: block; margin-right: 4px; font-size: 20px"
        ></n-local-icon>
        开始发送文件
      </div>
    </div>
  </div>

  <script>
    export default async ({ load, query }) => {
      const { cacheFiles } = await load("./sent.html");
      const { startSendTask, prepareSendTask } = await load(
        "../util/task-manager.js"
      );

      const { to, tosession, localname } = query;

      const { createUser } = await load("/packages/user/main.js");
      const localUser = await createUser({
        user: query.localname,
      });

      await localUser.connectAllServers();

      return {
        data: {
          _files: [],
          step: 1, // 1: 计算hash值, 2: 发送文件，3: 完成
          calculatingHashFileName: null, // 正在计算hash的文件名
          calculateHashCount: 0, // 已计算hash的文件数量
          fileCount: cacheFiles.length, // 文件总数
        },
        proto: {
          async sendFiles({ taskHash, files }) {
            // 切换到发送步骤
            this.step = 2;

            // 通知对方接受文件
            const remoteUser = await localUser.connectUser(query.userId);

            const realFiles = files.map((e) => {
              return {
                name: e.name,
                size: e.size,
                hash: e.hash,
                hashes: e.hashes,
              };
            });

            const fileJSONString = JSON.stringify(realFiles);

            // 按照每份大小200kb裁剪发送到对面
            const chunkSize = 200 * 1024; // 200kb
            const chunkCount = Math.ceil(fileJSONString.length / chunkSize);

            for (let i = 0; i < chunkCount; i++) {
              const start = i * chunkSize;
              const end = start + chunkSize;

              // 给目标用户传播事件
              await remoteUser.trigger(`warp-send-radiate`, {
                type: "start-send",
                received: query.sessionId, // 目标用户的sessionId
                taskHash, // 任务的hash值
                filesPart: fileJSONString.slice(start, end),
                totalPart: chunkCount,
                partIndex: i,
              });
            }

            // 初始化发送任务
            await startSendTask({
              localUser,
              remoteUser,
              taskHash,
              files,
              callback: (e) => {
                debugger;
              },
            });
          },
        },
        async attached() {
          if (cacheFiles.length) {
            // 先准备发送任务前的数据计算
            const { files, taskHash } = await prepareSendTask(
              cacheFiles,
              ({ calculatingHashFileName, calculateHashCount }) => {
                // 更新进度
                this.calculatingHashFileName = calculatingHashFileName;
                this.calculateHashCount = calculateHashCount;
              }
            );

            // 进入发送环节
            this.sendFiles({ taskHash, files });

            // 清空待发送文件
            cacheFiles.splice(0, cacheFiles.length);
          }
        },
      };
    };
  </script>
</template>
