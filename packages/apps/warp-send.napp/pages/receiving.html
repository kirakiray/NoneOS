<template page>
  <l-m src="/packages/comps/local-icon/local-icon.html"></l-m>
  <l-m src="/packages/pui/progress/progress.html"></l-m>
  <l-m src="/packages/pui/list/list.html"></l-m>
  <l-m src="/packages/pui/button/button.html"></l-m>
  <style>
    :host {
      display: block;
    }
    p-list-item {
      animation: list-item-anime 0.2s ease-in-out;
    }
    @keyframes list-item-anime {
      0% {
        height: 0px;
      }
      100% {
        height: 36px;
      }
    }

    .tool-container {
      height: 36px;
      opacity: 1;
      transition: all 0.2s ease-in-out;
    }
    .tool-container.hide {
      height: 0;
      opacity: 0;
      pointer-events: none;
    }
  </style>

  <div class="tool-container" class:hide="!allOK" style="padding: 0 8px">
    <p-button variant="text" on:click="back">
      <n-local-icon name="back" slot="prefix"> </n-local-icon>
      返回
    </p-button>
    <p-button variant="outlined" on:click="download">
      <n-local-icon name="download" slot="prefix"> </n-local-icon>
      下载到本地
    </p-button>
  </div>

  <div style="display: flex; align-items: center; padding: 8px">
    <o-if :value="allOK">
      <n-local-icon
        name="tick-circle"
        style="
          display: block;
          margin-right: 4px;
          font-size: 20px;
          color: var(--md-sys-color-success);
        "
      ></n-local-icon>
    </o-if>
    <o-else>
      <n-local-icon
        name="loading"
        style="display: block; margin-right: 4px"
      ></n-local-icon>
    </o-else>
    <o-if :value="!allOK"> 正在接受文件 </o-if>
    <o-else> 文件接受完毕 </o-else>
    <span
      style="
        display: block;
        margin-left: 4px;
        font-size: 14px;
        color: var(--md-sys-color-primary);
      "
    >
      {{files.length}}/{{originFileData.length}}
    </span>
  </div>

  <p-list id="file-list">
    <o-fill :value="files" fill-key="fileHash">
      <p-list-item>
        <o-if :value="$data.done" slot="prefix">
          <n-local-icon
            name="tick-circle"
            style="
              display: block;
              font-size: 20px;
              margin-right: 8px;
              color: var(--md-sys-color-success);
            "
          ></n-local-icon>
        </o-if>
        <o-else slot="prefix">
          <n-local-icon
            name="file"
            style="
              display: block;
              font-size: 20px;
              margin-right: 8px;
              color: var(--md-sys-color-primary);
            "
          ></n-local-icon>
        </o-else>
        {{$data.name}}
        <p-progress
          :value="($data.loaded / $data.total) * 100"
          style="margin-top: 4px"
        ></p-progress>
      </p-list-item>
    </o-fill>
  </p-list>
  <script>
    export default async ({ load, query }) => {
      const { createUser } = await load("/packages/user/main.js");
      const { startReceiveTask, download } = await load(
        "../util/task-manager.js"
      );

      const localUser = await createUser({
        user: query.localname,
      });

      await localUser.connectAllServers();

      return {
        data: {
          files: [],
          originFileData: [],
          allOK: false,
        },
        proto: {
          download() {
            // 下载
            download(query.taskHash);
          },
        },
        async attached() {
          const { unsubscribe } = await startReceiveTask({
            localUser,
            remoteUser: await localUser.connectUser(query.userId),
            taskHash: query.taskHash,
            callback: (e) => {
              if (e.type === "init") {
                this.originFileData = e.data.files.map((e) => {
                  return {
                    name: e.name,
                    size: e.size,
                    hash: e.hash,
                    chunkLength: e.hashes.length,
                  };
                });

                return;
              }

              let targetItem = this.files.find(
                (item) => item.fileHash === e.fileHash
              );

              if (!targetItem) {
                this.files.unshift({
                  fileHash: e.fileHash,
                  name: e.name,
                  loaded: 0,
                  done: false,
                  total: e.total,
                });

                targetItem = this.files.find(
                  (item) => item.fileHash === e.fileHash
                );
              }

              if (e.type === "load-chunk") {
                targetItem.loaded = e.loaded;
              } else if (e.type === "save-file") {
                targetItem.loaded = targetItem.total;
                targetItem.done = true;

                if (this.files.length === this.originFileData.length) {
                  this.allOK = true;
                }
              }
            },
          });

          this._unsubscribe = unsubscribe;
          if (!this.ele.isConnected) {
            unsubscribe();
          }
        },
        detached() {
          this._unsubscribe && this._unsubscribe();
        },
      };
    };
  </script>
</template>
