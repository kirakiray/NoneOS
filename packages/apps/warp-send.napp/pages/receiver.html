<template page>
  <l-m src="/packages/comps/local-icon/local-icon.html"></l-m>
  <style>
    :host {
      display: block;
      height: 100%;
      margin: 0 auto;
    }
  </style>
  <div style="padding: 8px; text-align: center">
    <p style="display: flex; align-items: center; justify-content: center">
      <localized-content>
        <span lang="cn">正在等待接收来自其他设备的文件…</span>
        <span lang="en">Waiting for file from other device...</span>
        <span lang="ja">他のデバイスからのファイルを待っています...</span>
      </localized-content>
      <n-local-icon
        name="loading"
        style="margin-left: 8px; display: block"
      ></n-local-icon>
    </p>
    <p style="display: flex; align-items: center; justify-content: center">
      <localized-content>
        <span lang="cn">文件将默认保存在：</span>
        <span lang="en">Files will be saved to:</span>
        <span lang="ja">ファイルは既定で保存されます：</span>
      </localized-content>
      <strong style="color: var(--md-sys-color-primary); margin-left: 4px">
        <localized-content>
          <span lang="cn">浏览器缓存</span>
          <span lang="en">Browser Cache</span>
          <span lang="ja">ブラウザキャッシュ</span>
        </localized-content>
      </strong>
      <o-if :value="canUsePicker">
        <p-button variant="outlined" size="small" style="margin-left: 8px">
          <localized-content>
            <span lang="cn">更改保存目录</span>
            <span lang="en">Change Directory</span>
            <span lang="ja">保存先を変更</span>
          </localized-content>
        </p-button>
      </o-if>
    </p>
    <p
      style="
        margin-top: 12px;
        color: var(--md-sys-color-normal);
        font-size: 0.9em;
      "
    >
      <localized-content>
        <span lang="cn"
          >文件将先暂存至浏览器缓存，接收完成后可一键转存到本地磁盘。</span
        >
        <span lang="en"
          >Files are temporarily saved in browser cache and can be exported to
          local disk after transfer.</span
        >
        <span lang="ja"
          >ファイルは一旦ブラウザキャッシュに保存され、転送完了後にローカルディスクへ書き出せます。</span
        >
      </localized-content>
    </p>
  </div>
  <script>
    export const parent = "./layout.html";

    export default async ({ load }) => {
      const { createUser } = await load("/packages/user/main.js");
      const { initReceiver } = await load("../util/copy-to.js");

      const localUser = await createUser();
      const myInfo = await localUser.info();

      return {
        data: {
          receiverId: [],
          canUsePicker: !!window.showDirectoryPicker,
        },
        proto: {
          runRadiate(time) {
            clearTimeout(this._radiate_timer);
            // 每5秒广播一次
            this._radiate_timer = setTimeout(() => {
              localUser.broadcast("warpsend-radiate", {});

              if (this.ele.isConnected) {
                this.runRadiate();
              }
            }, time || 5000);
          },
        },
        attached() {
          this._cancels = [
            localUser.register("warpsend-radiate", (data) => {
              console.log("file received", data);
            }),
            initReceiver({
              localUser,
              progress: (e) => {
                console.log("initReceiver: ", e);
              },
            }),
          ];

          this.runRadiate(100); // 第一次快速广播
        },
        detached() {
          clearTimeout(this._radiate_timer);
          this._cancels.forEach((cancel) => cancel());
        },
      };
    };
  </script>
</template>
