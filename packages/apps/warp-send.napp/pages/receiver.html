<template page>
  <l-m src="/packages/comps/local-icon/local-icon.html"></l-m>
  <style>
    :host {
      display: block;
      height: 100%;
      margin: 0 auto;
    }
  </style>
  <div style="padding: 8px; text-align: center">
    <p style="display: flex; align-items: center; justify-content: center">
      <localized-content>
        <span lang="cn">正在等待接收来自其他设备的文件…</span>
        <span lang="en">Waiting for file from other device...</span>
        <span lang="ja">他のデバイスからのファイルを待っています...</span>
      </localized-content>
      <n-local-icon
        name="loading"
        style="margin-left: 8px; display: block"
      ></n-local-icon>
    </p>
    <p style="display: flex; align-items: center; justify-content: center">
      <localized-content>
        <span lang="cn">文件将默认保存在：</span>
        <span lang="en">Files will be saved to:</span>
        <span lang="ja">ファイルは既定で保存されます：</span>
      </localized-content>
      <strong style="color: var(--md-sys-color-primary); margin-left: 4px">
        <localized-content>
          <span lang="cn">浏览器缓存</span>
          <span lang="en">Browser Cache</span>
          <span lang="ja">ブラウザキャッシュ</span>
        </localized-content>
      </strong>
      <o-if :value="canUsePicker">
        <p-button variant="outlined" size="small" style="margin-left: 8px">
          <localized-content>
            <span lang="cn">更改保存目录</span>
            <span lang="en">Change Directory</span>
            <span lang="ja">保存先を変更</span>
          </localized-content>
        </p-button>
      </o-if>
    </p>
    <p
      style="
        margin-top: 12px;
        color: var(--md-sys-color-normal);
        font-size: 0.9em;
      "
    >
      <localized-content>
        <span lang="cn"
          >文件将先暂存至浏览器缓存，接收完成后可一键转存到本地磁盘。</span
        >
        <span lang="en"
          >Files are temporarily saved in browser cache and can be exported to
          local disk after transfer.</span
        >
        <span lang="ja"
          >ファイルは一旦ブラウザキャッシュに保存され、転送完了後にローカルディスクへ書き出せます。</span
        >
      </localized-content>
    </p>
  </div>
  <script>
    export const parent = "./layout.html";

    export default async ({ load }) => {
      const { createUser } = await load("/packages/user/main.js");
      const { initReceiver } = await load("../util/copy-to.js");

      const localUser = await createUser();
      const myInfo = await localUser.info();

      const { createData } = await load("/packages/hybird-data/main.js");

      return {
        data: {
          receiverId: [], // 已经接受到广播的 sender 列表
          canUsePicker: !!window.showDirectoryPicker, // 是否支持浏览器目录选择的api
          configData: {}, // 应用的设置目录
        },
        proto: {
          runRadiate(time) {
            clearTimeout(this._radiate_timer);
            // 每5秒广播一次
            this._radiate_timer = setTimeout(() => {
              localUser.broadcast("warp-send-radiate", {});

              if (this.ele.isConnected) {
                this.runRadiate();
              }
            }, time || 5000);
          },
          // 改变接收文件的目录
          async changeReceiverHandle(handle) {
            if (this._receiverInvoice) {
              this._receiverInvoice();
            }

            if (!handle) {
              throw new Error("请选择接收文件的目录");
            }

            this._receiverInvoice = await initReceiver({
              localUser,
              handle,
              progress: (e) => {
                console.log("initReceiver: ", e);
              },
            });
          },
        },
        async attached() {
          // 默认使用的目录
          this._defaultDir = await this.app.dedicatedHandle();

          // 从配置中加载目录
          const configFile = await this._defaultDir.get("config.json", {
            create: "file",
          });

          // 加载配置文件
          this.configData = await createData(configFile);

          this._cancels = [
            localUser.register("warp-send-sender-attached", (data) => {
              // 有新的 sender 接入，快速广播一下自己的定位
              this.runRadiate(100);
            }),
          ];

          // 获取本地的临时收取目录
          const tempDir = await this._defaultDir.get("receive-temp", {
            create: "directory",
          });

          // 第一次进入，直接开始初始化
          this.changeReceiverHandle(tempDir);

          this.runRadiate(100); // 第一次快速广播
        },
        detached() {
          // 回收所有数据
          this.configData.disconnect();
          this.configData = {};
          clearTimeout(this._radiate_timer);
          this._cancels.forEach((cancel) => cancel());
          this._revokeReceiver && this._revokeReceiver();
        },
      };
    };
  </script>
</template>
