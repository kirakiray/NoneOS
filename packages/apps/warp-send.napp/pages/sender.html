<template page>
  <l-m src="/packages/pui/list/list.html"></l-m>
  <l-m src="/packages/comps/id-avatar.html"></l-m>
  <l-m src="/packages/apps/link-me.napp/comps/user-state.html"></l-m>
  <l-m src="/packages/apps/link-me.napp/comps/user-name.html"></l-m>
  <style>
    :host {
      display: block;
      height: 100%;
      margin: 0 auto;
    }

    n-id-avatar {
      margin-right: 8px;
      width: 20px;
      height: 20px;
    }

    n-user-state {
      margin-left: 8px;
    }
  </style>
  <h4>选择发送到设备</h4>
  <p-list>
    <o-fill :value="devices">
      <p-list-item
        button
        attr:disabled="!$host.receiverId.includes($data.userId)"
      >
        <div style="display: flex; align-items: center">
          <n-id-avatar :val="$data.userId"> </n-id-avatar>
          <n-user-name :userid="$data.userId"></n-user-name>
          <n-user-state :userid="$data.userId"></n-user-state>
          <o-if :value="$host.receiverId.includes($data.userId)">
            <span
              style="
                color: var(--md-sys-color-success);
                display: block;
                margin-left: 8px;
              "
            >
              已连接
            </span>
          </o-if>
        </div>
      </p-list-item>
    </o-fill>
  </p-list>
  <script>
    export const parent = "./layout.html";

    export default async ({ load }) => {
      const { createUser } = await load("/packages/user/main.js");
      const localUser = await createUser();

      return {
        data: {
          receiverId: [], // 接收到的设备id
          devices: [],
        },
        proto: {
          async refreshDevices() {
            const devices = await localUser.myDevices();
            this.devices = devices;
            console.log(devices);
          },
        },
        attached() {
          this.refreshDevices();

          this._cancels = [
            localUser.register(
              "warpsend-radiate",
              ({ data, fromUserId, fromUserSessionId }) => {
                console.log("warpsend-radiate", data);

                if (!this.receiverId.includes(fromUserId)) {
                  this.receiverId.push(fromUserId);
                }
              }
            ),
          ];
        },
        detached() {
          this._cancels.forEach((cancel) => cancel());
        },
      };
    };
  </script>
</template>
