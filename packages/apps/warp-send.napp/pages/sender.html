<template page>
  <l-m src="/packages/pui/list/list.html"></l-m>
  <l-m src="/packages/comps/user-avatar.html"></l-m>
  <l-m src="/packages/comps/user-state.html"></l-m>
  <l-m src="/packages/comps/user-name.html"></l-m>
  <l-m src="/packages/pui/switch/switch.html"></l-m>
  <style>
    :host {
      display: block;
      box-sizing: border-box;
      height: 100%;
      margin: 0 auto;
      padding: 16px;
    }
    h4 {
      display: flex;
      align-items: center;
      margin: 0;
      padding: 8px 0;
    }

    n-user-avatar {
      margin-right: 8px;
      width: 20px;
      height: 20px;
    }

    n-user-state {
      margin-left: 8px;
    }

    [show-only-sendable="on"] p-list-item[disabled] {
      display: none;
    }

    [show-only-sendable="on"] .connected-mark {
      display: none;
    }

    .connected-mark {
      color: var(--md-sys-color-success);
      display: block;
      margin-left: 8px;
    }
  </style>
  <h4>
    选择发送到设备
    <p-switch
      style="margin-left: 8px"
      sync:value="showOnlySendable"
      size="small"
    >
      仅显示可发送设备
    </p-switch>
  </h4>
  <p-list attr:show-only-sendable="showOnlySendable">
    <o-fill :value="devices">
      <p-list-item
        button
        attr:disabled="!$host.receiverId.includes($data.userId)"
        on:click="$host.receiverId.includes($data.userId) && ($host.selectedUserId = $data.userId)"
        attr:active-item="$host.selectedUserId == $data.userId"
      >
        <div style="display: flex; align-items: center">
          <n-user-avatar :userid="$data.userId"> </n-user-avatar>
          <n-user-name :userid="$data.userId"></n-user-name>
          <n-user-state :userid="$data.userId"></n-user-state>
          <o-if :value="$host.receiverId.includes($data.userId)">
            <span class="connected-mark"> 已连接 </span>
          </o-if>
        </div>
      </p-list-item>
    </o-fill>
  </p-list>
  <script>
    export const parent = "./layout.html";

    export default async ({ load }) => {
      const { createUser } = await load("/packages/user/main.js");
      const localUser = await createUser();

      return {
        data: {
          receiverId: [], // 接收到的设备id
          devices: [],
          showOnlySendable: "on",
          selectedUserId: "",
        },
        proto: {
          async refreshDevices() {
            const devices = await localUser.myDevices();
            this.devices = devices;
            console.log(devices);
          },
        },
        attached() {
          this.refreshDevices();

          this._cancels = [
            localUser.register(
              "warpsend-radiate",
              ({ data, fromUserId, fromUserSessionId }) => {
                console.log("warpsend-radiate", data);

                if (!this.receiverId.includes(fromUserId)) {
                  this.receiverId.push(fromUserId);
                }
              }
            ),
          ];
        },
        detached() {
          this._cancels.forEach((cancel) => cancel());
        },
      };
    };
  </script>
</template>
