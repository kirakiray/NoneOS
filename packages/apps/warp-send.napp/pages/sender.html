<template page>
  <l-m src="/packages/pui/list/list.html"></l-m>
  <l-m src="/packages/comps/user-avatar.html"></l-m>
  <l-m src="/packages/comps/user-state.html"></l-m>
  <l-m src="/packages/comps/user-name.html"></l-m>
  <l-m src="/packages/pui/switch/switch.html"></l-m>
  <l-m src="/packages/pui/button/button.html"></l-m>
  <l-m src="/packages/comps/local-icon/local-icon.html"></l-m>
  <style>
    :host {
      display: block;
      box-sizing: border-box;
      height: 100%;
      margin: 0 auto;
      padding: 16px;
    }
    h4 {
      display: flex;
      align-items: center;
      margin: 0;
      padding: 8px 0;
    }

    n-user-avatar {
      margin-right: 8px;
      width: 20px;
      height: 20px;
    }

    n-user-state {
      margin-left: 8px;
    }

    [show-only-sendable="on"] p-list-item[disabled] {
      display: none;
    }

    [show-only-sendable="on"] .connected-mark {
      display: none;
    }

    .connected-mark {
      color: var(--md-sys-color-success);
      display: block;
      margin-left: 8px;
    }

    n-local-icon {
      display: block;
      margin-right: 4px;
    }

    .hide {
      opacity: 0;
      pointer-events: none;
    }
  </style>
  <h4>
    选择发送给
    <p-switch
      style="margin-left: 20px"
      sync:value="showOnlySendable"
      size="small"
    >
      仅显示可发送设备
    </p-switch>
  </h4>
  <p-list attr:show-only-sendable="showOnlySendable">
    <o-fill :value="devices">
      <p-list-item
        button
        attr:disabled="!$host.receiverId.includes($data.userId)"
        on:click="$host.clickDevice($data,$ele)"
        attr:active-item="$host.selectedUserId == $data.userId"
      >
        <div style="display: flex; align-items: center">
          <n-user-avatar :userid="$data.userId"> </n-user-avatar>
          <n-user-name :userid="$data.userId"></n-user-name>
          <n-user-state :userid="$data.userId"></n-user-state>
          <o-if :value="$host.receiverId.includes($data.userId)">
            <span class="connected-mark"> 已连接 </span>
          </o-if>
        </div>
      </p-list-item>
    </o-fill>
  </p-list>
  <p-list-item
    collapse-childs="open"
    button="suffix"
    class:hide="!selectedUserId"
    style="margin-top: 16px"
  >
    <div style="display: flex; align-items: center">
      <strong style="margin-right: 4px">待发送文件</strong> (
      <span style="color: var(--md-sys-color-primary)"> {{files.length}}</span>
      )
    </div>
    <i toggle-collapse triangle slot="suffix" style="margin-left: 32px"></i>
    <p-list slot="childs" style="--ladder-left: 8px">
      <o-fill :value="files">
        <p-list-item>
          <div style="display: flex; align-items: center">
            <n-local-icon
              :name="$data.type === 'file' ? 'file' : 'folder'"
              slot="prefix"
              style="font-size: 20px"
            ></n-local-icon>
            <span style="margin-left: 4px">{{$data.name}}</span>
            <span style="margin-left: 4px"
              >({{$host.getFileSize($data.size)}})</span
            >
            <p-button
              on:click="$host.removeItem($index)"
              size="small"
              color="error"
              variant="outlined"
              style="margin-left: auto"
            >
              移除
            </p-button>
          </div>
        </p-list-item>
      </o-fill>
    </p-list>
  </p-list-item>
  <style>
    .btn-group {
      display: flex;
      align-items: center;
      justify-content: center;
      margin-top: 4px;
      flex-wrap: wrap;
    }

    .btn-group p-button {
      margin: 0 4px;
    }
  </style>
  <div class="btn-group" class:hide="!selectedUserId">
    <p-button
      style="margin-right: auto"
      attr:disabled="!selectedUserId || !files.length"
      attr:variant="files.length ? 'contained' : 'outlined'"
    >
      发送这{{files.length}}个文件
    </p-button>
    <p-button
      attr:disabled="!selectedUserId"
      on:click="shadow.$('#file-input').ele.click()"
      attr:variant="!files.length ? 'contained' : 'outlined'"
    >
      <n-local-icon name="file" slot="prefix"></n-local-icon>
      添加文件
    </p-button>
    <input
      type="file"
      id="file-input"
      on:change="fileChange"
      style="display: none"
      multiple
    />
    <p-button
      attr:disabled="!selectedUserId"
      on:click="shadow.$('#folder-input').ele.click()"
      attr:variant="!files.length ? 'contained' : 'outlined'"
    >
      <n-local-icon name="folder" slot="prefix"></n-local-icon>
      添加文件夹
    </p-button>
    <input
      type="file"
      id="folder-input"
      on:change="folderChange"
      style="display: none"
      webkitdirectory
      directory
    />
  </div>
  <script>
    export const parent = "./layout.html";

    export default async ({ load }) => {
      const { createUser } = await load("/packages/user/main.js");
      const localUser = await createUser();

      return {
        data: {
          receiverId: [], // 接收到的设备id
          devices: [],
          showOnlySendable: "on",
          selectedUserId: "",
          files: [], // 已经选择的文件
        },
        proto: {
          async removeItem(index) {
            this.files.splice(index, 1);
          },
          async fileChange(event) {
            const files = event.target.files;

            this.files.push(
              ...Array.from(files).map((file) => {
                return {
                  name: file.name,
                  size: file.size,
                  type: "file",
                  _file: file,
                  task: [], // 进度记录
                };
              })
            );

            event.target.value = "";
          },
          async folderChange(event) {
            const files = event.target.files;

            const dirItem = {
              name: files[0].webkitRelativePath.split("/")[0],
              size: 0,
              type: "directory",
              _files: [],
              task: [], // 进度记录
            };

            for (let file of files) {
              dirItem.size += file.size;
              dirItem._files.push(file);
            }

            this.files.push(dirItem);

            event.target.value = "";
          },
          getFileSize(b) {
            const units = ["B", "KB", "MB", "GB", "TB"];
            let index = 0;
            while (b >= 1024 && index < units.length - 1) {
              b /= 1024;
              index++;
            }
            return `${b.toFixed(2)} ${units[index]}`;
          },
          async clickDevice(data, ele) {
            if (ele.disabled !== null) {
              return;
            }

            if (this.selectedUserId && this.selectedUserId !== data.userId) {
              // TODO: 告诉之前的设备取消了选择它
            }

            this.selectedUserId = data.userId;

            // TODO: 通知对方准备接收文件
          },
          async refreshDevices() {
            const devices = await localUser.myDevices();
            this.devices = devices;
            console.log(devices);
          },
        },
        attached() {
          this.refreshDevices();

          this._cancels = [
            localUser.register(
              "warpsend-radiate",
              ({ data, fromUserId, fromUserSessionId }) => {
                if (!this.receiverId.includes(fromUserId)) {
                  this.receiverId.push(fromUserId);
                }
              }
            ),
          ];
        },
        detached() {
          this._cancels.forEach((cancel) => cancel());
        },
      };
    };
  </script>
</template>
