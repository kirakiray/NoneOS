<template component>
  <link rel="stylesheet" href="./hljs-dark.css" />
  <style>
    :host {
      position: relative;
      display: block;
      border-radius: 6px;
    }

    code[contenteditable] {
      -webkit-user-modify: read-write-plaintext-only;
      outline: none;
    }

    .editor-code {
      position: absolute;
      z-index: 1;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      caret-color: var(--md-sys-color-on-surface);
      color: transparent;
    }

    .show-code {
      position: relative;
      z-index: 2;
      pointer-events: none;
      background-color: transparent;
    }

    pre {
      white-space: pre-wrap; /* 或者使用 word-wrap: break-word; */
    }

    code.hljs {
      font-size: 13px;
      padding: 0 !important;
      min-height: 2em;
      word-break: break-word;
      border-radius: 6px;
    }

    .hljs::spelling-error {
      background-color: transparent; /* 移除背景色 */
      text-decoration: none; /* 移除下划线 */
    }

    .lang-tag {
      position: absolute;
      right: 4px;
      top: 4px;
      z-index: 2;
      padding: 0 4px;
      font-size: 12px;
      border-radius: 6px;
      background-color: var(--md-sys-color-primary);
      color: var(--md-sys-color-on-primary);
    }
  </style>

  <div class="lang-tag">{{realLang}}</div>
  <pre><code class="hljs editor-code" contenteditable="plaintext-only" on:input="changeCode"></code></pre>
  <pre><code class="hljs show-code"></code></pre>

  <script>
    export default async ({ load }) => {
      const { default: hljs } = await load("/packages/libs/hljs-es/core.js");
      const { default: hljsXml } = await load(
        "/packages/libs/hljs-es/languages/xml.js"
      );
      const { default: hljsJs } = await load(
        "/packages/libs/hljs-es/languages/javascript.js"
      );
      const { default: hljsCss } = await load(
        "/packages/libs/hljs-es/languages/css.js"
      );

      hljs.registerLanguage("xml", hljsXml);
      hljs.registerLanguage("javascript", hljsJs);
      hljs.registerLanguage("css", hljsCss);

      return {
        tag: "lumi-code",
        data: {
          lang: "auto",
          realLang: "",
        },
        proto: {
          changeCode(e) {
            // const highlightedCode = hljs.highlight(e.target.textContent, {
            //   language: "xml",
            // }).value;
            // this._codeEl.html = highlightedCode;

            const result = hljs.highlightAuto(e.target.textContent);

            this.realLang = result.language;
            this._codeEl.html = result.value;
          },
        },
        attached() {
          this._codeEl = this.shadow.$("code.show-code");
        },
      };
    };
  </script>
</template>
