<template component>
  <style>
    :host {
      position: relative;
      display: block;
      margin: 0 auto;
      max-width: 800px;
      width: 100%;
    }

    .dragovering-mark {
      position: absolute;
      bottom: 0;
      width: 100%;
      height: 2px;
      background-color: var(--md-sys-color-primary);
      opacity: 0;
    }
    .dragovering-mark.show {
      opacity: 1;
    }

    .title {
      font-size: 40px;
      font-weight: 700;
      box-sizing: border-box;
      margin: 0 6px;
      width: 100%;
      outline: none;
      background-color: transparent;
      -webkit-appearance: none;
      appearance: none;
      border: none;
      color: inherit;
    }

    .translate-container {
      position: relative;
      display: block;
      margin: 0 6px;
      margin-bottom: 16px;
      font-size: 40px;
      font-weight: 700;
      line-height: 1.2;
      min-height: 48px;
      user-select: text;
    }

    .lang-mark {
      position: absolute;
      right: -2px;
      bottom: -2px;
      font-size: 12px;
      line-height: 1.6em;
      display: flex;
      align-items: center;
      color: var(--md-sys-color-on-primary);
      background-color: var(--md-sys-color-primary);
      padding: 0 4px;
      border-radius: 4px;
      opacity: 0.7;
      font-weight: 500;
    }
  </style>
  <div style="height: 100px"></div>
  <o-if :value="!inTranslate">
    <input
      class="title"
      type="text"
      sync:value="itemData.title"
      on:click="$event.stopPropagation()"
      style="margin-bottom: 16px"
      on:keydown="titleKeyDown"
      :placeholder="desc.pageTitlePlaceholder"
    />
  </o-if>
  <o-else>
    <div class="translate-container">
      <o-if :value="inTranslate == 1"> {{itemData.title}} </o-if>
      <div :html="translateContent" style="display: contents"></div>
      <div class="lang-mark">
        <o-if :value="inTranslate == 1">
          <localized-content>
            <span lang="cn">等待确认翻译为:</span>
            <span lang="en"> Wait for confirmation of translation: </span>
            <span lang="ja">翻訳を確認待ち:</span>
          </localized-content>
        </o-if>
        <!-- <o-if :value="inTranslate == 2">
          <n-local-icon name="loading"></n-local-icon>
        </o-if> -->
        {{markLang}}
      </div>
    </div>
  </o-else>
  <div class="dragovering-mark" class:show="dragovering"></div>
  <o-consumer name="lumi-view-lang" watch:value="lumiViewLang"></o-consumer>
  <script>
    import { localizedObject } from "/packages/i18n/localized-object.js";

    export default async ({ load }) => {
      const { ask, clearAsk, solicit } = await load("/packages/ai/main.js");
      const { switchLang, getMainLang } = await load("./util/i18n-toblock.js");
      const { getRealLang } = await load("../util/get-real-lang.js");
      const { getHash } = await load("/packages/fs/util.js");

      return {
        tag: "lumi-page-title",
        data: {
          dragovering: false,
          itemData: {},
          desc: {},
          translateContent: "", // 翻译后的文本
          inTranslate: false, // 翻译中
          inTranslateLang: "", // 翻译的语言
          lumiViewLang: "",
        },
        watch: {
          lumiViewLang(lang) {
            this.switchOtherLang(lang);
          },
        },
        proto: {
          get markLang() {
            return getRealLang(this.inTranslateLang);
          },
          async switchOtherLang(lang) {
            await this.watchUntil(() => this.itemData.title);

            if (this._translateCancel) {
              this._translateCancel();
              this._translateCancel = null;
            }

            const mainLang = await getMainLang(this.host);

            if (mainLang === lang) {
              // 同语言不需要切换
              this.translateContent = "";
              this.inTranslateLang = "";
              this.inTranslate = false;
              return;
            }

            if (!this.itemData.title) {
              // 没有内容不需要翻译
              return;
            }

            const currentHash = await getHash(this.itemData.title);

            let titleI18nContent = this.itemData.titleI18nContent;

            if (!titleI18nContent) {
              this.itemData.titleI18nContent = {};
              titleI18nContent = this.itemData.titleI18nContent;
            }

            if (
              !titleI18nContent[lang] ||
              titleI18nContent[lang].originHash !== currentHash
            ) {
              // TODO: 弹起AI翻译任务重新翻译
              this._translateCancel = solicit({
                groupTitle: "翻译文章：" + this.itemData.title, // 用于给任务分组用
                desc: `将标题翻译成"${getRealLang(lang)}"`,
                onstart: () => {
                  return `你是一名专业本地化工程师。接下来我会给你一段 HTML 源码，请逐字翻译其中的人类可读文本，同时：
1. 保留所有标签、属性、占位符、实体、注释及代码结构不变；
2. 不要翻译标签名、属性名、class、id、URL、脚本、样式内容；
3. 仅将显示在页面上的自然语言文本翻译成${getRealLang(lang)}；
4. 不要添加或删除任何标签。
HTML 如下：

${this.itemData.title}
`;
                },
                onsuccess: (e) => {
                  titleI18nContent[lang] = {
                    originHash: currentHash,
                    modelName: e.modelName,
                    value: e.responseText,
                    time: Date.now(),
                  };

                  this.translateContent = titleI18nContent[lang].value;
                  this.inTranslateLang = lang;
                  this.inTranslate = 3;
                },
              });

              this.translateContent = "";
              this.inTranslateLang = lang;
              this.inTranslate = 1;
              return;
            }

            // 修正内容
            this.translateContent = titleI18nContent[lang].value;
            this.inTranslateLang = lang;
            this.inTranslate = 3;
          },
          titleKeyDown(e) {
            if (e.key === "Enter") {
              // 如果第一个元素不是空元素，则添加空元素后聚焦
              let firstBlock = this[0];

              if (firstBlock && !firstBlock.itemData.value.trim()) {
                firstBlock.focus();
                return;
              }

              this.itemData.content.unshift({
                type: "paragraph",
                value: "",
              });

              setTimeout(() => {
                this.host[0].focus();
              }, 10);
            }
          },
          focus() {
            this.shadow.$(".title").ele.focus();
          },
        },
        attached() {
          this.desc = localizedObject({
            pageTitlePlaceholder: {
              cn: "页面标题",
              en: "Page title",
              ja: "ページタイトル",
            },
          });
        },
        detached() {
          if (this._translateCancel) {
            this._translateCancel();
            this._translateCancel = null;
          }

          this.itemData = {};
          this.desc._clear();
          this.desc = {};
        },
      };
    };
  </script>
</template>
