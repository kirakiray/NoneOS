<template component>
  <l-m src="/packages/comps/local-icon/local-icon.html"></l-m>
  <l-m src="/packages/pui/menu/menu.html"></l-m>
  <style>
    :host {
      display: block;
    }

    .mask {
      position: fixed;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      z-index: 10000;
      pointer-events: none;
    }

    .mask.show-multi-panel {
      pointer-events: auto;
    }

    .multi-panel {
      position: fixed;
      top: 100px;
      left: 100px;
      padding: 3px;
      background-color: var(--md-sys-color-on-normal);
      box-shadow: var(--contained-shadow);
      border-radius: 20px;
      opacity: 0;
      transform: translateX(10px);
      transition: opacity ease 0.2s, transform ease 0.2s;
      white-space: nowrap;
    }

    .mask.show-multi-panel .multi-panel {
      opacity: 1;
      transform: translateX(0);
    }
  </style>

  <div class="mask" class:show-multi-panel="open" on:click="clickMask">
    <div
      class="multi-panel"
      :style.top="multiPanelStyle.top"
      :style.left="multiPanelStyle.left"
    >
      <p-button size="small" variant="text" on:click="clickMultiCopy">
        <n-local-icon
          name="copy"
          slot="prefix"
          style="display: block; margin-right: 4px"
        ></n-local-icon>
        复制
      </p-button>
      <p-button
        size="small"
        color="error"
        variant="text"
        on:click="clickMultiDelete"
      >
        <n-local-icon
          name="delete"
          slot="prefix"
          style="display: block; margin-right: 4px"
        ></n-local-icon>
        删除
      </p-button>
    </div>
  </div>

  <script>
    export default async ({ load }) => {
      const { toast } = await load("/packages/pui/util.js");

      return {
        tag: "lumi-multi-panel",
        data: {
          open: false,
          multiPanelStyle: {
            top: 0,
            left: 0,
          },
          _selecteds: [], // 选中的元素
        },
        proto: {
          get panel() {
            return this.shadow.$(".multi-panel");
          },
          clickMultiCopy() {
            let textContent = "";
            let htmlContent = "";
            // let mdContent = "";

            const lastIndex = this._selecteds.length - 1;

            this._selecteds.forEach((item, index) => {
              if (!item.textContent) {
                return;
              }

              textContent += item.textContent;
              htmlContent += item.htmlContent;
              // mdContent += item.mdContent;

              if (textContent && index !== lastIndex) {
                textContent += `\n\n`;
                htmlContent += `\n`;
                // mdContent += `\n\n`;
              }
            });

            navigator.clipboard.write([
              new ClipboardItem({
                "text/html": new Blob([htmlContent], { type: "text/html" }),
                "text/plain": new Blob([textContent], { type: "text/plain" }),
                // "text/markdown": new Blob([mdContent], {
                //   type: "text/markdown",
                // }),
              }),
            ]);

            toast("复制成功");

            this.emit("close", {
              bubbles: false,
            });
          },
          clickMultiDelete() {
            // 逐个删除内容
            const { content } = this.itemData;

            this._rangData.forEach((item) => {
              if (item.type === "article") {
                item.removed = true;
              } else {
                const index = content.indexOf(item);
                content.splice(index, 1);
              }
            });

            this.emit("close", {
              bubbles: false,
            });
          },
          clickMask() {
            this.open = false;
            this.forEach((e) => {
              if (e.selected) {
                e.selected = false;
              }
            });
            this.emit("close", {
              bubbles: false,
            });
          },
        },
        attached() {},
      };
    };
  </script>
</template>
