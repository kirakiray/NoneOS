<template component>
  <l-m src="/packages/pui/button/button.html"></l-m>
  <l-m src="/packages/pui/input/input.html"></l-m>
  <l-m src="/packages/pui/select/select.html"></l-m>
  <l-m src="/packages/pui/progress/progress.html"></l-m>

  <style>
    :host {
      display: block;
    }

    .list-line {
      display: flex;
      align-items: center;
      height: 30px;
    }
    .list-key {
      color: var(--md-sys-color-normal);
    }

    h4 {
      margin: 0;
      padding: 0;
      margin-top: 1em;
    }
  </style>

  <div class="list-line">
    <span class="list-key">
      <localized-content>
        <span lang="cn"> 项目名称 </span>
        <span lang="en"> Project Name </span>
        <span lang="ja"> プロジェクト名 </span>
      </localized-content>
    </span>
    :
    <o-if :value="!nameEditMode">
      <div style="margin-left: 4px; color: var(--md-sys-color-primary)">
        {{projectData?.projectName}}
      </div>
      <p-button
        size="small"
        variant="text"
        on:click="clickEditMode"
        icon
        style="margin-left: 8px"
      >
        <n-local-icon name="edit"></n-local-icon>
      </p-button>
    </o-if>
    <o-else>
      <p-input
        sync:value="editProjectName"
        size="small"
        style="width: 200px; margin-left: 8px"
      ></p-input>
      <p-button
        on:click="clickSave"
        size="small"
        style="margin-left: 8px"
        variant="outlined"
        attr:disabled="editProjectName === projectData.projectName"
      >
        <localized-content>
          <span lang="cn"> 保存 </span>
          <span lang="en"> Save </span>
          <span lang="ja"> 保存 </span>
        </localized-content>
      </p-button>
      <p-button
        on:click="nameEditMode = false"
        size="small"
        variant="text"
        style="margin-left: 8px"
      >
        <localized-content>
          <span lang="cn"> 取消 </span>
          <span lang="en"> Cancel </span>
          <span lang="ja"> キャンセル </span>
        </localized-content>
      </p-button>
    </o-else>
  </div>
  <div class="list-line">
    <span class="list-key">
      <localized-content>
        <span lang="cn"> 项目语言 </span>
        <span lang="en"> Project Language </span>
        <span lang="ja"> プロジェクト言語 </span>
      </localized-content>
    </span>
    :
    <div style="margin-left: 4px">{{lang}}</div>
    <o-if :value="!lang">
      <p-select sync:value="currentMainLang" size="small">
        <p-option value="cn">简体中文</p-option>
        <p-option value="en">English</p-option>
        <p-option value="t-cn">繁體中文</p-option>
        <p-option value="ja">日本語</p-option>
      </p-select>
      <p-button
        on:click="projectData.mainLang = currentMainLang"
        size="small"
        style="margin-left: 4px"
        variant="outlined"
        >保存</p-button
      >
    </o-if>
  </div>
  <h4>
    多语言进度
    <p-button
      size="mini"
      style="margin-left: 8px"
      variant="outlined"
      on:click="refreshLangProgress"
    >
      刷新
    </p-button>
  </h4>
  <o-if :value="translationProgress.length">
    <o-fill :value="translationProgress">
      <div style="max-width: 320px; padding: 8px 0">
        {{$data.langName}} ({{$data.progress}}%)
        <p-progress
          :value="$data.progress"
          style="margin-top: 4px"
        ></p-progress>
      </div>
    </o-fill>
  </o-if>
  <o-else>
    <div style="height: 48px; line-height: 48px">暂无翻译进度</div>
  </o-else>

  <script>
    export default async ({ load }) => {
      return {
        tag: "lumi-project-setting",
        data: {
          nameEditMode: false,
          editProjectName: "",
          projectData: {},
          currentMainLang: "",
          translationProgress: [],
        },
        proto: {
          async refreshLangProgress() {
            const translationProgress = [];

            const langs = ["en", "ja"];

            if (this.projectData.main) {
              for (const lang of langs) {
                const progress = await getTranslationProgress(
                  this.projectData.main,
                  lang
                );

                translationProgress.push({
                  lang,
                  langName: this.getRealLang(lang),
                  ...progress,
                  progress: Math.ceil(
                    (progress.translatedItemCount / progress.totalItemCount) *
                      100
                  ),
                });
              }
            }

            this.translationProgress = translationProgress;
          },
          get lang() {
            if (!this.projectData) {
              return "";
            }

            return this.getRealLang(this.projectData.mainLang);
          },

          getRealLang(lang) {
            switch (lang) {
              case "cn":
                return "简体中文";
              case "en":
                return "English";
              case "t-cn":
                return "繁體中文";
              case "ja":
                return "日本語";
              default:
                return lang;
            }
          },
          clickSave() {
            this.projectData.projectName = this.editProjectName;
            this.nameEditMode = false;
          },
          clickEditMode() {
            this.editProjectName = this.projectData.projectName;
            this.nameEditMode = true;
          },
        },
        attached() {
          setTimeout(() => {
            this.refreshLangProgress();
          }, 2000);
        },
        detached() {
          this.projectData = {};
        },
      };
    };

    // 获取翻译的进度
    const getTranslationProgress = async (contentBlocks, language) => {
      let translatedItemCount = 0;
      let totalItemCount = 0;

      for (let i = 0; i < contentBlocks.length; i++) {
        const contentBlock = contentBlocks[i];
        if (contentBlock.type === "article") {
          const progressData = await getTranslationProgress(
            contentBlock.content,
            language
          );

          translatedItemCount += progressData.translatedItemCount;
          totalItemCount += progressData.totalItemCount;
        } else {
          totalItemCount++;

          const { i18nContent } = contentBlock;

          if (!i18nContent) {
            continue;
          }

          if (i18nContent[language]) {
            translatedItemCount++;
          }
        }
      }

      return {
        translatedItemCount,
        totalItemCount,
      };
    };
  </script>
</template>
