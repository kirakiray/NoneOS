<template component>
  <l-m src="/packages/pui/button/group.html"></l-m>

  <style>
    :host {
      position: absolute;
      display: block;
    }
    .section-pannel {
      display: flex;
      align-items: center;
      background-color: var(--md-sys-color-on-normal);
      color: var(--md-sys-color-normal);
      box-shadow: var(--contained-shadow);
      border-radius: 18px;
      padding: 3px;
      white-space: nowrap;
      animation: pannel-anime ease 0.3s;
    }

    @keyframes pannel-anime {
      0% {
        transform: translate(16px, 0);
        opacity: 0;
      }
      100% {
        transform: translate(0, 0);
        opacity: 1;
      }
    }

    .section-pannel n-local-icon {
      display: block;
      font-size: 16px;
    }

    .tool-pannel-line {
      background-color: var(--md-sys-color-normal);
      width: 1px;
      height: 22px;
      margin: 0 6px;
    }

    .section-pannel p-button {
      margin: 0 2px;
    }

    .tool-tips {
      margin-bottom: 5px;
      padding: 8px;
      color: var(--md-sys-color-on-normal-container);
      background-color: var(--md-sys-color-normal-container);
      border-radius: var(--pui-border-radius);
      box-shadow: var(--contained-shadow);
    }
  </style>

  <div class="section-pannel">
    <p-tooltips placement="top" plain>
      <p-button size="small" variant="text" color="normal">
        <n-local-icon
          name="branch"
          slot="prefix"
          style="margin-right: 6px; color: var(--md-sys-color-primary)"
        ></n-local-icon>
        创建解释文档
      </p-button>
      <div slot="tips">
        <div class="tool-tips" style="white-space: wrap; width: 200px">
          新建一份便条，对选中内容进行解释说明。
        </div>
      </div>
    </p-tooltips>

    <div class="tool-pannel-line"></div>
    <p-tooltips placement="top" plain>
      <p-button
        size="small"
        variant="text"
        color="normal"
        icon
        on:click="handleSelectionAction('bold')"
        attr:disabled="itemData.type === 'h1' || itemData.type === 'h2' || itemData.type === 'h3'"
      >
        <n-local-icon name="bold"></n-local-icon>
      </p-button>

      <div slot="tips">
        <o-if
          :value="itemData.type === 'h1' || itemData.type === 'h2' || itemData.type === 'h3'"
        >
          <div class="tool-tips">标题已经是加粗的状态</div>
        </o-if>
        <o-else>
          <div class="tool-tips">加粗</div>
        </o-else>
      </div>
    </p-tooltips>
    <p-tooltips placement="top" plain>
      <p-button
        size="small"
        variant="text"
        color="normal"
        icon
        on:click="handleSelectionAction('underline')"
      >
        <n-local-icon name="underline" style="font-size: 18px"></n-local-icon>
      </p-button>
      <div slot="tips">
        <div class="tool-tips">下划线</div>
      </div>
    </p-tooltips>
    <p-tooltips placement="top" plain>
      <p-button
        size="small"
        variant="text"
        color="normal"
        icon
        on:click="handleSelectionAction('strikethrough')"
      >
        <n-local-icon
          name="strikethrough"
          style="font-size: 18px"
        ></n-local-icon>
      </p-button>
      <div slot="tips">
        <div class="tool-tips">删除线</div>
      </div>
    </p-tooltips>
    <p-tooltips placement="top" plain>
      <p-button
        size="small"
        variant="text"
        color="normal"
        icon
        on:click="handleSelectionAction('italic')"
      >
        <n-local-icon name="italic"></n-local-icon>
      </p-button>
      <div slot="tips">
        <div class="tool-tips">斜体</div>
      </div>
    </p-tooltips>
    <p-button size="small" variant="outlined" color="normal">
      <span slot="prefix">A</span>
      颜色
    </p-button>
  </div>

  <script>
    export default async ({ load }) => {
      const {
        elementToLetterData,
        letterDataToElement,
        getRealOffset,
      } = await load("./lumi-util.js");

      return {
        tag: "lumi-block-pannel",
        data: {
          itemData: {},
        },
        proto: {
          async getSelectionLetterData() {
            const range = this.host._range;
            const rootEl = this.host[0].ele;

            // 转为字母数据
            const letterData = await elementToLetterData(rootEl);

            console.log("letterData: ", letterData);

            let startOffset = getRealOffset(
              rootEl,
              range.startContainer,
              range.startOffset
            );

            let endOffset = getRealOffset(
              rootEl,
              range.endContainer,
              range.endOffset
            );

            // 给目标范围内的字符修正信息
            const selectionRangeLetters = letterData.slice(
              startOffset,
              endOffset
            );

            return {
              startOffset,
              endOffset,
              letterData,
              selectionRangeLetters,
            };
          },
          async handleSelectionAction(type) {
            const {
              startOffset,
              endOffset,
              letterData,
              selectionRangeLetters,
            } = await this.getSelectionLetterData();

            switch (type) {
              case "bold":
                selectionRangeLetters.forEach((item) => {
                  item.options = {
                    ...item.options,
                    bold: true,
                  };
                });
                break;
              case "italic":
                selectionRangeLetters.forEach((item) => {
                  item.options = {
                    ...item.options,
                    italic: true,
                  };
                });
                break;
              case "underline":
                selectionRangeLetters.forEach((item) => {
                  item.options = {
                    ...item.options,
                    underline: true,
                  };
                });
                break;
              case "strikethrough":
                selectionRangeLetters.forEach((item) => {
                  item.options = {
                    ...item.options,
                    lineThrough: true,
                  };
                });
                break;
            }

            // 将数据重新转回字符串
            const newValue = await letterDataToElement(letterData);

            this.emit("update-value", {
              data: {
                value: newValue,
                startOffset,
                endOffset,
              },
            });
          },
        },
        attached() {
          // 获取选择的返回, 看看是不是有文字
          // (async () => {
          //   const { letterData, selectionRangeLetters } =
          //     await this.getSelectionLetterData();
          //   debugger;
          // })();
        },
        detached() {
          this.itemData = {};
        },
      };
    };
  </script>
</template>
