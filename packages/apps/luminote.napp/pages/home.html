<template page>
  <l-m src="../lumi/lumi-page.html"></l-m>
  <l-m src="/packages/pui/button/button.html"></l-m>
  <l-m src="/packages/pui/input/input.html"></l-m>
  <l-m src="/packages/pui/list/list.html"></l-m>
  <l-m src="/packages/comps/moment-span.html"></l-m>
  <l-m src="/packages/comps/id-avatar.html"></l-m>
  <l-m src="/packages/i18n/localized-content.html"></l-m>
  <l-m src="/packages/pui/select/select.html"></l-m>
  <l-m src="/packages/pui/switch/switch.html"></l-m>

  <style>
    :host {
      box-sizing: border-box;
      padding: 16px 42px;
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
    }

    .button-line p-button {
      margin-right: 2px;
    }

    .hide {
      display: none !important;
    }
  </style>
  <h1>
    <localized-content>
      <span lang="cn">首页</span>
      <span lang="en">Home</span>
      <span lang="ja">ホーム</span>
    </localized-content>
  </h1>
  <localized-content>
    <p lang="cn">
      欢迎使用
      Luminote！这是一款强大的知识管理工具，它能帮助你有条理地梳理思路。通过逐层拆解内容，你可以将复杂的知识体系转化为清晰明了的笔记。
    </p>
    <p lang="cn">
      建议使用新标签页模式打开本应用，能畅享更加流畅、稳定的使用体验。
    </p>

    <p lang="en">
      Welcome to use Luminote! This is a powerful knowledge management tool that
      can help you organize your thoughts systematically. By breaking down the
      content layer by layer, you can transform complex knowledge systems into
      clear and concise notes.
    </p>
    <p lang="en">
      Suggest using a new tab to open this application for the best experience.
    </p>

    <p lang="ja">
      Luminoteをご利用いただき、ありがとうございます！これは強力な知識管理ツールで、あなたが体系的に考えを整理するのに役立ちます。内容を段階的に分解することで、複雑な知識体系を明確で分かりやすいノートに変換することができます。
    </p>
    <p lang="ja">
      新しいタブでこのアプリケーションを開いてください。最良の体験を得るためです。
    </p>
  </localized-content>

  <o-if :value="isSafari">
    <div style="color: red">
      <localized-content>
        <p lang="cn">
          注意：在 Safari
          浏览器中使用本应用时，请务必通过新标签页模式打开，否则可能会出现兼容性问题，导致部分功能无法正常使用。
        </p>
        <p lang="en">
          Note: When using this application in Safari browser, please open it in
          a new tab mode, otherwise, you may encounter compatibility issues and
          some features may not work properly.
        </p>
        <p lang="ja">
          注意： Safari
          ブラウザでこのアプリケーションを使用する場合、新しいタブで開いてください。そうしないと、一部の機能が正常に動作しない可能性があります。
        </p>
      </localized-content>
    </div>
  </o-if>

  <h4>
    <localized-content>
      <span lang="cn">本地AI</span>
      <span lang="en">Local AI</span>
      <span lang="ja">ローカルAI</span>
    </localized-content>
  </h4>
  <localized-content>
    <p lang="cn">
      配置本地 AI 后，Luminote
      还能自动为你的内容提供润色和翻译服务，让你的写作体验更加轻松愉悦，专注于创作本身。
    </p>
    <p lang="en">
      After configuring the local AI, Luminote can also automatically provide
      proofreading and translation services for your content, making your
      writing experience more enjoyable and allowing you to focus on the
      creation itself.
    </p>
    <p lang="ja">
      ローカルAIを設定すると、Luminoteはあなたのコンテンツに対して自動的に文章校正や翻訳サービスを提供し、執筆体験をより快適なものにし、創作そのものに集中できるようにします。
    </p>
  </localized-content>
  <div style="display: flex; align-items: center">
    <o-if :value="aiAvailable === 0">
      <localized-content>
        <span lang="cn">加载中...</span>
        <span lang="en">Loading...</span>
        <span lang="ja">ローディング中...</span>
      </localized-content>
    </o-if>
    <o-else>
      <p-switch sync:value="appConfigData.useAITranslate" disabled>
        使用AI功能
      </p-switch>

      <p-tooltips>
        <o-if :value="aiAvailable">
          <n-local-icon
            name="succeed"
            style="
              color: var(--md-sys-color-primary);
              margin-left: 8px;
              display: block;
            "
          ></n-local-icon>
        </o-if>
        <o-else>
          <p-button
            size="mini"
            icon
            variant="outlined"
            style="margin-left: 8px"
          >
            !
          </p-button>
        </o-else>

        <div slot="tips">
          <o-if :value="!aiAvailable">
            <localized-content>
              <span lang="cn">当前环境中未检测到可用的本地AI</span>
              <span lang="en"
                >Current environment did not detect available local AI</span
              >
              <span lang="ja">ローカルAIが利用可能</span>
            </localized-content>
          </o-if>
          <o-else>
            <localized-content>
              <span lang="cn"> 当前已检测到本地AI可用 </span>
              <span lang="en"> Local AI available </span>
              <span lang="ja"> ローカルAIが利用可能 </span>
            </localized-content>
          </o-else>
        </div>
      </p-tooltips>
    </o-else>
  </div>

  <div>
    <h4>
      <localized-content>
        <span lang="cn">项目操作</span>
        <span lang="en">Project operations</span>
        <span lang="ja">プロジェクト操作</span>
      </localized-content>
    </h4>

    <p-button on:click="clickCreateProject" variant="outlined">
      <localized-content>
        <span lang="cn">创建新项目</span>
        <span lang="en">Create new project</span>
        <span lang="ja">新しいプロジェクトを作成する</span>
      </localized-content>
    </p-button>

    <p-button
      on:click="clickImportProject"
      variant="outlined"
      attr:disabled="importing"
    >
      <o-if :value="!importing">
        <localized-content>
          <span lang="cn">导入项目</span>
          <span lang="en">Import project</span>
          <span lang="ja">プロジェクトをインポート</span>
        </localized-content>
      </o-if>
      <o-else>
        <n-local-icon
          name="loading"
          style="display: block; margin-right: 4px"
        ></n-local-icon>
        <localized-content>
          <span lang="cn">导入中...</span>
          <span lang="en">Importing...</span>
          <span lang="ja">インポート中...</span>
        </localized-content>
        {{importingProgress}}%
      </o-else>
    </p-button>
  </div>

  <div>
    <h4>
      <localized-content>
        <span lang="cn">查看使用技巧</span>
        <span lang="en">View usage tips</span>
        <span lang="ja">使用方法を表示</span>
      </localized-content>
    </h4>
    <div style="color: var(--md-sys-color-normal)">
      <localized-content>
        <span lang="cn">准备中...</span>
        <span lang="en">Preparing...</span>
        <span lang="ja">準備中...</span>
      </localized-content>
    </div>
  </div>

  <!-- <h4>打包项目</h4>
  <div class="button-line">
    <p-button variant="outlined" disabled>打包为网站</p-button>
    <p-button variant="outlined" disabled>打包为markdown</p-button>
    <p-button variant="outlined" disabled>打包为llms.txt</p-button>
  </div> -->

  <input
    type="file"
    id="importProject"
    style="display: none"
    accept=".zip"
    on:change="handleImportProject"
  />

  <script>
    export const parent = "./layout.html";
    import { getLocalized } from "/packages/i18n/localized-object.js";

    export default async ({ load }) => {
      const { prompt, toast, confirm } = await load("/packages/pui/util.js");
      const { isAIAvailable } = await load("/packages/ai/main.js");
      const { unzip } = await load("/packages/libs/zip/main.js");

      const isSafari = /^((?!chrome|android).)*safari/i.test(
        navigator.userAgent
      );

      const { getSetting } = await load("/packages/none-os/setting.js");

      return {
        data: {
          isSafari,
          creationtime: "",
          currentDirName: "",
          currentUserId: "self",
          existProjects: [], // 已经存在的项目
          remotes: [], // 其他设备
          loadingRemote: false,
          aiAvailable: 0,
          appConfigData: {}, // 当前应用的配置数据
          importing: false,
          importingProgress: 0,
        },
        proto: {
          async handleImportProject(e) {
            const file = e.target.files[0];
            e.target.value = "";

            const files = await unzip(file);

            // 获取目录名
            const projectDirName = files[0].path.split("/")[0];

            // 确保所有文件都在一个目录下
            for (const { path, file } of files) {
              if (path.split("/")[0] !== projectDirName) {
                toast({
                  content: await getLocalized({
                    cn: `导入的文件并非 Luminote 项目文件，请检查后重新导入。`,
                  }),
                  color: "error",
                });
                return;
              }
            }

            const app = this.parent.parent;
            const openedProjects = app._openedProjects;

            // 正在打开则不允许导入
            const isOpened = openedProjects.find(
              (e) => e.__handle.name === projectDirName
            );

            if (isOpened) {
              toast({
                content: await getLocalized({
                  cn: `项目 ${projectDirName} 正在打开中，请先切换或关闭该项目后再尝试导入。`,
                  en: `Project ${projectDirName} is currently open. Please switch to or close this project before attempting to import.`,
                  ja: `プロジェクト ${projectDirName} は開いています。インポートする前にこのプロジェクトを切り替えるか閉じてください。`,
                }),
                color: "error",
              });
              return;
            }

            const existProjects = await app.getExistProjects();

            // 判断是否已经存在
            const isExited = existProjects.find(
              (e) => e.__handle.name === projectDirName
            );

            if (isExited) {
              const result = await confirm({
                content: await getLocalized({
                  cn: `项目 "${isExited.projectName}"(${projectDirName}) 已存在，是否覆盖？`,
                  en: `Project "${isExited.projectName}"(${projectDirName}) already exists. Do you want to overwrite it?`,
                  ja: `プロジェクト "${isExited.projectName}"(${projectDirName}) は既に存在します。上書きしますか？`,
                }),
                yes: await getLocalized({
                  cn: "覆盖",
                  en: "Overwrite",
                  ja: "上書き",
                }),
                cancel: await getLocalized({
                  cn: "取消",
                  en: "Cancel",
                  ja: "キャンセル",
                }),
              });

              if (!result) {
                return;
              }
            }

            this.importing = true;

            const rootHandle = await app.dedicatedHandle();

            const exitedHandle = await rootHandle.get(projectDirName);

            if (exitedHandle) {
              // 先删除
              await exitedHandle.remove();
            }

            let count = 0;
            for (let { path, file } of files) {
              const fileHandle = await rootHandle.get(path, {
                create: "file",
              });

              await fileHandle.write(file);

              count++;
              this.importingProgress = count / files.length;
              this.importingProgress = Math.round(this.importingProgress * 100);
            }

            toast({
              content: await getLocalized({
                cn: `导入 ${projectDirName} 完成`,
                en: `Import of ${projectDirName} completed`,
                ja: `${projectDirName} のインポートが完了しました`,
              }),
            });

            this.importingProgress = 0;
            this.importing = false;
          },
          async clickImportProject() {
            this.shadow.$("#importProject").ele.click();
          },
          clickCreateProject() {
            this.emit("click-create-project", {
              composed: true,
            });
          },
          async handleDeleteProject(data, event) {
            event.stopPropagation();

            const result = await confirm({
              content: await getLocalized({
                cn: `确认要删除 "${data.projectName}"(${data.dirName})？次操作不可逆。`,
                en: `Are you sure you want to delete "${data.projectName}"(${data.dirName})? This action cannot be undone.`,
                ja: `"${data.projectName}"(${data.dirName}) を削除してもよろしいですか？この操作は元に戻せません。`,
              }),
              yes: await getLocalized({
                cn: "是的，确认删除",
                en: "Yes, confirm deletion",
                ja: "はい、削除を確認",
              }),
              cancel: await getLocalized({
                cn: "不删除",
                en: "Do not delete",
                ja: "削除しない",
              }),
            });

            if (!result) {
              return;
            }

            await this.app.deleteProject(data.dirName);

            this.reloadExistProjects();
          },
        },
        attached() {
          (async () => {
            this.aiAvailable = await isAIAvailable();

            const configData = await this.parents.find((e) => e.tag == "o-app")
              ._configData;

            this.appConfigData = configData;

            // if (configData.useAITranslate === undefined) {
            //   configData.useAITranslate = "off";
            // }
            configData.useAITranslate = this.aiAvailable ? "on" : "off";
          })();

          this.emit("active-article", {
            composed: true,
            data: {
              articleId: "home",
            },
          });

          this.emit("update-breadcrumbs", {
            composed: true,
            data: {
              hide: 1,
            },
          });
        },
        detached() {
          this.appConfigData = {};
        },
      };
    };
  </script>
</template>
