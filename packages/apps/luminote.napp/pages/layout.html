<template page>
  <l-m src="/packages/pui/list/list.html"></l-m>
  <l-m src="/packages/pui/button/button.html"></l-m>
  <l-m src="/packages/comps/local-icon/local-icon.html"></l-m>
  <style>
    :host {
      display: block;
      height: 100%;
      background-color: var(--md-sys-color-surface-variant);
    }

    .container {
      display: flex;
      height: 100%;
    }

    .main {
      position: relative;
      flex: 1;
      height: 100%;
    }

    .left {
      width: 260px;
      /* color: var(--md-sys-color-on-normal-container);
      background-color: var(--md-sys-color-normal-container); */
      border-right: var(--md-sys-color-normal-container) solid 1px;
      /* border-right: #aaa solid 1px; */
    }

    /* .right {
      width: 200px;
      border-left: #bbb solid 1px;
    } */
  </style>

  <div class="container">
    <div class="left">
      <div style="height: 80px"></div>
      <p-list>
        <p-list-item collapse-childs="open" button="suffix">
          <n-local-icon
            name="persion"
            slot="prefix"
            style="display: block; margin-right: 4px; font-size: 18px"
          ></n-local-icon>
          我的笔记
          <i toggle-collapse slot="suffix" style="display: none"></i>
          <p-button
            size="small"
            icon
            slot="suffix"
            variant="text"
            on:click="handleAddNote"
            style="z-index: 3; position: absolute; right: 16px"
          >
            <n-local-icon name="add"></n-local-icon>
          </p-button>

          <p-list slot="childs" style="padding-left: 16px">
            <o-fill :value="articles" fill-key="articleId">
              <p-list-item
                button
                attr:active-item=" $data._dataId === $host.currentArticleDataId"
                on:click="$host.handleClickArticle($data)"
              >
                <n-local-icon
                  name="article"
                  slot="prefix"
                  style="display: block; margin-right: 4px; font-size: 18px"
                ></n-local-icon>
                {{$data.title}}
              </p-list-item>
            </o-fill>
          </p-list>
        </p-list-item>
      </p-list>
    </div>
    <div class="main" on:active-article="handleActiveArticle">
      <slot></slot>
    </div>
    <!-- <div class="right"></div> -->
  </div>
  <script>
    export default async ({ load }) => {
      const { createData } = await load("/packages/hybird-data/main.js");

      return {
        data: {
          title: "灵析笔记",
          articles: [],
          currentArticleDataId: null,
        },
        proto: {
          handleClickArticle(data) {
            this.app.goto(`./pages/note.html?article_id=${data._dataId}`);
          },
          handleAddNote(e) {
            e.stopPropagation();
          },
          handleActiveArticle(e) {
            this.currentArticleDataId = e.data.articleId;
          },
        },
        attached() {
          this._article = (async () => {
            // 获取专属文件句柄
            const handle = await this.app.dedicatedHandle();

            // 获取文章专属目录
            const articleHandle = await handle.get("article", {
              create: "dir",
            });

            const articleData = await createData(articleHandle);
            await articleData.ready(true); // 准备完成

            if (!articleData.main) {
              // 尝试测试用的文章
              articleData.main = [
                {
                  title: "示范页面",
                  content: [
                    {
                      type: "h1",
                      value: "基本的文本编辑功能：加粗、斜体、下划线和插入图片",
                    },
                    {
                      type: "paragraph",
                      value:
                        "您可以通过继承 TextEditor 类来扩展这个编辑器的功能，或者直接使用它作为一个简单的富文本编辑器。",
                    },
                    {
                      type: "paragraph",
                      value:
                        "如果您需要添加更多功能，比如字体大小、颜色选择、列表等，可以在工具栏中添加相应的按钮，并在 handleToolbarAction 方法中实现相应的功能。",
                    },
                    {
                      type: "paragraph",
                      value: "",
                    },
                  ],
                },
              ];
            }

            this.app._articleData = articleData;

            this.articles = articleData.main;

            console.log("articleData:", articleData);

            return articleData;
          })();
        },
        detached() {
          this._article &&
            this._article.then((articleData) => {
              articleData.disconnect();
            });
        },
      };
    };
  </script>
</template>
