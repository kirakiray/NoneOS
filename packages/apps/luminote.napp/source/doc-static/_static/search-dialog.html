<template component>
  <l-m src="/packages/pui/dialog/dialog.html"></l-m>
  <l-m src="/packages/pui/progress/progress.html"></l-m>
  <style>
    .search-dialog::part(main) {
      background-color: transparent;
    }

    .search-main {
      padding: 16px;
      background-color: var(--md-sys-color-on-normal);
      border-radius: 16px;
    }
  </style>

  <p-dialog class="search-dialog" :open="open" on:click-mask="open = false">
    <div
      style="max-width: 800px; width: 90vw; height: 80vh"
      on:click="open = false"
    >
      <div class="search-main" on:click="$event.stopPropagation()">
        <p-input
          size="large"
          placeholder="输入要搜索的内容"
          on:input="changeSearch"
          sync:value="searchText"
        >
          <div
            slot="prefix"
            style="
              display: flex;
              align-items: center;
              justify-content: center;
              width: 30px;
              margin-right: 4px;
              font-size: 22px;
            "
          >
            <o-if :value="searching">
              <p-progress type="circle" style="--circle-size: 20"></p-progress>
            </o-if>
            <o-else>
              <svg
                xmlns="http://www.w3.org/2000/svg"
                width="1em"
                height="1em"
                viewBox="0 0 24 24"
                style="display: block"
              >
                <path
                  fill="currentColor"
                  d="m19.6 21l-6.3-6.3q-.75.6-1.725.95T9.5 16q-2.725 0-4.612-1.888T3 9.5t1.888-4.612T9.5 3t4.613 1.888T16 9.5q0 1.1-.35 2.075T14.7 13.3l6.3 6.3zM9.5 14q1.875 0 3.188-1.312T14 9.5t-1.312-3.187T9.5 5T6.313 6.313T5 9.5t1.313 3.188T9.5 14"
                />
              </svg>
            </o-else>
          </div>
        </p-input>
        <p-list style="margin-top: 16px">
          <o-fill :value="searchResult">
            <p-list-item button on:click="$host.clickItem($data)">
              <div style="display: flex; align-items: center">
                <svg
                  xmlns="http://www.w3.org/2000/svg"
                  width="1em"
                  height="1em"
                  viewBox="0 0 24 24"
                  style="display: block; margin-right: 4px; font-size: 18px"
                  slot="prefix"
                >
                  <path
                    fill="currentColor"
                    d="M7 17h7v-2H7zm0-4h10v-2H7zm0-4h10V7H7zM5 21q-.825 0-1.412-.587T3 19V5q0-.825.588-1.412T5 3h14q.825 0 1.413.588T21 5v14q0 .825-.587 1.413T19 21zm0-2h14V5H5zM5 5v14z"
                  />
                </svg>
                <div style="font-weight: bold">{{$data.title}}</div>
              </div>
              <p-list slot="childs" style="--ladder-left: 8px">
                <o-fill :value="$data.matchedContent">
                  <p-list-item
                    button
                    on:click="$host.clickItem($data)"
                    style="border-radius: 16px"
                  >
                    <div style="display: flex; align-items: center">
                      <svg
                        xmlns="http://www.w3.org/2000/svg"
                        width="1em"
                        height="1em"
                        viewBox="0 0 24 24"
                        style="
                          display: block;
                          margin-right: 4px;
                          font-size: 18px;
                        "
                      >
                        <path
                          fill="currentColor"
                          d="M21 7L9 19l-5.5-5.5l1.41-1.41L9 16.17L19.59 5.59z"
                        />
                      </svg>
                      <div :html="$data.highlighted"></div>
                    </div>
                  </p-list-item>
                </o-fill>
              </p-list>
            </p-list-item>
          </o-fill>
        </p-list>
      </div>
    </div>
  </p-dialog>

  <script>
    export default async ({ load }) => {
      const { search } = await load("./search.js");

      return {
        tag: "search-dialog",
        data: {
          open: false,
          lang: "",
          searchText: "",
          searching: false,
          searchResult: [],
        },
        proto: {
          clickItem(data) {
            // 从 data.url 中提取最后一部分文件名
            const fileName = data.url.split("/").pop();
            let path = `./${fileName}`;

            if (data.index) {
              path += `?index=${data.index + 1}`;
            }

            // 关闭搜索对话框
            this.open = false;

            // 获取当前页面路径
            const currentPath = new URL(this.app.current.src).pathname;
            const currentFileName = currentPath.split("/").pop();

            // 移除 path 中的查询参数后提取文件名
            const targetFileName = path.split("?")[0].split("/").pop();

            // 判断当前文件和目标文件是否相同，相同则不跳转
            if (currentFileName === targetFileName) {
              this.app.current.focusTarget(data.index + 1);
              return;
            }

            this.app.goto(path);
          },
          changeSearch() {
            clearTimeout(this._searchTimeout);
            this._searchTimeout = setTimeout(async () => {
              if (!this.searchText.trim()) {
                this.searchResult = [];
                return;
              }

              this.searching = true;

              // 开始搜索内容
              const result = await search(this.searchText, this.lang);

              console.log(result);
              this.searchResult = result;

              this.searching = false;
            }, 300);
          },
        },
      };
    };
  </script>
</template>
