<template page>
  <l-m src="/packages/pui/list/list.html"></l-m>
  <l-m src="/packages/pui/dialog/dialog.html"></l-m>
  <style>
    :host {
      display: block;
    }

    .root-item {
      color: var(--md-sys-color-primary);
      font-weight: bold;
    }
  </style>

  <p-list>
    <p-list-item radius collapse-childs="open" button="suffix">
      <div>
        <span class="root-item">我的设备</span>
        ({{devices.length}})
        <p-button
          size="mini"
          on:click="addDevice"
          style="margin-left: 24px; position: relative; z-index: 3"
        >
          添加设备
        </p-button>
      </div>
      <i collapse-triangle slot="suffix"></i>

      <p-list slot="childs">
        <x-if :value="!devices.length">
          <div
            style="
              line-height: 80px;
              font-size: 12px;
              text-align: center;
              color: #7c7c7c;
            "
          >
            没有其他设备
          </div>
        </x-if>
        <x-else>
          <x-fill :value="devices" fill-key="name">
            <p-list-item button>{{$data}}</p-list-item>
          </x-fill>
        </x-else>
      </p-list>
    </p-list-item>
  </p-list>
  <p-dialog :open="showAddDevice" on:cancel="showAddDevice = false">
    <div slot="title">添加设备</div>
    <o-page src="./add-device.html"></o-page>
  </p-dialog>
  <script>
    export default async ({ load }) => {
      const { getAllCerts } = await load("/packages/core/cert/main.js");
      const { getId } = await load("/packages/core/base/pair.js");
      const { getUser } = await load("/packages/core/user-connect/main.js");
      const { on } = await load("/packages/core/main.js");

      const myId = await getId();

      return {
        data: {
          devices: [
            // {
            //   name: "test 1",
            // },
          ],
          showAddDevice: false,
        },
        proto: {
          async addDevice(e) {
            e.stopPropagation();
            this.showAddDevice = true;
          },
          async reloadMyDevices() {
            const certs = await getAllCerts();

            // 我颁发fully证书给的用户，并且对方也给我了fully证书，就是我的设备
            const myDevices = [];

            // 我颁发的证书
            const issused = [];
            // 颁发给我的证书
            const received = [];

            certs.forEach((cert) => {
              const data = new Map(cert.data);

              cert._data = data;

              const authTo = data.get("authTo");
              const issuer = data.get("issuer");

              if (authTo === myId) {
                received.push(cert);
              } else if (issuer === myId) {
                issused.push(cert);
              }
            });

            if (issused.length) {
              // 查看是否也有收到证书
              await Promise.all(
                issused.map(async (cert) => {
                  const authTo = cert._data.get("authTo");

                  if (!authTo) {
                    return;
                  }

                  const receivedCert = received.find(
                    (cert) => cert._data.get("issuer") === authTo
                  );

                  if (receivedCert) {
                    let userData = await getUser({ userId: authTo });
                    if (userData.length) {
                      userData = Object.fromEntries(userData[0].data);
                    }

                    // 去重并添加
                    if (
                      !myDevices.find(
                        (device) => device.userId === userData.userId
                      )
                    ) {
                      myDevices.push({
                        userName: userData.userName,
                        userId: userData.userId,
                      });
                    }
                  }
                })
              );
            }

            this.devices = myDevices;
          },
        },
        attached() {
          this.reloadMyDevices();

          this._off = on("save-certs", (e) => {
            this.reloadMyDevices();
          });
        },
        detached() {
          this._off && this._off();
        },
      };
    };
  </script>
</template>
