<template page>
  <l-m src="/packages/local-icon/local-icon.html"></l-m>
  <l-m src="/packages/pui/text-field/text-field.html"></l-m>
  <style>
    :host {
      display: block;
      height: 100%;
    }
    .container {
      height: 100%;
    }

    .user-block {
      padding: 4px 8px;
      font-size: 12px;
      border: #7a7a7a solid 1px;
      max-width: 240px;
      border-radius: 6px;
    }

    .user-block div {
      text-overflow: ellipsis;
      overflow: hidden;
      white-space: nowrap;
    }
  </style>
  <div class="container">
    <p>
      通过添加设备操作，确认两个设备是否属于同一人，以便在多个设备之间同步数据。
    </p>
    <p>其中一个设备生成设备码，另一个设备输入设备码，即可完成添加设备操作。</p>

    <x-if :value="step === 0">
      <div style="display: flex; padding-top: 8px">
        <p-button on:click="genCode">
          <n-local-icon
            name="device-mobile-up"
            slot="prefix"
            style="display: inline-block; margin-right: 4px"
          ></n-local-icon>
          生成设备码
        </p-button>
        <p-button on:click="addCode" style="margin-left: 16px">
          <n-local-icon
            name="add-phone"
            slot="prefix"
            style="display: inline-block; margin-right: 4px"
          ></n-local-icon>
          添加设备码
        </p-button>
      </div>
    </x-if>
    <x-else-if :value="step === 1">
      <div style="display: flex; align-items: center">
        我的设备码：
        <span
          style="font-size: 22px; font-weight: bold; font-family: monospace"
        >
          <n-copy-span> {{selfDeviceCode}} </n-copy-span>
        </span>
      </div>
      <div>
        <x-if :value="recevesUser.length">
          <p>确认是我的设备后，点击确认按钮。</p>
        </x-if>
        <x-else>
          <p>请在另一个设备输入此设备码。</p>
        </x-else>
      </div>
      <div>
        <div>
          <x-if :value="!!recevesUser.length">
            <div>匹配到的用户:</div>
            <div style="margin-top: 4px; display: flex; flex-wrap: wrap">
              <x-fill :value="recevesUser">
                <div class="user-block">
                  <x-if :value="$data.userName">
                    <div attr:title="$data.userId">
                      用户ID: {{$data.userId}}
                    </div>
                    <div>用户名: {{$data.userName}}</div>
                    <div style="padding: 4px 0">
                      <p-button size="mini"> 确认是我的设备 </p-button>
                      <p-button
                        size="mini"
                        color="error"
                        variant="text"
                        style="padding-left: 8px"
                      >
                        取消
                      </p-button>
                    </div>
                  </x-if>
                  <x-else>
                    <div>用户ID: {{$data.userId}}</div>
                    <div>
                      <n-local-icon
                        name="loading"
                        style="display: inline-block; vertical-align: bottom"
                      ></n-local-icon>
                      正在连接用户中...
                    </div>
                  </x-else>
                </div>
              </x-fill>
            </div>
          </x-if>
          <x-else>
            <n-local-icon
              name="loading"
              style="display: inline-block; vertical-align: bottom"
            ></n-local-icon>
            正在等待另一端输入设备码...
          </x-else>
        </div>
      </div>
    </x-else-if>
    <x-else>
      <p-text-field sync:value="remoteCode" autofocus style="margin-top: 16px">
        <label> 输入另一个设备的设备码 </label>
        <p-button
          slot="suffix"
          size="small"
          attr:disabled="!remoteCode || !!getUsering"
          on:click="confirmCode"
        >
          确认
        </p-button>
      </p-text-field>
    </x-else>
    <div style="display: flex; margin-top: 16px">
      <div style="flex: 1"></div>
      <p-button variant="text" on:click="clickCancel">取消</p-button>
    </div>
  </div>
  <script>
    export default async ({ load }) => {
      const { servers } = await load("/packages/core/server-connect/main.js");
      const { connectUser } = await load("/packages/core/user-connect/main.js");
      const { on } = await load("/packages/core/main.js");

      return {
        data: {
          selfDeviceCode: null, // 自己的设备码
          remoteCode: null, // 另一端的设备码
          step: 0, // 0:等待选择，1: 生成设备码，2: 输入设备码
          getUsering: false, // 是否正在获取用户
          recevesUser: [],
        },
        proto: {
          async confirmCode() {
            this.getUsering = true;
            let ok = 0;

            for (let server of servers) {
              if (server.status === "connected") {
                try {
                  const result = await server
                    ._post({
                      type: "device-code",
                      getUser: this.remoteCode,
                    })
                    .then((e) => e.json());

                  if (result.ok && !ok) {
                    ok = 1;
                    const otherSideUser = result.user;

                    const userClient = await connectUser({
                      userData: otherSideUser,
                    });

                    console.log("use device", userClient);

                    // receves.push({
                    //   server,
                    //   user: result.user,
                    // });
                  }

                  console.log("getUser result", result);
                } catch (e) {
                  console.log("ping error", e);
                  continue;
                }
              }
            }

            this.getUsering = false;
          },
          async genCode() {
            this.setDeviceCode();
            this.step = 1;

            // 发送设备码到服务器
            servers.forEach(async (server) => {
              if (server.status === "connected") {
                const result = await server
                  ._post({
                    type: "device-code",
                    setCode: this.selfDeviceCode,
                  })
                  .then((e) => e.json());

                console.log("setCode result", result);
              }
            });
          },
          async addCode() {
            this.step = 2;
          },
          setDeviceCode() {
            this.selfDeviceCode = Math.random().toString(36).substr(2, 6);
          },
          clickCancel() {
            setTimeout(() => {
              this.step = 0;

              // 清空接收用户
              this.recevesUser.splice(0);
            }, 300);

            if (this.selfDeviceCode) {
              servers.forEach(async (server) => {
                if (server.status === "connected") {
                  const result = await server
                    ._post({
                      type: "device-code",
                      remove: this.selfDeviceCode,
                    })
                    .then((e) => e.json());

                  console.log("result", result);
                }
              });
            }

            this.emit("cancel");
          },
        },
        attached() {
          this._cancels = [
            on("get-user-card", (e) => {
              const { data } = e;

              if (
                data.way === "device-code" &&
                data.code === this.selfDeviceCode
              ) {
                // 有设备获取了你的信息，并且匹配了设备码
                // 添加用户信息
                this.recevesUser.push({
                  userId: data.userId,
                });
              }
            }),
            on("user-connected", (e) => {
              const { data } = e;

              const targetUser = data.target;

              // 查找旧的并替换新的
              const targetIndex = this.recevesUser.findIndex(
                (e) => e.userId === targetUser.userId
              );

              if (targetIndex > -1) {
                this.recevesUser[targetIndex] = targetUser;
              }
            }),
          ];
        },
        detached() {
          this._cancels && this._cancels.forEach((e) => e());
        },
      };
    };
  </script>
</template>
