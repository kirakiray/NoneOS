<template page>
  <l-m src="/packages/comps/local-icon/local-icon.html"></l-m>
  <l-m src="/packages/comps/copy-span.html"></l-m>
  <l-m src="/packages/pui/text-field/text-field.html"></l-m>
  <l-m src="../comps/finduser-list.html"></l-m>
  <l-m src="../comps/user-card.html"></l-m>
  <style>
    :host {
      display: block;
      background-color: var(--md-sys-color-surface);
      overflow: auto;
    }
    .container {
      padding: 16px 16px 16px;
      max-width: 800px;
      margin: 0 auto;
    }
    h4 {
      margin: 0;
      padding: 0;
      margin-left: 8px;
      color: var(--md-sys-color-primary);
    }
    h5 {
      margin: 8px;
      font-size: 14px;
      color: var(--md-sys-color-primary);
    }

    .invite-code {
      display: inline-block;
      color: var(--md-sys-color-primary);
      font-weight: bold;
      font-family: math;
      letter-spacing: 2px;
      font-size: 30px;
      margin-left: 4px;
    }

    p {
      margin: 0;
      padding: 6px;
    }
  </style>

  <div class="container">
    <div style="display: flex">
      <p-button size="small" on:click="clickBack" icon variant="text">
        <n-local-icon name="back"></n-local-icon>
      </p-button>
      <h4>添加设备</h4>
    </div>
    <div style="display: flex; flex-direction: column; align-items: center">
      <p>
        我的设备码是
        <n-copy-span class="invite-code">{{inviteCode}}</n-copy-span>
      </p>
      <p>
        <p-text-field sync:value="prepareOppoCode" style="width: 320px">
          <label>另一边设备码</label>
          <p-button
            size="small"
            slot="suffix"
            attr:disabled="!prepareOppoCode"
            on:click="clickOppoCode"
          >
            确认
          </p-button>
        </p-text-field>
      </p>
      <p>
        在其中一边设备上输入另一边的设备码，即可将其添加为我的设备。设备码不区分大小写。
      </p>
      <p>通过验证两个设备是否属于同一用户，实现设备间的快速数据同步。</p>
    </div>
    <x-if :value="oppositeDeviceCode">
      <div>
        <h5>已查找到的用户</h5>
        <x-if :value="!finnalUsers.length">
          <div
            style="
              font-size: 12px;
              color: var(--md-sys-color-normal);
              height: 30px;
              display: flex;
              align-items: center;
              justify-content: center;
            "
          >
            未查找到用户
          </div>
        </x-if>
        <x-fill :value="finnalUsers">
          <div style="margin: 16px 0">
            <n-user-card :item="$data"></n-user-card>
          </div>
        </x-fill>
      </div>
    </x-if>

    <h5>我的信息</h5>
    <o-page
      src="./my-info.html"
      style="margin: 0 0 16px 8px; justify-content: flex-start"
    ></o-page>

    <n-finduser-list
      :oppo-users="oppoUsers"
      :self-device-code="inviteCode"
      :opposite-device-code="oppositeDeviceCode"
    ></n-finduser-list>
  </div>
  <script>
    export default async ({ load }) => {
      const { verifyData } = await load("/packages/user/verify.js");
      const { getHash } = await load("/packages/fs/util.js");

      return {
        data: {
          inviteCode: Math.random().toString(36).substring(2, 7).toUpperCase(),
          prepareOppoCode: "",
          oppositeDeviceCode: "",
          oppoUsers: [], // 查找到的目标用户
          finnalUsers: [],
        },
        watch: {
          oppoUsers() {
            this.initFinnalUsers();
          },
        },
        proto: {
          async initFinnalUsers() {
            if (!this.oppoUsers.length) {
              this.finnalUsers = [];
              return;
            }

            const users = [];
            for (const item of this.oppoUsers) {
              const { serverName, authedData } = item;
              const userId = await getHash(authedData.data.publicKey);
              const { result, data } = await verifyData(authedData);

              if (result) {
                // 验证通过
                const targetUser = users.find((e) => e.userId === userId);

                if (targetUser) {
                  // 已经存在
                  targetUser.serNames.push(serverName);
                  continue;
                }

                users.push({
                  userName: data.userName,
                  userId,
                  serNames: [serverName],
                });
              }
            }

            this.finnalUsers = users;
          },
          clickOppoCode() {
            this.oppositeDeviceCode = this.prepareOppoCode;
          },
          clickBack() {
            this.app.back();
          },
        },
        attached() {
          // 向服务端发送邀请码
        },
        detached() {},
      };
    };
  </script>
</template>
