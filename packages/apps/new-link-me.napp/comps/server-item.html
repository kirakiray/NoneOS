<template component>
  <l-m src="/packages/pui/list/list.html"></l-m>

  <style>
    :host {
      display: block;
    }
  </style>

  <p-list-item button="suffix" collapse-childs="open">
    <div style="display: flex">
      <div
        class="circle"
        style="width: 8px; height: 8px; border-radius: 50%; margin-right: 8px"
      ></div>
      <div class="info"></div>
      {{url}} - {{state}} - {{serverName}} - {{serverVersion}}
    </div>

    <i toggle-collapse triangle slot="suffix"></i>
    <p-list slot="childs" style="--ladder-left: 8px">
      <p-list-item>
        <div style="display: flex">
          <localized-content
            style="
              display: block;
              color: var(--md-sys-color-normal);
              margin-right: 8px;
            "
          >
            <span lang="cn">服务器名称</span>
            <span lang="en">Server Name</span>
            <span lang="jp">サーバー名</span>
          </localized-content>
          {{serverName}}
        </div>
      </p-list-item>

      <p-list-item>
        <div style="display: flex">
          <localized-content
            style="
              display: block;
              color: var(--md-sys-color-normal);
              margin-right: 8px;
            "
          >
            <span lang="cn">状态</span>
            <span lang="en">State</span>
            <span lang="jp">状態</span>
          </localized-content>
          {{state}}
        </div>
      </p-list-item>

      <p-list-item>
        <div style="display: flex">
          <localized-content
            style="
              display: block;
              color: var(--md-sys-color-normal);
              margin-right: 8px;
            "
          >
            <span lang="cn">延迟</span>
            <span lang="en">Latency</span>
            <span lang="jp">遅延</span>
          </localized-content>
          {{delay}} ms
        </div>
      </p-list-item>

      <p-list-item>
        <div style="display: flex">
          <localized-content
            style="
              display: block;
              color: var(--md-sys-color-normal);
              margin-right: 8px;
            "
          >
            <span lang="cn">状态更新时间</span>
            <span lang="en">State Update Time</span>
            <span lang="jp">状態更新時間</span>
          </localized-content>
          {{stateUpdateTime}}
        </div>
      </p-list-item>

      <p-list-item>
        <div style="display: flex">
          <localized-content
            style="
              display: block;
              color: var(--md-sys-color-normal);
              margin-right: 8px;
            "
          >
            <span lang="cn">服务器地址</span>
            <span lang="en">Server URL</span>
            <span lang="jp">サーバーアドレス</span>
          </localized-content>
          {{url}}
        </div>
      </p-list-item>
    </p-list>
  </p-list-item>
  <script>
    export default async ({ load }) => {
      const { createUser } = await load("/packages/new-user/main.js");
      const user = await createUser();

      return {
        tag: "n-server-item",
        attrs: {
          url: "",
          serverName: "",
          serverVersion: "",
          delay: "-",
          stateUpdateTime: "-",
        },
        data: {
          state: "",
          _offs: [],
          _serverClient: null,
        },
        watch: {
          url(newVal) {
            this.initServerState();
          },
        },
        proto: {
          async updateInfo() {
            this.state = this._serverClient.state;
            this.serverName = this._serverClient.serverName;
            this.serverVersion = this._serverClient.serverVersion;
            this.delay = this._serverClient.delay;
            this.stateUpdateTime = new Date(
              this._serverClient.stateUpdateTime
            ).toLocaleString();
          },
          async initServerState() {
            if (this._offs.length) {
              this._offs.forEach((off) => off());
              this._offs = [];
            }

            const { url } = this;

            this._serverClient = await user.connectServer(url, {
              waitForAuthed: false,
            });

            this.updateInfo();

            this._offs.push(
              this._serverClient.bind("change-state", () => this.updateInfo()),
              this._serverClient.bind("server-info", () => this.updateInfo())
            );
          },
        },
        detached() {
          if (this._offs.length) {
            this._offs.forEach((off) => off());
            this._offs = [];
          }
        },
      };
    };
  </script>
</template>
