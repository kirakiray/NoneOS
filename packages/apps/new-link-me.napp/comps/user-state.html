<template component>
  <l-m src="/packages/comps/local-icon/local-icon.html"></l-m>
  <style>
    :host {
      display: block;
      color: var(--md-sys-color-normal);
      font-size: 20px;
    }

    :host([state="error"]) {
      color: red;
    }

    :host([state="server"]) {
      color: var(--md-sys-color-primary);
    }

    :host([state="rtc"]) {
      color: var(--md-sys-color-success);
    }
  </style>
  <o-if :value="state === 'server'">
    <n-local-icon name="server-proxy"></n-local-icon>
  </o-if>
  <o-else-if :value="state === 'rtc'">
    <n-local-icon name="p2p"></n-local-icon>
  </o-else-if>
  <o-else-if :value="state === 'error'">
    <n-local-icon name="error"></n-local-icon>
  </o-else-if>
  <o-else>
    <n-local-icon name="loading"></n-local-icon>
  </o-else>
  <script>
    export default async ({ load }) => {
      const { createUser } = await load("/packages/new-user/main.js");
      const localUser = await createUser();

      return {
        tag: "n-user-state",
        data: {
          userid: null,
        },
        attrs: {
          state: null,
        },
        watch: {
          async userid(userId) {
            this.refreshState();
          },
        },
        proto: {
          async refreshState() {
            try {
              const remoteUser = await localUser.connectUser(this.userid);

              if (this._oldRemoteUser !== remoteUser) {
                if (this._cancel) {
                  this._cancel();
                }

                this._cancel = remoteUser.bind("mode-change", (mode) => {
                  this.refreshState();
                });

                this._oldRemoteUser = remoteUser;
              }

              if (remoteUser.mode === 1) {
                this.state = "server";
              } else if (remoteUser.mode === 2) {
                this.state = "rtc";
              }
            } catch (error) {
              // 找不到用户
              this.state = "error";
            }
          },
        },
        detached() {},
      };
    };
  </script>
</template>
