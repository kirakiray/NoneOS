<template page>
  <l-m src="/packages/pui/list/list.html"></l-m>
  <l-m src="/packages/pui/button/button.html"></l-m>
  <l-m src="/packages/pui/input/input.html"></l-m>
  <l-m src="../comps/server-item.html"></l-m>
  <style>
    :host {
      display: block;
    }
    h4 {
      display: flex;
      margin: 0;
      padding: 0;
    }
  </style>
  <p-list-item button="suffix" collapse-childs="open">
    <h4>
      <localized-content style="color: var(--md-sys-color-primary)">
        <span lang="en">My Servers</span>
        <span lang="cn">我的服务器</span>
        <span lang="jp">マイサーバー</span>
      </localized-content>
      ({{ list.length }})
    </h4>

    <i toggle-collapse triangle slot="suffix"></i>
    <p-list slot="childs">
      <o-fill :value="list">
        <p-list-item>
          <n-server-item :url="$data.url">
            <div>
              <p-button
                on:click="$host.deleteServer($index,$data)"
                variant="outlined"
                color="error"
                size="small"
                style="display: inline-block"
              >
                <localized-content>
                  <span lang="en">Delete</span>
                  <span lang="cn">删除</span>
                  <span lang="jp">削除</span>
                </localized-content>
              </p-button>
            </div>
          </n-server-item>
        </p-list-item>
      </o-fill>
      <p-list-item>
        <p-input sync:value="newServerUrl" on:keydown="handleKeydown">
          <label> 添加新服务器 </label>
          <p-button
            on:click="addServer"
            variant="text"
            size="small"
            slot="suffix"
            attr:disabled="!newServerUrl.length"
          >
            添加
          </p-button>
        </p-input>
      </p-list-item>
    </p-list>
  </p-list-item>
  <script>
    export default async ({ load }) => {
      const { confirm, toast } = await load("/packages/pui/util.js");
      const { createUser } = await load("/packages/new-user/main.js");
      const { getLocalized } = await load("/packages/i18n/localized-object.js");
      const user = await createUser();

      const serverManager = await user.serverManager();

      return {
        data: {
          list: [],
          newServerUrl: "",
        },
        proto: {
          // 验证URL是否有效
          isValidUrl(string) {
            try {
              const url = new URL(string);
            } catch (_) {
              return false;
            }
          },
          async addServer() {
            if (!this.newServerUrl) {
              return;
            }

            // 验证URL有效性
            if (!this.isValidUrl(this.newServerUrl)) {
              toast({
                content: await getLocalized({
                  cn: "无效的服务器地址，请输入有效的HTTP或HTTPS协议地址",
                  en: "Invalid server address, please enter a valid HTTP or HTTPS protocol address",
                  jp: "無効なサーバーアドレスです、有効なHTTPまたはHTTPSプロトコルアドレスを入力してください",
                }),
                color: "error",
              });
              return;
            }

            this.list.push({ url: this.newServerUrl });
            this.newServerUrl = "";
          },
          async deleteServer(index, item) {
            const result = await confirm({
              title: await getLocalized({
                cn: "删除握手服务器 ",
                en: "Delete Handshake Server ",
                jp: "ハンドシェイクサーバーを削除する ",
              }),
              content: await getLocalized({
                cn: `确定删除第${index + 1}个握手服务器(${item.url})吗？`,
                en: `Are you sure you want to delete the ${
                  index + 1
                }th handshake server (${item.url})?`,
                jp: `第${index + 1}つのハンドシェイクサーバー (${
                  item.url
                }) を削除しますか？`,
              }),
            });

            if (!result) {
              return;
            }

            this.list.splice(index, 1);
          },
        },
        async attached() {
          this.list = serverManager.data;
        },
        detached() {
          this.list = [];
        },
      };
    };
  </script>
</template>
