<template page>
  <l-m src="/packages/pui/list/list.html"></l-m>
  <l-m src="../comps/server-item.html"></l-m>
  <style>
    :host {
      display: block;
    }
    h4 {
      display: flex;
      margin: 0;
      padding: 0;
    }
  </style>
  <p-list-item button="suffix" collapse-childs="open">
    <h4>
      <localized-content style="color: var(--md-sys-color-primary)">
        <span lang="en">My Servers</span>
        <span lang="cn">我的服务器</span>
        <span lang="jp">マイサーバー</span>
      </localized-content>
      ({{ list.length }})
    </h4>

    <i toggle-collapse triangle slot="suffix"></i>
    <p-list slot="childs">
      <o-fill :value="list">
        <p-list-item>
          <n-server-item :url="$data.url">
            <div>
              <p-button
                on:click="$host.deleteServer($index,$data)"
                variant="outlined"
                color="error"
                size="small"
                style="display: inline-block"
              >
                删除该服务器
              </p-button>
            </div>
          </n-server-item>
        </p-list-item>
      </o-fill>
    </p-list>
  </p-list-item>
  <script>
    export default async ({ load }) => {
      const { confirm } = await load("/packages/pui/util.js");
      const { createUser } = await load("/packages/new-user/main.js");
      const { getLocalized } = await load("/packages/i18n/localized-object.js");
      const user = await createUser();

      const serverManager = await user.serverManager();

      return {
        data: {
          list: [],
        },
        proto: {
          async deleteServer(index, item) {
            const result = await confirm({
              title: await getLocalized({
                cn: "删除握手服务器 ",
              }),
              content: await getLocalized({
                cn: `确定删除第${index + 1}个握手服务器(${item.url})吗？`,
              }),
            });

            if (!result) {
              return;
            }

            this.list.splice(index, 1);
          },
        },
        async attached() {
          this.list = serverManager.data;
        },
        detached() {
          this.list = [];
        },
      };
    };
  </script>
</template>
