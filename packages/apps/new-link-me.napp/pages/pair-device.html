<template page>
  <l-m src="/packages/comps/local-icon/local-icon.html"></l-m>
  <style>
    :host {
      display: block;
    }
  </style>
  <div style="display: flex; align-items: center">
    <n-local-icon
      name="loading"
      style="margin-right: 8px; display: block"
    ></n-local-icon>
    <o-if :value="waitConfirmUsers.length === 0"> 等待对方确认中... </o-if>
    <o-else> 有 {{waitConfirmUsers.length}} 个用户等待确认 </o-else>
  </div>

  <script>
    export default async ({ load }) => {
      const { createUser } = await load("/packages/new-user/main.js");
      const { verify } = await load("/packages/new-user/util/verify.js");
      const { getHash } = await load("/packages/fs/util.js");
      const localUser = await createUser();

      return {
        data: {
          waitConfirmUsers: [], // 等待确认的用户
        },
        attached() {
          this._off = localUser.bind("receive-data", async (e) => {
            const { data: receivedData, fromUserId: senderUserId } = e.detail;

            if (receivedData.goal === "pair-confirm") {
              this.clicked = true;
            }

            let storedInviteCode = sessionStorage.getItem(
              "__sessionInviteCode"
            );

            if (receivedData.inviteCode !== storedInviteCode) {
              // TODO: 邀请码不匹配，提示用户可能有攻击
              debugger;
              return;
            }

            const verificationResult = await verify(receivedData);

            if (!verificationResult) {
              // TODO: 验证失败，提示用户可能有攻击
              throw new Error("用户卡片签名错误，可能有攻击");
            }

            const receivedUserId = await getHash(receivedData.publicKey);

            if (receivedUserId !== receivedData.userId) {
              // TODO: 用户ID不匹配，提示用户可能有攻击
              throw new Error("用户ID不匹配，可能有攻击");
            }

            // 验证证书内容是否正确
            const deviceCertificate = receivedData.cert;

            const certificateVerificationResult = await verify(
              deviceCertificate
            );

            if (!certificateVerificationResult) {
              // TODO: 验证失败，提示用户可能有攻击
              throw new Error("证书签名错误，可能有攻击");
            }

            const certificatePublicKeyHash = await getHash(
              deviceCertificate.publicKey
            );

            if (
              certificatePublicKeyHash !== deviceCertificate.issuedBy ||
              certificatePublicKeyHash !== receivedUserId
            ) {
              // TODO: 用户ID不匹配，提示用户可能有攻击
              throw new Error("用户ID不匹配，可能有攻击");
            }

            if (deviceCertificate.issuedTo !== localUser.userId) {
              // TODO: 用户ID不匹配，提示用户可能有攻击
              throw new Error("不是授权给我的设备证书，可能有攻击");
            }

            // 确认成功，加入等待用户
            this.waitConfirmUsers.push(receivedData);
          });
        },
        detached() {
          this._off();
        },
      };
    };
  </script>
</template>
