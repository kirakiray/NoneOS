<template component>
  <l-m src="/packages/pui/list/list.html"></l-m>
  <l-m src="/packages/comps/moment-span.html"></l-m>
  <style>
    :host {
      display: block;
    }
  </style>

  <o-if :value="!models">
    <p style="color: var(--md-sys-color-error)">
      无法连接到本地Ollama服务，请检查Ollama服务是否已启动，若已启动可尝试重启服务。
    </p>
    <p style="color: var(--md-sys-color-error)">
      若尚未安装Ollama，可访问
      <a href="https://ollama.com/">ollama.com</a> 进行下载和安装。
    </p>
  </o-if>
  <o-else>
    <p-list>
      <o-fill :value="models" fill-key="digest">
        <p-list-item collapse-childs="false" button="suffix">
          <n-local-icon
            name="ai-chip"
            slot="prefix"
            style="display: block; margin-right: 6px"
          ></n-local-icon>
          <div style="display: flex">
            {{ $data.name }}
            <span
              style="
                display: block;
                margin: 0 16px 0 auto;
                font-size: 12px;
                color: var(--md-sys-color-normal);
              "
            >
              {{$host.getFileSize($data.size)}}
            </span>
          </div>
          <i toggle-collapse triangle slot="suffix"></i>
          <p-list slot="childs" style="--parent-left: 16px">
            <!-- <p-list-item>
              模型大小: {{$host.getFileSize($data.size)}}
            </p-list-item> -->
            <p-list-item>
              修改时间: {{$host.getTime($data.modified_at)}}</p-list-item
            >
            <p-list-item> digest: {{$data.digest}} </p-list-item>
            <p-list-item>
              <div>
                <p-button
                  color="error"
                  size="small"
                  on:click="$host.deleteModel($data)"
                  >删除该模型</p-button
                >
              </div>
            </p-list-item>
          </p-list>
        </p-list-item>
      </o-fill>
    </p-list>
  </o-else>
  <script>
    export default async ({ load }) => {
      const { getOllamaModels, deleteOllamaModel } = await load(
        "/packages/ai/util.js"
      );
      const { toast, confirm } = await load("/packages/pui/util.js");

      return {
        tag: "local-ollama-tags",
        data: {
          models: [],
          requiredModels: ["nomic-embed-text", "qwen3:4b"], // 内部严选的模型
        },
        proto: {
          async deleteModel(data) {
            const ok = await confirm({
              title: "删除模型",
              content: `确认删除模型 ${data.name} 吗？`,
            });

            if (!ok) {
              return;
            }

            await deleteOllamaModel(data.name);

            toast({
              content: `删除 ${data.name} 成功`,
              color: "success",
            });

            this.refreshModels();
          },
          getFileSize(size) {
            if (size < 1024) {
              return size + "B";
            }
            if (size < 1024 * 1024) {
              return (size / 1024).toFixed(2) + "KB";
            }
            if (size < 1024 * 1024 * 1024) {
              return (size / 1024 / 1024).toFixed(2) + "MB";
            }
            return (size / 1024 / 1024 / 1024).toFixed(2) + "GB";
          },
          getTime(time) {
            return new Date(time).toLocaleString();
          },
          async refreshModels() {
            this.models = await getOllamaModels();
          },
        },
        attached() {
          this.refreshModels();
        },
      };
    };
  </script>
</template>
