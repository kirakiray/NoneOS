<template component>
  <style>
    :host {
      display: block;
      user-select: text;
    }

    .data-block {
      display: block;
      font-size: 12px;
    }

    .data-line {
      display: flex;
      padding-left: 1em;
      line-height: 1.2em;
    }

    .data-key {
      color: #bababa;
    }

    .mark-el {
      display: inline-flex;
      margin: 0 2px;
      color: #e3e3e3;
      font-size: 12px;
    }

    :host {
      --color-str: #1b9bd2;
      --color-num: #9480f7;
    }
  </style>
  <div class="main"></div>
  <script>
    export default {
      tag: "n-log-block",
      attrs: {
        str: "", // json字符串
      },
      watch: {
        str(str) {
          setTimeout(() => {
            const { jsonData } = this;
            if (jsonData) {
              const el = createEl(jsonData);
              this.shadow.$(".main").html = "";
              this.shadow.$(".main").push(el);
            }
          });
        },
      },
      proto: {
        get jsonData() {
          try {
            return JSON.parse(this.str);
          } catch (err) {
            return {};
          }
        },
      },
    };

    const createEl = (obj) => {
      let el = $(`<div class="data-block"></div>`);

      if (Array.isArray(obj)) {
        Object.entries(obj).forEach(([key, val]) => {
          const line = $(`<div class="data-line">
              <div class="data-val">${getValEl(val)}</div>
              <span class="mark-el" style="align-items: flex-end;">,</span>
          </div>`);

          el.push(line);
        });

        el = `<div>
                <span class="mark-el">[</span>
                ${el.ele.outerHTML}
                <span class="mark-el">]</span>
              </div>`;
      } else {
        Object.entries(obj).forEach(([key, val]) => {
          const line = $(`<div class="data-line">
              <div class="data-key">${key}</div>
              <span class="mark-el"> : </span>
              <div class="data-val">${getValEl(val)}</div>
          </div>`);

          el.push(line);
        });

        el = `<div>
                <span class="mark-el">{</span>
                ${el.ele.outerHTML}
                <span class="mark-el">}</span>
              </div>`;
      }

      return el;
    };
    const getValEl = (val) => {
      if (typeof val === "number") {
        return `<span style="color:var(--color-num)">${val}</span>`;
      } else if (typeof val === "string") {
        return `<span style="color:var(--color-str)">'${val}'</span>`;
      } else if (val instanceof Object) {
        return createEl(val);
      }
      return `<span style="color:#ddd">'${val}'</span>`;
    };
  </script>
</template>
