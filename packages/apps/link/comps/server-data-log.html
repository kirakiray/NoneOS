<template component>
  <l-m src="./data-log.html"></l-m>
  <l-m src="/packages/pui/button/button.html"></l-m>
  <l-m src="./moment-span.html"></l-m>

  <style>
    :host {
      display: block;
      min-width: 300px;
    }

    .data-log {
      display: block;
      border: rgb(37, 110, 47) solid 1px;
      padding: 8px;
      border-radius: 4px;
      margin: 8px 8px 0 0;
    }

    .log-line {
      font-size: 12px;
    }
    .log-content {
      position: relative;
    }

    .log-content p-button {
      position: absolute;
      right: 0;
      top: -26px;
    }
  </style>
  <div class="data-log">
    <div class="log-line">
      时间:
      <n-moment-span :time="item.time"></n-moment-span>
    </div>
    <div class="log-line">类型: {{logType}}</div>
    <div class="log-content">
      <p-button on:click="showAll = showAll ? null : 1" size="mini">
        {{showAll ? '折叠内容' : '显示所有'}}
      </p-button>
      <n-data-log :str="item._data" :show-all="showAll"></n-data-log>
    </div>
  </div>
  <script>
    export default async ({ load }) => {
      return {
        tag: "server-data-log",
        data: {
          item: {
            _data: "{}",
          },
          showAll: null,
        },
        proto: {
          get logType() {
            try {
              const origin = JSON.parse(this.item._data);
              switch (origin.__type) {
                case "init":
                  return "服务初始化";
                case "agent-connect":
                  const step = origin?.data?.step;

                  if (step) {
                    if (step === "set-candidates") {
                      return "转发-设置候选人";
                    } else if (step === "set-remote") {
                      return "转发-远端设置offer";
                    } else if (step === "answer-remote") {
                      return "转发-回答远端offer";
                    }
                  }

                  return "转发数据";
              }
            } catch (err) {
              return "";
            }
          },
        },
      };
    };
  </script>
</template>
