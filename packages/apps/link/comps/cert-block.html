<template component>
  <l-m src="./moment-span.html"></l-m>
  <l-m src="./user-name.html"></l-m>
  <style>
    :host {
      display: block;
      padding: 8px;
      border-radius: 8px;
      max-width: 300px;
      border: #963a7e solid 1px;
      word-break: break-all;
    }

    .line {
      display: flex;
      align-items: center;
    }
    .line-key {
      font-size: 14px;
      font-weight: bold;
      color: #7a7a7a;
      margin-right: 8px;
    }

    .line-val {
      flex: 1;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }
  </style>
  <!-- <x-fill :value="item">
    <div class="line">
      <div class="line-key">{{$host.getName($data[0])}}</div>
      <div class="line-val">{{$data[1]}}</div>
    </div>
  </x-fill> -->

  <div class="line">
    <div class="line-key">{{getName('issuer')}}</div>
    <div class="line-val">
      <n-user-name :userid="certData.issuer"></n-user-name>
    </div>
  </div>
  <div class="line">
    <div class="line-key">{{getName('authTo')}}</div>
    <div class="line-val">
      <n-user-name :userid="certData.authTo"></n-user-name>
    </div>
  </div>
  <div class="line">
    <div class="line-key">{{getName('permission')}}</div>
    <div class="line-val">{{certData.permission}}</div>
  </div>
  <div class="line">
    <div class="line-key">{{getName('signPublic')}}</div>
    <div class="line-val">{{certData.signPublic}}</div>
  </div>
  <div class="line">
    <div class="line-key">{{getName('creation')}}</div>
    <div class="line-val">
      <n-moment-span :time="certData.creation"></n-moment-span>
    </div>
  </div>
  <div class="line">
    <div class="line-key">{{getName('expire')}}</div>
    <div class="line-val">
      <n-moment-span :time="certData.expire"></n-moment-span>
      {{isExpire}}
    </div>
  </div>

  <div>
    <p-button size="mini" color="error" on:click="deleteCert">
      删除证书
    </p-button>

    <p-button
      size="mini"
      attr:color="isClickCopy ? 'success' : 'primary'"
      on:click="clickCopy"
    >
      {{isClickCopy ? '复制成功' : '复制证书'}}
    </p-button>
  </div>

  <script>
    export default async ({ load }) => {
      const { get } = await load("/packages/fs/handle/index.js");
      const { enqueue, confirm } = await load("/packages/pui/util.js");

      return {
        tag: "n-cert-block",
        data: {
          fid: "", // 寄宿的文件名
          item: {},
          sign: "", // 指纹
          certData: {}, // 主体卡片数据
          isClickCopy: false,
        },
        watch: {
          item(item) {
            this.certData = Object.fromEntries(new Map(item));
          },
        },
        proto: {
          // 复制证书
          async clickCopy() {
            this.isClickCopy = 1;

            // 要导出的数据对象
            const expData = {
              data: this.item.toJSON(),
              sign: this.sign,
            };

            navigator.clipboard.writeText(JSON.stringify(expData));

            clearTimeout(this._ctimer);
            this._ctimer = setTimeout(() => {
              this.isClickCopy = false;
            }, 1500);
          },
          // 删除证书
          async deleteCert() {
            const result = await confirm({
              title: "删除证书",
              content: `确认删除证书？`,
            });

            if (!result) {
              return;
            }

            const certsDir = await get("local/system/user/certs");

            const targetHandle = await certsDir.get(this.fid);

            targetHandle && targetHandle.remove();

            this.emit("delete-end", {
              bubbles: false,
            });
          },
          get isExpire() {
            const expire = new Map(this.item).get("expire");

            if (!/\D/.test(expire) && Date.now() > expire) {
              return `(已过期)`;
            }
            return "";
          },
          getName(key) {
            switch (key) {
              case "issuer":
                return "证书颁发者";
              case "authTo":
                return "授权给";
              case "permission":
                return "权限";
              case "signPublic":
                return "公钥";
              case "creation":
                return "创建时间";
              case "expire":
                return "过期时间";
            }

            return key;
          },
        },
      };
    };
  </script>
</template>
