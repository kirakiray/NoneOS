<template page>
  <l-m src="/packages/pui/text-field/text-field.html"></l-m>
  <l-m src="/packages/pui/select/select.html"></l-m>
  <l-m src="/packages/pui/button/button.html"></l-m>
  <l-m src="../comps/cert-form.html"></l-m>
  <l-m src="../comps/cert-block.html"></l-m>
  <style>
    :host {
      display: block;
    }

    h4 {
      margin: 16px 0 0;
      padding: 4px 0;
      font-size: 14px;
    }
    .container {
      display: flex;
      flex-wrap: wrap;
    }
    n-cert-block {
      margin: 0 8px 8px 0;
    }
  </style>
  <h4>本地证书</h4>
  <div class="container">
    <x-fill :value="certs">
      <n-cert-block
        :item="$data.data"
        :sign="$data.sign"
        :fid="$data.fid"
        :iscache="false"
        on:delete-end="$host.loadCerts()"
      ></n-cert-block>
    </x-fill>
    <x-fill :value="cacheCerts">
      <n-cert-block
        :item="$data.data"
        :sign="$data.sign"
        :fid="$data.fid"
        :iscache="true"
        on:delete-end="$host.loadCerts()"
      ></n-cert-block>
    </x-fill>
  </div>

  <h4>授权证书</h4>
  <n-cert-form></n-cert-form>

  <h4>手动导入证书</h4>
  <p-text-field
    style="max-width: 400px; word-break: break-all"
    multiline
    max-rows="8"
    sync:value="icertVal"
    placeholder="请填入证书内容"
  ></p-text-field>
  <p-button
    style="margin-top: 8px"
    attr:disabled="!icertVal"
    on:click="importCert"
  >
    确认导入
  </p-button>

  <script>
    export const parent = "../outer.html";
    import { get } from "/packages/fs/handle/index.js";
    import { verify } from "/packages/core/base/verify.js";

    export default async ({ load }) => {
      const { enqueue, confirm } = await load("/packages/pui/util.js");
      const { getHash } = await load("/packages/user/util.js");

      return {
        data: {
          certs: [], // 个人收藏的证书
          cacheCerts: [],
          loading: false,
          icertVal: "", // 要导入的内容
        },
        proto: {
          // 手动导入证书
          async importCert() {
            let val = this.icertVal;
            try {
              val = JSON.parse(val);
            } catch (err) {
              console.error(err);
              enqueue({
                content: err.toString(),
                color: "error",
              });
              return;
            }

            // 获取指纹
            const hash = await getHash(val.data);

            const exitedHandle = await get(`local/system/user/certs/${hash}`, {
              create: "file",
            });

            const oldText = await exitedHandle.text();

            if (oldText === this.icertVal) {
              enqueue({
                content: "证书已经存在",
              });
              this.icertVal = "";
              return;
            }

            // 写入内容
            await exitedHandle.write(this.icertVal);

            this.icertVal = "";

            this.loadCerts();

            enqueue({
              content: "导入成功",
              color: "success",
            });
          },
          async loadCerts() {
            this.loading = true;

            // 获取所有证书
            this.certs = await getCerts(await get("local/system/user/certs"));
            const cacheCerts = await getCerts(await get("local/caches/certs"));
            this.cacheCerts = cacheCerts.filter((e) => {
              // 过滤已收藏的证书
              return !this.certs.some((item) => item.fid === e.fid);
            });

            this.loading = false;
          },
        },
        attached() {
          this.emit("update-title", {
            composed: true,
            data: {
              titles: [
                {
                  name: "授权管理",
                },
              ],
            },
          });

          this.loadCerts();
        },
      };
    };

    // 从目录上获取签名文件
    const getCerts = async (certsDirHandle) => {
      if (!certsDirHandle) {
        return [];
      }

      const certs = [];

      for await (let certHandle of certsDirHandle.values()) {
        let item = await certHandle.text();
        if (!item) {
          continue;
        }
        item = await JSON.parse(item);

        // 验证数据是否正确
        const result = await verify(item);

        if (result) {
          // 添加到列表
          certs.push({
            fid: certHandle.name,
            data: item.data,
            sign: item.sign,
          });
        } else {
          // TODO: 异常证书处理
          debugger;
        }
      }

      return certs;
    };
  </script>
</template>
