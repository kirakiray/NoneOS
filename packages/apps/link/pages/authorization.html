<template page>
  <l-m src="/packages/pui/text-field/text-field.html"></l-m>
  <l-m src="/packages/pui/select/select.html"></l-m>
  <l-m src="/packages/pui/button/button.html"></l-m>
  <l-m src="../comps/cert-form.html"></l-m>
  <l-m src="../comps/cert-block.html"></l-m>
  <style>
    :host {
      display: block;
    }

    h4 {
      margin: 0;
      padding: 8px 0;
      font-size: 14px;
    }
    .container {
      display: flex;
      flex-wrap: wrap;
    }
    n-cert-block {
      margin: 0 8px 8px 0;
    }
  </style>
  <h4>本地证书</h4>
  <div class="container">
    <x-fill :value="certs">
      <n-cert-block :item="$data"></n-cert-block>
    </x-fill>
  </div>

  <h4>授权证书</h4>
  <n-cert-form></n-cert-form>
  <script>
    export const parent = "../outer.html";
    import { get } from "/packages/fs/handle/index.js";
    import { verify } from "/packages/core/base/verify.js";

    export default async () => {
      return {
        data: {
          certs: [],
          loading: false,
        },
        proto: {
          async loadCerts() {
            this.loading = true;

            const handle = await get("local/system/user/certs");

            if (handle) {
              const certs = [];

              for await (let certHandle of handle.values()) {
                let item = await certHandle.text();
                item = await JSON.parse(item);

                // 验证数据是否正确
                const result = await verify(item);

                if (result) {
                  // 添加到列表
                  certs.push(item.data);
                } else {
                  // TODO: 异常证书处理
                  debugger;
                }
              }

              this.certs = certs;
            }

            this.loading = false;
          },
        },
        attached() {
          this.emit("update-title", {
            composed: true,
            data: {
              titles: [
                {
                  name: "授权管理",
                },
              ],
            },
          });

          this.loadCerts();
        },
      };
    };
  </script>
</template>
