<template page>
  <style>
    :host {
      display: block;
    }
    h4 {
      font-size: 16px;
      margin: 24px 0 8px;
      color: var(--md-sys-color-primary);
    }

    h4:first-of-type {
      margin-top: 0;
    }
  </style>
  <h4><n-desc name="otherDevices" space="bookmarks"></n-desc></h4>
  <div style="font-size: 12px; margin-bottom: 4px">
    <n-desc name="syncTips" space="bookmarks"></n-desc>
  </div>
  <h4><n-desc name="localOperations" space="bookmarks"></n-desc></h4>
  <p-button on:click="clickOutput" attr:disabled="!cardsLength">
    <n-desc name="exportData" space="bookmarks"></n-desc>
  </p-button>
  <div style="font-size: 12px; margin-bottom: 16px; margin-top: 4px">
    <n-desc name="exportDataDesc" space="bookmarks"></n-desc>
  </div>
  <p-button on:click="clickInput"
    ><n-desc name="importData" space="bookmarks"></n-desc
  ></p-button>
  <div style="font-size: 12px; margin-bottom: 16px; margin-top: 4px">
    <n-desc name="importDataDesc" space="bookmarks"></n-desc>
  </div>
  <input
    style="display: none"
    id="inputer"
    type="file"
    accept="application/json"
    on:change="inputChange"
  />
  <p-button on:click="clickClear" color="error" attr:disabled="!cardsLength"
    ><n-desc name="clearData" space="bookmarks"></n-desc
  ></p-button>
  <div style="font-size: 12px; margin-bottom: 16px; margin-top: 4px">
    <n-desc name="clearDataDesc" space="bookmarks"></n-desc>
  </div>
  <script>
    export default async ({ load }) => {
      const { toast, confirm } = await load("/packages/pui/util.js");
      const { createData } = await load("/packages/hybird-data/main.js");
      const { getText } = await load("/packages/i18n/data.js");

      return {
        data: {
          cardsLength: 0,
        },
        proto: {
          async clickInput() {
            const mainData = await this.app._mainData;
            await mainData.ready(true);

            if (this.cardsLength) {
              // 查看是否已经有数据，有的话提示覆盖
              const res = await confirm({
                content: getText("importConfirm", "bookmarks"),
                yes: getText("overwrite", "bookmarks"),
                cancel: getText("cancel", "bookmarks"),
              });

              if (!res) return;
            }

            // 先选择文件
            this.shadow.$("#inputer").ele.click();
          },
          inputChange(e) {
            const file = e.target.files[0];
            if (!file) return;
            e.target.value = "";
            const reader = new FileReader();
            reader.readAsText(file);
            reader.onload = async (e) => {
              try {
                const data = JSON.parse(e.target.result);
                // 验证导入数据的格式
                if (!data || typeof data !== "object") {
                  throw new Error("导入的数据格式不正确");
                }

                const mainData = await this.app._mainData;
                await mainData.ready(true);

                mainData.cards.splice(0, mainData.cards.length, ...data.cards);
                Object.assign(mainData.setting, data.setting);
                this.cardsLength = mainData.cards.length;
                toast({
                  content: getText("importSuccess", "bookmarks"),
                  color: "success",
                });
              } catch (err) {
                toast({
                  content: getText("importFailed", "bookmarks", {
                    error: err.message,
                  }),
                  color: "error",
                });
                console.error("数据导入错误:", err);
              }
            };
          },
          async clickOutput() {
            const mainData = await this.app._mainData;
            await mainData.ready(true);

            const data = JSON.stringify(mainData);

            const blob = new Blob([data], { type: "application/json" });
            const a = document.createElement("a");
            a.href = URL.createObjectURL(blob);
            a.download = "bookmarks.json";
            a.click();
            toast({
              content: getText("exportSuccess", "bookmarks"),
              color: "success",
            });
            URL.revokeObjectURL(a.href); // 释放URL对象
          },
          async clickClear() {
            const mainData = await this.app._mainData;
            await mainData.ready(true);
            const res = await confirm({
              color: "error",
              title: getText("clearData", "bookmarks"),
              content: getText("clearConfirm", "bookmarks"),
              yes: getText("clear", "bookmarks"),
              cancel: getText("cancel", "bookmarks"),
            });
            if (!res) return;
            mainData.cards.splice(0, mainData.cards.length);
            this.cardsLength = 0;
            toast({
              content: getText("clearSuccess", "bookmarks"),
              color: "success",
            });
          },
        },
        async attached() {},
      };
    };
  </script>
</template>
