<template page>
  <style>
    :host {
      display: block;
    }
    h4 {
      font-size: 16px;
      margin: 24px 0 8px;
      color: var(--md-sys-color-primary);
    }

    .inputer-line {
      margin-top: 8px;
      display: flex;
      align-items: center;
    }

    .inputer-line p-input {
      width: 56px;
      margin-left: 16px;
    }

    .inputer-line p-slider {
      margin-left: 16px;
    }

    .bg-opts {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 4px;
    }

    .bg-opts p-select,
    .bg-opts p-input {
      display: inline-block;
      min-width: 100px;
      margin: 12px 12px 0 0;
    }
    .bg-opts p-input {
      min-width: 160px;
    }
  </style>
  <div>
    <h4>尺寸设置</h4>
    <div class="inputer-line">
      块宽度
      <p-slider no-bubble sync:value="setting.width" min="100" max="300">
      </p-slider>
      <p-input readonly sync:value="setting.width" size="small"></p-input>
    </div>
    <div class="inputer-line">
      块高度
      <p-slider no-bubble sync:value="setting.height" min="50" max="150">
      </p-slider>
      <p-input readonly sync:value="setting.height" size="small"></p-input>
    </div>
    <div class="inputer-line">
      块间隔
      <p-slider no-bubble sync:value="setting.space" min="2" max="40">
      </p-slider>
      <p-input readonly sync:value="setting.space" size="small"></p-input>
    </div>
    <div class="inputer-line">
      容器宽度
      <p-slider
        no-bubble
        sync:value="setting.containerMaxWidth"
        min="800"
        max="2400"
      >
      </p-slider>
      <p-input
        readonly
        sync:value="setting.containerMaxWidth"
        size="small"
      ></p-input>
    </div>
    <p-button size="small" on:click="resetSize" style="margin-top: 8px">
      恢复默认尺寸
    </p-button>
    <h4>背景设置</h4>
    <div style="display: flex; align-items: flex-end">
      <div
        style="
          width: 100px;
          height: 60px;
          border: var(--md-sys-color-primary) solid 1px;
          background-size: contain;
          background-repeat: no-repeat;
          background-position: center center;
        "
        :style.background-image="`url(${setting.bgurl || ''})`"
        :style.background-color="setting.bgcolor"
      ></div>
      <div>
        <o-if :value="setting.bgurl !== defaultBgurl">
          <div>
            <p-button
              size="small"
              on:click="setting.bgurl = defaultBgurl"
              style="margin-left: 8px"
            >
              还原默认背景图
            </p-button>
          </div>
        </o-if>

        <div>
          <p-button
            size="small"
            on:click="shadow.$('#bgimgInputer').ele.click()"
            style="margin-left: 8px; margin-top: 4px"
          >
            更换背景图
          </p-button>
          <input
            type="file"
            accept="image/*"
            style="display: none"
            id="bgimgInputer"
            on:change="changeBgImg"
          />
        </div>
      </div>
    </div>
    <div class="bg-opts">
      <p-select size="small" sync:value="setting.bgposition">
        <label>背景对齐</label>
        <p-option value="center top">上中</p-option>
        <p-option value="center center">正中</p-option>
        <p-option value="center bottom">下中</p-option>
        <p-option value="left top">左上方</p-option>
        <p-option value="left center">左中</p-option>
        <p-option value="left bottom">左下方</p-option>
        <p-option value="right top">右上方</p-option>
        <p-option value="right center">右中</p-option>
        <p-option value="right bottom">右下方</p-option>
      </p-select>
      <p-select size="small" sync:value="setting.bgsize">
        <label>背景显示模式</label>
        <p-option value="cover">填充满（可能裁剪）</p-option>
        <p-option value="contain">完整显示（可能留白）</p-option>
        <p-option value="auto">原始尺寸</p-option>
      </p-select>
      <o-if :value="setting.bgsize !== 'cover'">
        <p-select size="small" sync:value="setting.bgrepeat">
          <label>背景平铺</label>
          <p-option value="no-repeat">不平铺</p-option>
          <p-option value="repeat">平铺</p-option>
        </p-select>
      </o-if>
    </div>

    <div
      class="bg-opts"
      style="display: flex; align-items: flex-start; margin-top: 16px"
    >
      <span style="display: inline-block; padding-top: 8px">背景色</span>
      <p-color-picker
        sync:value="setting.bgcolor"
        style="margin-left: 8px"
      ></p-color-picker>
    </div>
    <!--
        <div>感谢，图片来自unsplsh的具体地址</div> -->
  </div>
  <script>
    export default {
      data: {
        setting: {
          width: 200,
          height: 80,
          space: 16,
          containerMaxWidth: 1200,
          bgurl: "", // 背景图片地址
          bgsize: "",
          bgrepeat: "",
          bgposition: "",
          bgcolor: "", // 背景色
          sort: "custom", // 排序方式
        },
      },
      proto: {
        async changeBgImg(e) {
          const file = e.target?.files[0];

          if (!file) {
            return;
          }

          // 写入到应用文件夹下
          const appDataHandle = await this.app.dedicatedHandle();

          const bgDir = await appDataHandle.get("bgimg", {
            create: "dir",
          });

          // 删除已存在的背景图
          if ((await bgDir.length()) > 0) {
            for await (let e of bgDir.values()) {
              await e.remove();
            }
          }

          const fileHandle = await bgDir.get(`${file.name}`, {
            create: "file",
          });

          await fileHandle.write(file);

          this.setting.bgurl = `/$${fileHandle.path}`;
        },
        get defaultBgurl() {
          return "/packages/apps/bookmarks.napp/sources/bg/erone-stuff-unsplash.svg";
        },
        resetSize() {
          // 修正尺寸参数
          Object.assign(this.setting, {
            width: 200,
            height: 80,
            space: 16,
            containerMaxWidth: 1200,
          });
        },
      },
      async attached() {
        const mainData = await this.app._mainData;

        this.setting = mainData.setting;
      },
      detached() {
        this.setting = {};
      },
    };
  </script>
</template>
