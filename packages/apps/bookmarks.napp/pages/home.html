<template page>
  <l-m src="/packages/i18n/localized-content.html"></l-m>
  <l-m src="../comps/bookmark-card.html"></l-m>
  <l-m src="../comps/bm-add-card.html"></l-m>
  <l-m src="../comps/bm-common-dialog.html"></l-m>
  <l-m src="/packages/pui/progress/progress.html"></l-m>
  <l-m src="/packages/pui/menu/menu.html"></l-m>
  <l-m src="/packages/pui/menu/menu-area.html"></l-m>
  <l-m src="/packages/pui/menu/bind-contextmenu.html"></l-m>
  <l-m src="/packages/comps/local-icon/local-icon.html"></l-m>
  <l-m src="/packages/pui/select/select.html"></l-m>
  <l-m src="/packages/comps/id-avatar.html"></l-m>
  <l-m src="/packages/comps/id-avatar.html"></l-m>
  <l-m src="../comps/bm-drag-container.html"></l-m>
  <l-m src="../comps/setting-btn.html"></l-m>
  <link rel="stylesheet" href="../common/common.css" />
  <style>
    :host {
      position: relative;
      width: 100%;
      height: 100%;
      /* background: url(/packages/apps/bookmarks.napp/sources/bg/erone-stuff-unsplash.svg); */
      /* background-repeat: no-repeat; */
      /* background-size: cover; */
      /* background-position: center; */
      background-color: var(--bg-color);
      animation: fadein ease 0.5s;
    }

    @keyframes fadein {
      0% {
        opacity: 0;
      }
      100% {
        opacity: 1;
      }
    }

    .tool {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
    }

    .tool-container {
      box-sizing: border-box;
      display: flex;
      align-items: center;
      padding: 16px;
      width: 100%;
      /* max-width: 1200px; */
      max-width: calc(var(--max-width, 1200) * 1px);
      margin: 0 auto;
    }

    .main {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      min-height: 300px;
      box-sizing: border-box;
      padding-top: 160px;
      overflow: auto;
    }

    @media screen and (max-width: 540px) {
      .tool {
        background-color: var(--md-sys-color-on-normal);
        z-index: 2;
      }

      .tool-container {
        padding: 8px 16px;
      }

      .main {
        padding-top: 66px;
      }
    }

    .main-inner {
      /* max-width: 1200px; */
      max-width: calc(var(--max-width, 1200) * 1px);
      margin: 0 auto;
    }

    p-menu-item > n-local-icon {
      display: block;
      margin-right: 8px;
      color: var(--md-sys-color-primary);
    }

    n-bookmark-card,
    bm-add-card {
      /* margin: 16px; */
      margin: calc(var(--card-space) * 1px);
    }

    @media screen and (max-width: 540px) {
      n-bookmark-card,
      bm-add-card {
        /* margin: 16px; */
        margin: 4px 8px;
      }
    }

    .breadcrumbs {
      position: relative;
      z-index: 2;
      display: flex;
      align-items: center;
      font-size: 14px;
    }

    .breadcrumbs .breadcrumbs-block {
      display: flex;
      align-items: center;
      margin-right: 16px;
      cursor: pointer;
    }

    .breadcrumbs-block n-local-icon {
      display: block;
      margin-right: 4px;
      font-size: 18px;
      color: var(--md-sys-color-primary);
    }

    .breadcrumbs .breadcrumbs-block:after {
      display: inline-block;
      margin-left: 16px;
      content: "/";
    }
    .breadcrumbs .breadcrumbs-block:last-child {
      cursor: default;
    }

    .breadcrumbs .breadcrumbs-block:last-child:after {
      display: none;
    }
  </style>

  <style>
    :host {
      --card-width: data(setting.width);
      --card-img-height: data(setting.height);
      --card-space: data(setting.space);
      --max-width: data(setting.containerMaxWidth);
    }
  </style>

  <div class="tool">
    <div class="tool-container">
      <div class="breadcrumbs">
        <o-if :value="showNoneosBtn" slot="suffix">
          <p-button
            icon
            size="small"
            variant="outlined"
            on:click="clickNoneOS"
            style="margin-right: 8px; font-size: 12px"
          >
            <img
              src="/packages/others/logo.png"
              alt="None"
              style="width: 18px"
            />
          </p-button>
        </o-if>
        <p-button
          size="small"
          variant="outlined"
          on:click="showSelectDevice = true"
          style="margin-right: 8px"
        >
          <n-id-avatar
            :val="usedUserId"
            slot="prefix"
            style="display: block; width: 20px; height: 20px; margin-right: 8px"
          ></n-id-avatar>
          <localized-content>
            <span lang="cn">切换设备</span>
            <span lang="en">Switch Device</span>
            <span lang="ja">デバイスを切り替える</span>
          </localized-content>
        </p-button>

        <o-fill :value="paths">
          <div
            class="breadcrumbs-block"
            on:click="$host.clickBread($data,$index)"
          >
            <n-local-icon name="folder"></n-local-icon>
            {{$data.name}}
          </div>
        </o-fill>
      </div>

      <bm-setting-btn
        :setting="setting"
        style="margin-left: auto"
      ></bm-setting-btn>
    </div>
  </div>

  <p-bind-contextmenu class="main" auto-close on:open-menu="openMenu">
    <p-menu contextmenu-selector="n-bookmark-card">
      <p-menu-item
        on:click="newTabOpen"
        attr:disabled="menuTargetType !== 'page'"
      >
        <n-local-icon name="tab" slot="prefix"></n-local-icon>
        <localized-content>
          <span lang="cn">在新标签页打开</span>
          <span lang="en">Open in New Tab</span>
          <span lang="ja">新タブで開く</span>
        </localized-content>
      </p-menu-item>
      <hr />
      <p-menu-item
        on:click="editItem"
        attr:disabled="localSelfUserId !== usedUserId"
      >
        <n-local-icon name="edit" slot="prefix"></n-local-icon>
        <o-if :value="menuTargetType === 'page'">
          <localized-content>
            <span lang="cn">编辑网页</span>
            <span lang="en">Edit Web</span>
            <span lang="ja">Webを編集</span>
          </localized-content>
        </o-if>
        <o-else>
          <localized-content>
            <span lang="cn">编辑文件夹</span>
            <span lang="en">Edit Folder</span>
            <span lang="ja">フォルダを編集</span>
          </localized-content>
        </o-else>
      </p-menu-item>
      <p-menu-item
        on:click="clickCopyLink"
        attr:disabled="menuTargetType !== 'page'"
      >
        <n-local-icon name="copy" slot="prefix"></n-local-icon>
        <localized-content>
          <span lang="cn">复制链接</span>
          <span lang="en">Copy URL</span>
          <span lang="ja">URLをコピー</span>
        </localized-content>
      </p-menu-item>
      <p-menu-item
        on:click="deleteItem"
        attr:disabled="localSelfUserId !== usedUserId"
      >
        <n-local-icon name="delete" slot="prefix"></n-local-icon>
        <o-if :value="menuTargetType === 'page'">
          <localized-content>
            <span lang="cn">删除网页</span>
            <span lang="en">Delete Web</span>
            <span lang="ja">Webを削除</span>
          </localized-content>
        </o-if>
        <o-else>
          <localized-content>
            <span lang="cn">删除文件夹</span>
            <span lang="en">Delete Folder</span>
            <span lang="ja">フォルダを削除</span>
          </localized-content>
        </o-else>
      </p-menu-item>
    </p-menu>
    <div class="main-inner">
      <o-if :value="cards?.dataStatus === 'preparing'">
        <p-progress
          type="circle"
          variant="indeterminate"
          style="--circle-size: 80"
        ></p-progress>
      </o-if>
      <o-else>
        <bm-drag-container
          on:change-order="changeOrder"
          on:open-folder="openFolder"
          style="position: relative"
        >
          <o-if :value="paths.length > 1">
            <p-button
              class="hide-in-mobile"
              icon
              on:click="clickBack"
              style="position: absolute; top: -36px"
            >
              <n-local-icon name="back"></n-local-icon>
            </p-button>
          </o-if>
          <o-fill :value="cards">
            <n-bookmark-card
              draggable="true"
              :item="$data"
              :show-card-title="$host.setting.showCardTitle"
              :show-click-count="$host.setting.showClickCount"
            ></n-bookmark-card>
          </o-fill>
          <o-if :value="localSelfUserId === usedUserId">
            <!-- 只有本地数据才可以编辑 -->
            <bm-add-card on:add-web="addWeb" :cards="cards"></bm-add-card>
          </o-if>
        </bm-drag-container>
        <o-if :value="!cards?.length && localSelfUserId !== usedUserId">
          <div style="text-align: center">
            <localized-content>
              <span lang="cn">暂无数据</span>
              <span lang="en">No Data</span>
              <span lang="ja">データなし</span>
            </localized-content>
          </div>
        </o-if>
      </o-else>
    </div>
  </p-bind-contextmenu>

  <bm-common-dialog
    editmode="1"
    sync:open="dialogData.open"
    :item="dialogData.item"
    on:click-save="saveEditedData"
  ></bm-common-dialog>

  <p-dialog :open="showSelectDevice" on:click-mask="showSelectDevice = false">
    <div slot="title">
      <localized-content>
        <span lang="cn">选择设备</span>
        <span lang="en">Select Device</span>
        <span lang="ja">デバイスを選択</span>
      </localized-content>
    </div>
    <o-page
      on:click-item="changeUser"
      on:local-loaded="localLoaded"
      :used-user-id="usedUserId"
      id="devices-page"
      src="./select-device.html"
    ></o-page>
  </p-dialog>
  <script>
    export default async ({ load }) => {
      const { createData } = await load("/packages/hybird-data/main.js");
      const { toast } = await load("/packages/pui/util.js");

      const { getLocalized } = await load("/packages/i18n/localized-object.js");

      const { defaultItemData } = await load("../common/default-item-data.js");

      const { createUser } = await load("/packages/new-user/main.js");

      const localUser = await createUser();

      return {
        data: {
          usedUserId: null, // 当前标签使用中的用户id
          localSelfUserId: localUser.userId, // 本机设备用户id
          // 当前目录路径
          paths: [
            {
              name: await getLocalized({
                cn: "根目录",
                en: "Root Directory",
                ja: "ルートディレクトリ",
              }),
            },
          ],
          cards: [], // 当前显示的数据
          dialogData: {
            open: false,
            item: {
              ...defaultItemData,
            },
          },
          showSelectDevice: false,
          menuTargetType: null,
          showNoneosBtn: !$("none-os"), // 是否显示none-os按钮
          setting: {
            width: 200,
            height: 80,
            space: 16,
            containerMaxWidth: 1200,
            // bgurl:"/packages/apps/bookmarks.napp/sources/bg/erone-stuff-unsplash.svg", // 如果更换过背景图，初始进入时会有闪屏，所以先注释
            bgsize: "cover",
            bgrepeat: "no-repeat",
            bgposition: "center center",
            bgcolor: "rgba(0, 0, 0, 0)", // 背景色
            sort: "custom", // 排序方式
            showClickCount: "off", // 显示点击次数
            showCardTitle: "on", // 显示标题
          },
        },
        watch: {
          setting() {
            if (this._oldbgurl !== this.setting.bgurl) {
              if (this.setting.bgurl) {
                this.css.backgroundImage = `url(${this.setting.bgurl})`;
              } else {
                this.css.backgroundImage = "";
              }
              this._oldbgurl = this.setting.bgurl;
            }

            if (this._oldbgsize !== this.setting.bgsize) {
              this.css.backgroundSize = this.setting.bgsize;
              this._oldbgsize = this.setting.bgsize;
            }

            if (this._oldbgrepeat !== this.setting.bgrepeat) {
              this.css.backgroundRepeat = this.setting.bgrepeat;
              this._oldbgrepeat = this.setting.bgrepeat;
            }

            if (this._oldbgposition !== this.setting.bgposition) {
              this.css.backgroundPosition = this.setting.bgposition;
              this._oldbgposition = this.setting.bgposition;
            }
            if (this._oldbgcolor !== this.setting.bgcolor) {
              this.css.backgroundColor = this.setting.bgcolor;
              this._oldbgcolor = this.setting.bgcolor;
            }
          },
        },
        proto: {
          clickNoneOS() {
            location.href = "/";
          },
          async localLoaded(e) {
            const { mainData } = e.data;

            this.setting = mainData.setting;
          },
          async changeUser(e) {
            // 切换用户
            const { userId, _mainData } = e.data;

            this.showSelectDevice = false;

            this.usedUserId = userId;
            this.paths = [
              {
                name: await getLocalized({
                  cn: "根目录",
                  en: "Root Directory",
                  ja: "ルート ディレクトリ",
                }),
              },
            ];
            this.cards = _mainData.cards;
          },

          // 加载本地备份的用户数据
          async clickBack() {
            if (this.paths.length === 2) {
              this.paths.splice(1);

              const device = this.shadow
                .$("#devices-page")
                .allDevices.find((e) => e.userId === this.usedUserId);

              this.shadow.$("o-page").clickItem(device);

              return;
            }

            if (this.paths.length > 1) {
              const len = this.paths.length;
              this.paths.splice(len - 1);
              this.cards = this.paths[len - 2]._cards;
            }
          },
          async clickBread(data, index) {
            // 点击最后一个不反应
            if (index === this.paths.length - 1) {
              return;
            }

            this.paths.splice(index + 1);

            if (index === 0) {
              const mainData = await this.app._mainData;

              // 点击根目录
              this.cards = mainData.cards;
              return;
            }

            this.cards = this.paths[index]._cards;
          },
          openMenu(e) {
            const {
              data: { target, menu },
            } = e;

            this.menuTargetType = target.item.type;
            this._menuTarget = target;
          },
          changeOrder(e) {
            const { from, to } = e.data;

            // 更新数据
            const dragStartElIndex = this.cards.indexOf(from);
            if (dragStartElIndex < 0 && !this.cards.includes(to)) {
              // 找不到数据，不处理
              return;
            }

            // 先移除
            this.cards.splice(dragStartElIndex, 1);

            // 插入到目标位置
            const targetIndex = this.cards.indexOf(to);

            this.cards.splice(targetIndex, 0, from);
          },
          async clickCopyLink() {
            const _target = this._menuTarget;
            const data = _target.item;

            // 复制网址
            copyTextToClipboard(data.url);
            toast({
              content: await getLocalized({
                cn: "已复制到剪贴板",
                en: "Copied to clipboard",
                ja: "クリップボードにコピーしました",
              }),
              color: "success",
            });
          },
          openFolder(e) {
            const folderItem = e.data;

            this.paths.push({
              name: folderItem.webTitle,
              _cards: folderItem.cards,
            });

            this.cards = folderItem.cards;
          },
          newTabOpen() {
            // const { _target } = this.shadow.$("p-bind-contextmenu");
            const _target = this._menuTarget;
            const data = _target.item;

            _target.openWeb("blank");
          },
          saveEditedData() {
            // const { _target } = this.shadow.$("p-bind-contextmenu");
            const _target = this._menuTarget;
            const data = _target.item;

            const newData = { ...this.dialogData.item };

            if (newData.type === "folder") {
              // 文件夹类型忽略cards属性
              delete newData.cards;
            }

            Object.assign(data, newData);

            if (data.logoType === "default") {
              // 选择的是默认图片，清除其余项
              data.customPic = "";
              data.selectedPic = "";
              data.pastePic = "";
            }

            this.dialogData.open = false;

            // 清空弹窗数据
            Object.assign(this.dialogData.item, {
              ...defaultItemData,
            });
          },
          async editItem() {
            // const { _target } = this.shadow.$("p-bind-contextmenu");
            const _target = this._menuTarget;
            const data = _target.item;

            this.dialogData = {
              open: true,
              item: {
                ...data.toJSON(), // 复制对象，不然会直接修改本体数据
              },
            };
          },

          async deleteItem() {
            // const { _target } = this.shadow.$("p-bind-contextmenu");
            const _target = this._menuTarget;
            const data = _target.item;

            // 让目标进入删除状态
            _target.isDelete = 3;
            _target._delete = () => {
              // 查找并删除
              const targetIndex = this.cards.findIndex((item) => item === data);

              if (targetIndex > -1) {
                this.cards.splice(targetIndex, 1);
              }
            };
          },
          async addWeb({ data }) {
            this.cards.push({ ...data });
          },
        },
        async attached() {},
        async detached() {
          this.cards = [];
          this.setting = {};
        },
      };
    };

    function copyTextToClipboard(text) {
      const textarea = document.createElement("textarea");
      textarea.value = text;
      document.body.appendChild(textarea);
      textarea.select();
      document.execCommand("copy");
      document.body.removeChild(textarea);
    }
  </script>
</template>
