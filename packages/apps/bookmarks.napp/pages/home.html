<template page>
  <l-m src="../comps/bookmark-card.html"></l-m>
  <l-m src="../comps/bm-add-card.html"></l-m>
  <l-m src="../comps/bm-common-dialog.html"></l-m>
  <l-m src="/packages/pui/menu/menu.html"></l-m>
  <l-m src="/packages/pui/menu/menu-area.html"></l-m>
  <l-m src="/packages/pui/menu/bind-contextmenu.html"></l-m>
  <l-m src="/packages/comps/local-icon/local-icon.html"></l-m>
  <style>
    :host {
      position: relative;
      display: flex !important;
      flex-direction: column;
      width: 100%;
      height: 100%;
      background: url(/packages/others/default-bg.jpg) no-repeat;
      background-size: cover;
      background-position: center;
    }

    .tool {
      position: absolute;
      left: 0;
      top: 0;
      width: 100%;
    }

    .tool-container {
      box-sizing: border-box;
      display: flex;
      padding: 16px;
      height: 100px;
      width: 100%;
      max-width: 800px;
      margin: 0 auto;
    }

    .main {
      position: relative;
      flex: 1;
    }

    .main-inner {
      position: absolute;
      left: 0;
      top: 100px;
      width: 100%;
      min-height: 300px;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      align-items: flex-start;
      overflow: auto;
    }

    p-menu-item > n-local-icon {
      display: block;
      margin-right: 8px;
      color: var(--md-sys-color-primary);
    }
  </style>

  <!-- <div class="tool-container"></div> -->

  <div class="tool">
    <div class="tool-container"></div>
  </div>

  <div class="main">
    <p-bind-contextmenu class="main-inner" auto-close>
      <p-menu contextmenu-selector="n-bookmark-card">
        <p-menu-item on:click="newTabOpen">
          <n-local-icon name="tab-group" slot="prefix"></n-local-icon>
          新标签打开
        </p-menu-item>
        <hr />
        <p-menu-item on:click="editItem">
          <n-local-icon name="edit" slot="prefix"></n-local-icon>
          编辑网页
        </p-menu-item>
        <p-menu-item on:click="deleteItem">
          <n-local-icon name="delete" slot="prefix"></n-local-icon>
          删除网页
        </p-menu-item>
      </p-menu>
      <o-fill :value="cards">
        <n-bookmark-card :item="$data"></n-bookmark-card>
      </o-fill>
      <bm-add-card on:add-web="addWeb" :cards="cards"></bm-add-card>
    </p-bind-contextmenu>
  </div>

  <bm-common-dialog
    sync:open="dialogData.open"
    sync:url="dialogData.url"
    sync:web-title="dialogData.webTitle"
    sync:logo-type="dialogData.logoType"
    sync:custom-pic="dialogData.customPic"
    sync:selected-pic="dialogData.selectedPic"
    on:click-save="saveEditedData"
  ></bm-common-dialog>
  <script>
    export default async ({ load }) => {
      const { createData } = await load("/packages/hybird-data/main.js");

      return {
        data: {
          cards: [], // 当前显示的数据
          dialogData: {
            open: false,
            url: "",
            webTitle: "",
            logoType: "",
            customPic: "",
            selectedPic: "",
          },
        },
        proto: {
          newTabOpen() {
            const { _target } = this.shadow.$("p-bind-contextmenu");
            const data = _target.item;

            _target.openWeb("blank");
          },
          saveEditedData() {
            const { _target } = this.shadow.$("p-bind-contextmenu");
            const data = _target.item;

            data.url = this.dialogData.url;
            data.webTitle = this.dialogData.webTitle;
            data.logoType = this.dialogData.logoType;
            data.customPic = this.dialogData.customPic;
            data.selectedPic = this.dialogData.selectedPic;

            if (data.logoType === "default") {
              // 选择的是默认图片，清除其余两项
              data.customPic = "";
              data.selectedPic = "";
            }

            this.dialogData.open = false;

            // 清空弹窗数据
            Object.assign(this.dialogData, {
              url: "",
              webTitle: "",
              logoType: "",
              customPic: "",
              selectedPic: "",
            });
          },
          async editItem() {
            const { _target } = this.shadow.$("p-bind-contextmenu");
            const data = _target.item;

            this.dialogData = {
              open: true,
              url: data.url,
              webTitle: data.webTitle,
              logoType: data.logoType || "default",
              customPic: data.customPic,
              selectedPic: data.selectedPic,
            };
          },

          async deleteItem() {
            const { _target } = this.shadow.$("p-bind-contextmenu");
            const data = _target.item;

            // 查找并删除
            const targetIndex = this.cards.findIndex((item) => item === data);

            if (targetIndex > -1) {
              this.cards.splice(targetIndex, 1);
            }
          },
          async addWeb({ data }) {
            this.cards.push({ ...data });
          },
        },
        async attached() {
          // 获取专属文件句柄
          const handle = await this.app.dedicatedHandle();

          const dataHandle = await handle.get("data", {
            create: "dir",
          });

          const mainData = await createData(dataHandle);

          await mainData.ready(true);

          if (!mainData.cards) {
            // 初始化本地数据
            mainData.cards = [];
          }

          this.cards = mainData.cards;

          console.log(this.cards.toJSON());
        },
        detached() {
          this.cards = [];
        },
      };
    };
  </script>
</template>
