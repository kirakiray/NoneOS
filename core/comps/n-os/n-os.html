<template component>
  <l-m src="@pui/navigation/nav-bar.html"></l-m>
  <l-m src="./comps/os-app-item.html"></l-m>
  <style>
    :host {
      display: block;
      width: 100%;
      height: 100%;
    }
    .container {
      display: flex;
      width: 100%;
      height: 100%;
    }
    .left {
      display: flex;
      flex-direction: column;
      align-items: center;
      width: 60px;
    }
    .left p-nav-bar {
      height: 100%;
      border-radius: 35px;
    }
    .main {
      flex: 1;
    }
    .main o-app {
      height: 100%;
    }
    .apps-mask {
      position: fixed;
      z-index: 9999;
      width: 100%;
      height: 100%;
    }
    .apps-bubble {
      position: absolute;
      z-index: 10000;
      left: 60px;
      bottom: 0;
      width: 40vw;
      height: 500px;
      transition: all cubic-bezier(0, 0, 0, 1) 0.5s;
    }
    .apps-bubble.menu-hide {
      opacity: 0;
      bottom: -100%;
      pointer-events: none;
    }
    .apps-bubble o-app {
      height: 100%;
      background-color: #fff;
      border-radius: 6px;
      box-shadow: rgba(144, 144, 144, 0.1) 0 0 5px;
    }
  </style>
  <div class="container">
    <div class="left">
      <x-fill :value="using">
        <os-app-item
          on:click="$host.currentAppPath = $data.path"
          :name="$data.name"
          :active="$host.currentAppPath === $data.path ? '' : null"
        >
          <img attr:src="$data.iconUrl" />
        </os-app-item>
      </x-fill>

      <os-app-item
        :name="'Apps'"
        style="margin-top: auto"
        on:click="menuActived = !menuActived"
      >
        <img width="34" src="../../apps/manager/icon.svg" />
      </os-app-item>
    </div>
    <div class="main">
      <!-- <o-app src=""></o-app> -->
    </div>
    <x-if :value="menuActived">
      <div class="apps-mask" on:click="menuActived = false"></div>
    </x-if>
    <div class="apps-bubble" class:menu-hide="!menuActived">
      <o-app src="/core/apps/manager/app-config.js"></o-app>
    </div>
  </div>
  <script>
    const getAppData = async ({ PATH, configUrl }) => {
      const appUrlObj = new URL(configUrl, PATH);
      const homeAppData = await import(appUrlObj.href);
      const iconUrlObj = new URL(homeAppData.icon, appUrlObj);

      return {
        path: appUrlObj.href,
        name: homeAppData.name,
        iconUrl: iconUrlObj.href,
      };
    };

    export default async ({ load }) => {
      const defaults = {
        homeApp: "/core/apps/finder/app-config.js",
      };

      const apps = ["/core/apps/editor/app-config.js"];

      return {
        tag: "n-os",
        data: {
          // 左侧栏正在使用中的app
          using: [],
          // 当前使用中的 app id
          currentAppPath: "",
          menuActived: false,
        },
        watch: {
          currentAppPath(currentAppPath) {
            const { currentApp } = this;
            if (currentApp) {
              currentApp.remove();
            }

            this.shadow
              .$(".main")
              .push(`<o-app src="${currentAppPath}" desk-app></o-app>`);
          },
        },
        async ready() {
          // 获取主页应用的相关数据
          const homeAppData = await getAppData({
            PATH: this.PATH,
            configUrl: defaults.homeApp,
          });

          this.using.push(homeAppData);
          this.currentAppPath = homeAppData.path;

          apps.forEach(async (e) => {
            const appData = await getAppData({
              PATH: this.PATH,
              configUrl: e,
            });

            this.using.push(appData);
          });
        },
        proto: {
          clickItem(e) {
            let target = $(e.currentTarget);

            target;
          },
          get currentApp() {
            return this.shadow.$("o-app[desk-app]");
          },
        },
        async attached() {
          if (!history.state) {
            history.pushState(
              {
                isBack: true,
              },
              "",
              "#back"
            );

            await new Promise((res) => setTimeout(res, 500));

            history.pushState(
              {
                isCurrent: true,
              },
              "",
              location.pathname
            );

            await new Promise((res) => setTimeout(res, 100));

            // history.pushState(
            //   {
            //     isForward: true,
            //   },
            //   "",
            //   "#forward"
            // );

            // await new Promise((res) => setTimeout(res, 100));

            // history.back();
          }

          window.addEventListener(
            "popstate",
            (this._popstate = (e) => {
              const { state } = e;

              if (state.isBack) {
                // console.log("click back");
                this.currentApp.back();
                history.forward();
              } else if (state.isForward) {
                console.log("click forward");
                history.back();
              }
            })
          );
        },
        detached() {
          window.removeEventListener("popstate", this._popstate);
        },
      };
    };
  </script>
</template>
