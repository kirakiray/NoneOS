<template component>
  <l-m src="@pui/navigation/nav-bar.html"></l-m>
  <l-m src="./comps/os-app-item.html"></l-m>
  <style>
    :host {
      display: block;
      width: 100%;
      height: 100%;
    }
    .container {
      display: flex;
      width: 100%;
      height: 100%;
    }
    .left p-nav-bar {
      height: 100%;
      border-radius: 35px;
    }
    .main {
      flex: 1;
    }
    .main o-app {
      height: 100%;
    }
  </style>
  <div class="container">
    <div class="left">
      <x-fill :value="using">
        <os-app-item
          :name="$data.name"
          :active="$host.currentAppicon === $data.iconUrl ? '' : null"
        >
          <img attr:src="$data.iconUrl" />
        </os-app-item>
      </x-fill>
    </div>
    <div class="main">
      <!-- <o-app src=""></o-app> -->
    </div>
  </div>
  <script>
    const getAppData = async ({ PATH, configUrl }) => {
      const appUrlObj = new URL(configUrl, PATH);
      const homeAppData = await import(appUrlObj.href);
      const iconUrlObj = new URL(homeAppData.icon, appUrlObj);

      return {
        name: homeAppData.name,
        iconUrl: iconUrlObj.href,
      };
    };

    export default async ({ load }) => {
      const defaults = {
        homeApp: "/core/apps/finder/app-config.js",
      };

      const home = "";

      return {
        tag: "n-os",
        data: {
          // 左侧栏正在使用中的app
          using: [],
          // 当前使用中的 app id
          currentAppicon: "",
        },
        async ready() {
          // 获取主页应用的相关数据
          const homeAppData = await getAppData({
            PATH: this.PATH,
            configUrl: defaults.homeApp,
          });

          this.using.push(homeAppData);
          this.currentAppicon = homeAppData.iconUrl;

          this.shadow
            .$(".main")
            .push(`<o-app src="${defaults.homeApp}"></o-app>`);
        },
        proto: {
          get currentApp() {
            return this.shadow.$("o-app");
          },
        },
        async attached() {
          if (!history.state) {
            history.pushState(
              {
                isBack: true,
              },
              "",
              "#back"
            );

            await new Promise((res) => setTimeout(res, 500));

            history.pushState(
              {
                isCurrent: true,
              },
              "",
              location.pathname
            );

            await new Promise((res) => setTimeout(res, 100));

            // history.pushState(
            //   {
            //     isForward: true,
            //   },
            //   "",
            //   "#forward"
            // );

            // await new Promise((res) => setTimeout(res, 100));

            // history.back();
          }

          window.addEventListener(
            "popstate",
            (this._popstate = (e) => {
              const { state } = e;

              if (state.isBack) {
                console.log("click back");
                this.currentApp.back();
                history.forward();
              } else if (state.isForward) {
                console.log("click forward");
                history.back();
              }
            })
          );
        },
        detached() {
          window.removeEventListener("popstate", this._popstate);
        },
      };
    };
  </script>
</template>
